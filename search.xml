<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Kuberentes kube-apiserver限流方案</title>
      <link href="/posts/38758.html"/>
      <url>/posts/38758.html</url>
      
        <content type="html"><![CDATA[<h1 id="Kube-apiserver限流配置说明"><a href="#Kube-apiserver限流配置说明" class="headerlink" title="Kube-apiserver限流配置说明"></a>Kube-apiserver限流配置说明</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>总体来说对Kubernetes apiserver的限流分为以下多种:</p><ul><li>MaxInflightLimit，是server级别的限制</li><li>EventRateLimit, 是控制event事件向apiserver爆发式写入的情况，属于apiserver的一个准入控制器（admission plugin）</li><li>Client断qps限流</li><li>APF(API Priority and Fairness），API优先级和公平性，属于Kubernetes的一个api对象，提供较为详细的控制限流，但是配置较为复杂</li></ul><p>Kubernetes底层实现限速队列使用的是令牌桶算法（Token bucket Algorithm），通过模拟一个可以容纳指定令牌数量的桶，然后以固定的速率向桶中添加令牌，从而实现对数据流的控制。每个请求都需要带上令牌从可以通过到达服务端，假设桶的容量为50，而生成的令牌速率为每秒10个，考虑到以下情况：</p><ul><li>正常情况: 请求低于10个每秒，桶中的令牌会逐渐增多，因为消耗不完，但是总数不会多余50</li><li>流量激增: 如果请求激增至20个每秒，前几秒桶中因为有多余的令牌，请求会保持正常，但是随着时间的推移，最终收到的请求数会变成令牌生成的速率即10个每秒，多余的请求会被限制丢弃</li><li>令牌溢出：当长时间服务端收不到请求，桶中的令牌数满50之后，此时生成速率不变，那生成的多余令牌会被弃置</li></ul><p>对应Kubernetes中具体的参数控制，可以理解为Burst参数表示桶的大小，而QPS表示令牌生成速率，那其实服务端允许1s能通过的最大请求应该就是Burst+QPS，但是不是每一秒都可以达到这个情况（参考上述情况2）</p><h2 id="Kubernetes相关配置"><a href="#Kubernetes相关配置" class="headerlink" title="Kubernetes相关配置"></a>Kubernetes相关配置</h2><h3 id="kube-apiserver启动参数相关"><a href="#kube-apiserver启动参数相关" class="headerlink" title="kube-apiserver启动参数相关"></a>kube-apiserver启动参数相关</h3><p>kube apiserver端启动参数包含以下两个配置：</p><ul><li><p>–max-mutating-requests-inflight int 默认值为: 200 </p><p>该参数表示在给定时间内的最大 mutating 请求数（UPDATE，PATCH，PUT，CREATE请求，修改资源类型的请求），默认值为200，在集群规模较大或者pod业务数量较多时可以向上调整</p></li><li><p>–max-requests-inflight int 默认值为: 400</p><p>该参数表示在给定时间内的非 mutating 请求数（GET, LIST 请求），默认值为400，在集群规模较大或者pod业务数量较多时可以向上调整</p></li></ul><h3 id="EventRateLimit准入控制器相关的"><a href="#EventRateLimit准入控制器相关的" class="headerlink" title="EventRateLimit准入控制器相关的"></a>EventRateLimit准入控制器相关的</h3><p>需要配置kube apiserver以下参数,修改&#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml文件，注意修改配置会导致apiserver重启</p><ul><li><p>–enable-admission-plugins&#x3D;EvenetRateLimit</p><p>启用EvenetRateLimit准入控制器</p></li><li><p>–admission-control-config-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;config.yaml</p><p>启用EvenetRateLimit相关配置</p></li></ul><p>同时需要配置VolumeMount和Volume字段，将配置文件印射到kube-apiserver的pod容器中</p><p>如图所示的配置：具体路径可以自定义</p><p><img src="/image/Kuberentes-apf/everntLimitpng.png" alt="image-20241210141800839"></p><p>以下为 <code>config.yaml</code> </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiserver.config.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AdmissionConfiguration</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EventRateLimit</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/kubernetes/eventconfig.yaml</span> <span class="comment">#容器内的路径</span></span><br></pre></td></tr></table></figure><p>以下为<code>eventconfig.yaml</code> ，其中type总共包含四个选项，相关配置包含了上述提到的qps，burst和cacheSize(其中qps和burst是必要项，cacheSize是可选，是指桶的LRU缓存大小，同时type为server时缓存配置是被忽略的)</p><ul><li><code>Namespace</code> : 配置每个Namespace的限速令牌桶</li><li><code>Server</code>：APIserver端收到的所有关于event的请求的限速令牌桶，包含了修改和查询请求</li><li><code>User</code>: 每个User对应产生的事件生成的限速令牌桶</li><li><code>SourceAndObject</code>: 根据事件的来源和涉及对象的分成各个组合，每个分配桶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">eventratelimit.admission.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Configuration</span></span><br><span class="line"><span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">qps:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">burst:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">cacheSize:</span> <span class="number">2000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">User</span></span><br><span class="line">    <span class="attr">qps:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">burst:</span> <span class="number">50</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Server</span></span><br><span class="line">    <span class="attr">qps:</span> <span class="number">200</span></span><br><span class="line">    <span class="attr">burst:</span> <span class="number">400</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">SourceAndObject</span></span><br><span class="line">    <span class="attr">qps:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">burst:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure><h3 id="Client端限流"><a href="#Client端限流" class="headerlink" title="Client端限流"></a>Client端限流</h3><p>自定义operator可以从client端进行限流，主要包含client-go的限速rateLimiter和workqueue多个不通限速器算法进行限流限速</p><ul><li>client-go端</li></ul><p><img src="/image/Kuberentes-apf/clientgo.png" alt="image-20241210145550550"></p><p><img src="/image/Kuberentes-apf/RateLimiting.png" alt="image-20241210145506786"></p><p>在初始化时，自定义RateLimiter的qps和burst，默认值分别是qps为5，而burst为10，但是controll-runtime侧会传入默认值，分别为默认值20和30</p><h3 id="APF优先级和公平性"><a href="#APF优先级和公平性" class="headerlink" title="APF优先级和公平性"></a>APF优先级和公平性</h3><p>APF的是自1.18版本后正常默认开启的特性，启用该特性后，kube-apiserver端的总并发数量将会是–max-mutating-requests-inflight和</p><p>–max-requests-inflight的总和，修改请求和查询请求不会再彼此区分，而是根据APF中的配置权重进行分配。APF进行配置，会提供以下的优势</p><ul><li>APF以更精细的粒度对请求进行分配和控制</li><li>APF引进了队列机制，在极端的短暂突发情况下，APIServer不会拒绝任意请求，仍可正常工作，负载</li><li>从队列中公平分配请求进行处理，防止极端情况，单个行为异常流量过大的controller影响所有controller</li></ul><p>APF主要的资源对象为两个，分别是<code>FlowSchema</code> 和<code>PriorityLevelConfiguration</code></p><p>系统默认的<code>FlowSchema</code>有如下几个,以global-default举例说明：</p><p><img src="/image/Kuberentes-apf/flowschema.png" alt="image-20241210155133328"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get FlowSchema global-default -o yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">FlowSchema</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">apf.kubernetes.io/autoupdate-spec:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-09-06T02:01:24Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">global-default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;66&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">d7659c18-7f46-405c-92e1-a579b1409b54</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">distinguisherMethod:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ByUser</span></span><br><span class="line">  <span class="attr">matchingPrecedence:</span> <span class="number">9900</span></span><br><span class="line">  <span class="attr">priorityLevelConfiguration:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">global-default</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nonResourceRules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">nonResourceURLs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">resourceRules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">clusterScope:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">namespaces:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">subjects:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">system:unauthenticated</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">system:authenticated</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-09-06T02:01:24Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">This</span> <span class="string">FlowSchema</span> <span class="string">references</span> <span class="string">the</span> <span class="string">PriorityLevelConfiguration</span> <span class="string">object</span> <span class="string">named</span></span><br><span class="line">      <span class="string">&quot;global-default&quot;</span> <span class="string">and</span> <span class="string">it</span> <span class="string">exists</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Found</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Dangling</span></span><br></pre></td></tr></table></figure><p>需要关注的是spec的相关字段：</p><ul><li><p><strong>distinguisherMethod</strong>: (可选)</p><p>该字段定义了如何计算与该模式的匹配的请求流区分符，如果设置为空，表示区分符被禁用  </p><ul><li><p><strong>distinguisherMethod.type</strong>:（如何存在，则必填）</p><p>分为两个选项，ByUser和ByNamespace，分别代表把不同用户的请求分散到不同的流中，不同Namespace的请求分散到不同的流中，如果不设置，则所有请求会分配到同一个流中</p></li></ul></li><li><p><strong>matchingPrecedence</strong>: (必填) </p><p>用于选择与给定请求匹配的一个 FlowSchema。  每个 MatchingPrecedence 值必须在 [1,10000] 的范围内。 值越小优先级越高，      请注意，如果未指定优先顺序，则其默认设为 1000</p></li><li><p><strong>priorityLevelConfiguration</strong>:(必填）</p><p>对应引用集群中的 PriorityLevelConfiguration。 如果引用无法被解析，则会忽略此 FlowSchema，并在其状态中将其标记为无      效。</p><ul><li><p><strong>priorityLevelConfiguration.name</strong> :(必填）</p><p>表示对应具体的PriorityLevelConfiguration的名称</p></li></ul></li><li><p><strong>rules</strong>:(必填)</p><p>rules描述哪些请求将与这个流模式匹配。只有当至少一条规则与请求匹配时， 才视为此 FlowSchema 与该请求匹配。如果字段值    为空表，则 FlowSchema 不会与任何请求匹配，类似于RBAC的规则，针对API进行限制</p><ul><li><p><strong>rules.subjects</strong>:(必填)</p><p>subjects 是此规则相关的普通用户、服务账号或组的列表。在这个列表中必须至少有一个成员。 同时包含 system:authenticated 和 system:unauthenticated 用户组的列表会与每个请求匹配</p><ul><li><p><strong>rules.subjects.kind</strong>:(必填)</p><p>包含三个字段: <strong>User</strong>,<strong>Group</strong>,<strong>ServiceAccount</strong></p></li></ul></li><li><p><strong>rules.nonResourceRules</strong>: (必填)</p><p>NonResourcePolicyRule 是根据请求的动作和目标非资源 URL 来匹配非资源请求的一种规则。 只有满足以下两个条件时，NonResourcePolicyRule 才会匹配一个请求： (a) 至少 verbs 的一个成员与请求匹配且 (b) 至少 nonResourceURLs 的一个成员与请求匹配。</p><ul><li><p><strong>rules.nonResourceRules.nonResourceURLs</strong>: (必填)</p><p>nonResourceURLs是用户有权访问的一组 URL 前缀，不可以为空，类似如下</p><p><img src="/image/Kuberentes-apf/rule.png" alt="image-20241210174920136"></p></li><li><p><strong>rules.nonResourceRules.verbs</strong>:(必填)</p><p>verbs是与动作匹配的列表，不可以为空。<code>*</code> 与所有动作匹配。 如果存在此字符，则必须是唯一的输入项</p></li></ul></li><li><p><strong>rules.resourceRules</strong>: (可选)</p><p>resourceRules 和 nonResourceRules两者必须至少有一个非空,表示了匹配规则，两者的区别就是一个针对资源型的URL吗，一个是针对非资源型的URL</p></li></ul></li></ul><p>PriorityLevelConfiguration配置如下所示:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get PriorityLevelConfiguration workload-low -o yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityLevelConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">apf.kubernetes.io/autoupdate-spec:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-09-06T02:01:24Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workload-low</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;37&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">161b0bf0-1f60-40b5-89e9-83c9e9acfb0f</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limited:</span></span><br><span class="line">    <span class="attr">assuredConcurrencyShares:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">limitResponse:</span></span><br><span class="line">      <span class="attr">queuing:</span></span><br><span class="line">        <span class="attr">handSize:</span> <span class="number">6</span></span><br><span class="line">        <span class="attr">queueLengthLimit:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">queues:</span> <span class="number">128</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Queue</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Limited</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get PriorityLevelConfiguration  exempt -o yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityLevelConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">apf.kubernetes.io/autoupdate-spec:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-09-06T02:01:24Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">exempt</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;65&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">e517f18a-8544-4f97-9c00-7b11c876c82a</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Exempt</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>需要关注的是spec的相关字段：</p><ul><li><p><strong>type</strong>:(必填)</p><p>包含两个可选字段：<strong>Exempt</strong>和<strong>Limited</strong>,<strong>Exempt</strong>意味着此优先级的请求不遵从某个限制（且因此从不排队）且不会减损其他优先级可用的容量。 取值为 <strong>Limited</strong>意味着此优先级的请求遵从这些限制且服务器某些受限的容量仅可用于此优先级</p></li><li><p><strong>exempt</strong>:(当type为Limited时必须为空,当type为Exempt时，可为空，会取ExemptPriorityLevelConfiguration的默认值，1.21,1.25版本无相关字段，1.29后启用)</p><ul><li><p><strong>exempt.lendablePercent</strong>:(可选，1.21,1.25版本无相关字段，1.29后启用)</p><p>规定该级别的 NominalCL 可被其他优先级租借的百分比。 此字段的值必须在 0 到 100 之间，包括 0 和 100，默认为 0。 其他级别可以从该级别借用的席位数被称为此级别的 LendableConcurrencyLimit（LendableCL），定义如下。</p><p>LendableCL(i) &#x3D; round( NominalCL(i) * lendablePercent(i)&#x2F;100.0 )</p></li><li><p><strong>exempt.nominalConcurrencyShares</strong>:(必填，1.21,1.25版本无相关字段，1.29后启用，具体计算方式参考下文Limited中的assuredConcurrencyShares字段)</p><p>（NCS）也被用来计算该级别的 NominalConcurrencyLimit（NominalCL）。 字段值是为该优先级保留的执行席位的数量。这一设置不限制此优先级别的调度行为， 但会通过借用机制影响其他优先级。服务器的并发限制（ServerCL）会按照各个优先级的 NCS 值按比例分配：</p><p>NominalCL(i) &#x3D; ceil( ServerCL * NCS(i) &#x2F; sum_ncs ) sum_ncs &#x3D; sum[priority level k] NCS(k)</p></li></ul></li><li><p><strong>Limited</strong>:(当且仅当 type 是Limited时，此字段必须为非空)</p><p>Limited 指定如何为某个受限的优先级处理请求</p><ul><li><p><strong>limited.assuredConcurrencyShares</strong>:(必填,1.29后版本此字段删除，更替为<strong>nominalConcurrencyShares</strong>)</p><p>字段值是为该优先级保留的执行席位的数量。这一设置不限制此优先级别的调度行为， 但会通过借用机制影响其他优先级。服务器的并发限制（ServerCL）会按照各个优先级的 ACS 值按比例分配：</p><p>AssuredCL(i) &#x3D; ceil( ServerCL * NCS(i) &#x2F; sum_acs ) sum_acs &#x3D; sum[priority level k] ACS(k)</p><p><img src="/image/Kuberentes-apf/ACS.png" alt="image-20241210201251886"></p><p>catch-all这个PriorityLevelConfiguration的优先级计算请求限制: 累加所有的assuredConcurrencyShares&#x3D;5+20+10+30+40+100&#x3D;205, 根据公式可得 （max-mutating-requests-inflight+max-requests-inflight）&#x3D;200+400&#x3D;600，ceil(600&#x2F;205)*5&#x3D;15,所以根据限制可计算出每秒放行15个请求</p></li><li><p><strong>limited.lendablePercent</strong> :(1.21,1.25版本无相关字段，1.29后启用，可选)</p><p>规定了 NominalCL 可被其他优先级租借资源数百分比。 此字段的值必须在 0 到 100 之间，包括 0 和 100，默认为 0。 其他级别可以从该级别借用的资源数被称为此级别的 LendableConcurrencyLimit（LendableCL），定义如下。</p><p>LendableCL(i) &#x3D; round( NominalCL(i) * lendablePercent(i)&#x2F;100.0 )</p></li><li><p><strong>limited.lendablePercent</strong>:(1.21,1.25版本无相关字段，1.29后启用，可选)</p><p>配置如果存在，则可用来限制此优先级可以从其他优先级中租借多少资源。 该限制被称为该级别的 BorrowingConcurrencyLimit（BorrowingCL），它限制了该级别可以同时租借的资源总数。 该字段保存了该限制与该级别标称并发限制之比。当此字段非空时，必须为正整数，并按以下方式计算限制值：</p><p>BorrowingCL(i) &#x3D; round(NominalCL(i) * borrowingLimitPercent(i) &#x2F; 100.0)</p><p>该字段值可以大于100，表示该优先级可以大于自己标称并发限制（NominalCL）。当此字段为 <code>nil</code> 时，表示无限制。</p></li><li><p><strong>limited.limitResponse</strong> :(必填)</p><p>该字段表示如何处理当前无法立即执行的请求</p><ul><li><p><strong>limited.limitResponse.type</strong> :(必填)</p><p>该字段包含两种情况，<strong>Queue</strong>或 <strong>Reject</strong>。此字段必须设置。 <strong>Queue</strong>意味着在到达时无法被执行的请求可以被放到队列中，直到它们被执行或者队列长度超出限制为止。 <strong>Reject</strong>意味着到达时无法执行的请求将被拒绝。</p></li><li><p><strong>limited.limitResponse.queuing</strong> :(必填）</p><p>queuing 包含排队所用的配置参数。只有 type是 Queue 时，此字段才可以为非空</p><ul><li><p><strong>limited.limitResponse.queuing.handSize</strong> :(必填)</p><p>handSize 是一个小的正数，用于配置如何将请求随机分片到队列中。 当以该优先级将请求排队时，将对请求的流标识符（字符串对）进行哈希计算， 该哈希值用于打乱队列队列的列表，并处理此处指定的一批请求。 请求被放入这一批次中最短的队列中。 handSize 不得大于 queues，并且应该明显更小（以便几个大的流量不会使大多数队列饱和）。默认值为8</p></li><li><p><strong>limited.limitResponse.queuing.queueLengthLimit</strong> :(必填)</p><p>是任意时刻允许在此优先级的给定队列中等待的请求数上限； 额外的请求将被拒绝。 此值必须是正数。如果未指定，则默认为 50</p></li><li><p><strong>limited.limitResponse.queuing.queues</strong>:(必填)</p><p>该字段表示是这个优先级的队列数。此队列在每个 API 服务器上独立存在。此值必须是正数。 将其设置为 1 相当于禁止了混洗分片操作，进而使得对相关流模式的区分方法不再有意义。 此字段的默认值为 64。</p></li></ul></li></ul></li></ul><p>关于以上的三个参数有如下的资源情况:</p><pre><code>        1. queues拥有更多队列会有效减少流之间的互相干扰，但增加了kube-apiserver的内存使用量，设置为1即为禁用        1. queueLengthLimit越大，就可以应对更大突发流量，但是同样会增加了kube-apiserver的内存使用量        1. handSize调高，可以减少多个流之间的互相干扰以及高负载情况下，当个流的可用性，因为对于多个请求而言，会提高相对应的并发</code></pre></li></ul><h3 id="示例demo"><a href="#示例demo" class="headerlink" title="示例demo"></a>示例demo</h3><p>以1.21的k8s为例创建以下配置</p><p>flowSchema.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">FlowSchema</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">calico-pods</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">distinguisherMethod:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ByUser</span></span><br><span class="line">  <span class="attr">matchingPrecedence:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">priorityLevelConfiguration:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">calico-pods</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">resourceRules:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;crd.projectcalico.org&quot;</span></span><br><span class="line">          <span class="attr">clusterScope:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">namespaces:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">          <span class="attr">verbs:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;list&quot;</span></span><br><span class="line">      <span class="attr">subjects:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">          <span class="attr">serviceAccount:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">calico-node</span></span><br><span class="line">            <span class="attr">namespace:</span> <span class="string">kube-system</span> </span><br></pre></td></tr></table></figure><p>priorityLevelConfiguration.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityLevelConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">calico-pods</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Limited</span></span><br><span class="line">  <span class="attr">limited:</span></span><br><span class="line">    <span class="attr">assuredConcurrencyShares:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">limitResponse:</span></span><br><span class="line">      <span class="attr">queuing:</span></span><br><span class="line">        <span class="attr">handSize:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">queueLengthLimit:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">queues:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Queue</span></span><br></pre></td></tr></table></figure><p>测试如图所示，使用如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TOKEN=$(kubectl -n kube-system get secrets calico-node-token-sdz5q -o json | jq -r .data.token | <span class="built_in">base64</span> -d)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl https://127.0.0.1:6443/apis/crd.projectcalico.org/v1/caliconodestatuses?<span class="built_in">limit</span>=500  -X GET --header <span class="string">&quot;Authorization: Bearer <span class="variable">$TOKEN</span>&quot;</span> -k -I; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">kubectl get --raw /debug/api_priority_and_fairness/dump_priority_levels</span><br></pre></td></tr></table></figure><p><img src="/image/Kuberentes-apf/curl.png" alt="image-20241210214709135"></p><p><img src="/image/Kuberentes-apf/debug.png" alt="image-20241210214824900"></p><h3 id="debug相关命令"><a href="#debug相关命令" class="headerlink" title="debug相关命令"></a>debug相关命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取所有优先级及其当前状态的列表</span></span><br><span class="line">kubectl get --raw /debug/api_priority_and_fairness/dump_priority_levels</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取所有队列及其当前状态的列表</span></span><br><span class="line">kubectl get --raw /debug/api_priority_and_fairness/dump_queues</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取当前正在队列中等待的所有请求的列表</span></span><br><span class="line">kubectl get --raw /debug/api_priority_and_fairness/dump_requests</span><br></pre></td></tr></table></figure><h3 id="Prometheus也有相关指标"><a href="#Prometheus也有相关指标" class="headerlink" title="Prometheus也有相关指标"></a>Prometheus也有相关指标</h3><p><strong>apiserver_flowcontrol_rejected_requests_total</strong>: 记录被拒绝的请求数量（自服务器启动以来累计值）</p><p><strong>apiserver_flowcontrol_dispatched_requests_total</strong>:记录开始执行的请求数量（自服务器启动以来的累积值）</p><p><strong>apiserver_current_inqueue_requests</strong> :记录最近排队请求数量的高水位线</p><p>等多个相关指标，具体可以查看apiserver相关的metrics</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GOLANG GMP 原理与调度</title>
      <link href="/posts/19508.html"/>
      <url>/posts/19508.html</url>
      
        <content type="html"><![CDATA[<h1 id="GMP-原理与调度"><a href="#GMP-原理与调度" class="headerlink" title="GMP 原理与调度"></a>GMP 原理与调度</h1><h2 id="Golang调度器"><a href="#Golang调度器" class="headerlink" title="Golang调度器"></a>Golang调度器</h2><h3 id="1-单进程不需要调度器"><a href="#1-单进程不需要调度器" class="headerlink" title="1. 单进程不需要调度器"></a>1. 单进程不需要调度器</h3><p><img src="https://github.com/JING21/GO/raw/main/GMP/single-process.png" alt="image-20220124101427219"></p><p>在早期的操作系统中，每个程序对应一个进程，而cpu执行计算任务的时候，都是单进程，一个进程执行完了</p><p>才能执行下一个进程，所有都是串行进行的，这样就会有以下的两个问题</p><ul><li>单一的执行流程，计算机只能一个任务一个任务处理</li><li>进程阻塞所带来的 CPU 时间浪费</li></ul><p>后来操作系统就具有了<strong>最早的并发能力：多进程并发</strong>，当一个进程阻塞的时候，切换到另外等待执行的进程，这样就能尽量把 CPU 利用起来，不浪费CPU资源</p><h3 id="2-多进程-线程需要调度器"><a href="#2-多进程-线程需要调度器" class="headerlink" title="2.多进程&#x2F;线程需要调度器"></a>2.多进程&#x2F;线程需要调度器</h3><p><img src="https://github.com/JING21/GO/raw/main/GMP/%E5%A4%9A%E8%BF%9B%E7%A8%8B.png" alt="多进程"></p><p>在多进程 &#x2F; 多线程的操作系统中，就解决了阻塞的问题，因为一个进程阻塞 cpu 可以立刻切换到其他进程中去执行，而且调度 cpu 的算法可以保证在运行的进程都可以被分配到 cpu 的运行时间片。这样从宏观来看，似乎多个进程是在同时被运行。<br>但新的问题就又出现了，进程拥有太多的资源，进程的创建、切换、销毁，都会占用很长的时间，CPU 虽然利用起来了，但如果进程过多，CPU 有很大的一部分都被用来进行进程调度了。</p><p>很明显，CPU 调度切换的是进程和线程。尽管线程看起来很美好，但实际上多线程开发设计会变得更加复杂，要考虑很多同步竞争等问题，如锁、竞争冲突等。</p><p>多进程、多线程已经提高了系统的并发能力，但是在当今互联网高并发场景下，为每个任务都创建一个线程是不现实的，因为会消耗大量的内存 (进程虚拟内存会占用 4GB [32 位操作系统], 而线程也要大约 4MB)。<br>大量的进程 &#x2F; 线程出现了新的问题</p><ul><li>高内存占用</li><li>调度的高消耗 CPU</li></ul><p><img src="https://github.com/JING21/GO/raw/main/GMP/coroutine&thread.png" alt="image-20220325165240009"></p><p>一个线程分为 “内核态 “线程和” 用户态 “线程。一个 “用户态线程” 必须要绑定一个 “内核态线程”，但是 CPU 并不知道有 “用户态线程” 的存在，它只知道它运行的是一个 “内核态线程”(Linux 的 PCB 进程控制块)。内核线程依然叫 “线程 (thread)”，用户线程叫 “协程 (co-routine)”。</p><p>协程和线程有三种对应关系，分别是1:1,N:1和N:N</p><p>N:1 关系<br>N 个协程绑定 1 个线程，优点就是<strong>协程在用户态线程即完成切换，不会陷入到内核态，这种切换非常的轻量快速</strong>。但也有很大的缺点，1 个进程的所有协程都绑定在 1 个线程上<br>缺点：</p><ul><li>某个程序用不了硬件的多核加速能力</li><li>一旦某协程阻塞，造成线程阻塞，本进程的其他协程都无法执行了，根本就没有并发的能力了。</li></ul><p><img src="https://github.com/JING21/GO/raw/main/GMP/N1model.png" alt="image-20220408094430548"></p><p>1:1 关系<br>1 个协程绑定 1 个线程，这种最容易实现。协程的调度都由 CPU 完成了，不存在 N:1 缺点，<br>缺点：</p><ul><li>协程的创建、删除和切换的代价都由 CPU 完成，有点略显昂贵了。</li></ul><p><img src="https://github.com/JING21/GO/raw/main/GMP/11Model.png" alt="image-20220408094407894"></p><p>M:N 关系<br>M 个协程绑定 1 个线程，是 N:1 和 1:1 类型的结合。</p><p> 协程跟线程是有区别的，线程由 CPU 调度是抢占式的，<strong>协程由用户态调度是协作式的</strong>，一个协程让出 CPU 后，才执行下一个协程。</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/MNmodel.png" alt="image-20220408094223883"></p><h2 id="3-GO语言的协程goroutine"><a href="#3-GO语言的协程goroutine" class="headerlink" title="3.GO语言的协程goroutine"></a>3.GO语言的协程goroutine</h2><p><strong>Go 为了提供更容易使用的并发方法，使用了 goroutine 和 channel</strong>。goroutine 来自协程的概念，让一组可复用的函数运行在一组线程之上，即使有协程阻塞，该线程的其他协程也可以被 <code>runtime</code> 调度，转移到其他可运行的线程上</p><p>在GO语言中，对应的用户线程（协程）被称为goroutine，是个非常轻量级的设计，一个goroutine只占几个KB，并且运行为一个goroutine也只需要几KB。这样从内存的角度而言，可以支持大量的并发。并且虽然goroutine的栈只占几KB，实际上它可以伸缩。如果在有需要的情况下，runtime会自动为goroutine分配资源<br>Goroutine 特点：</p><ul><li>占用内存更小（几 kb）</li><li>调度更灵活 (runtime 调度)</li></ul><h3 id="原先的GM模型"><a href="#原先的GM模型" class="headerlink" title="原先的GM模型"></a>原先的GM模型</h3><p><img src="https://github.com/JING21/GO/raw/main/GMP/GMmodel.png" alt="image-20220408110753527"></p><p> G 来表示 Goroutine，用 M 来表示线程</p><p>M 想要执行、放回 G 都必须访问全局 G 队列，并且 M 有多个，即多线程访问同一资源需要加锁进行保证互斥 &#x2F; 同步，所以全局 G 队列是有互斥锁进行保护的。<br>老调度器有几个缺点：</p><ol><li>创建、销毁、调度 G 都需要每个 M 获取锁，这就形成了<strong>激烈的锁竞争</strong>。</li><li>M 转移 G 会造成<strong>延迟和额外的系统负载</strong>。比如当 G 中包含创建新协程的时候，M 创建了 G’，为了继续执行 G，需要把 G’交给 M’执行，也造成了<strong>很差的局部性</strong>，因为 G’和 G 是相关的，最好放在 M 上执行，而不是其他 M’。</li><li>系统调用 (CPU 在 M 之间的切换) 导致频繁的线程阻塞和取消阻塞操作增加了系统开销。</li></ol><h3 id="GMP模型"><a href="#GMP模型" class="headerlink" title="GMP模型"></a>GMP模型</h3><p><img src="https://github.com/JING21/GO/raw/main/GMP/GMP.png" alt="image-20220408151755837"></p><ol><li><strong>全局队列</strong>（Global Queue）：存放等待运行的 G。</li><li><strong>P 的本地队列</strong>：同全局队列类似，存放的也是等待运行的 G，存的数量有限，不超过 256 个。新建 G’时，G’优先加入到 P 的本地队列，如果队列满了，则会把本地队列中一半的 G 移动到全局队列。</li><li><strong>P 列表</strong>：所有的 P 都在程序启动时创建，并保存在数组中，最多有 <code>GOMAXPROCS</code>(可配置) 个。</li><li><strong>M</strong>：线程想运行任务就得获取 P，从 P 的本地队列获取 G，P 队列为空时，M 也会尝试从全局队列<strong>拿</strong>一批 G 放到 P 的本地队列，或从其他 P 的本地队列<strong>拿</strong>一半放到自己 P 的本地队列。M 运行 G，G 执行之后，M 会从 P 获取下一个 G，不断重复下去。</li></ol><p><strong>Goroutine 调度器和 OS 调度器是通过 M 结合起来的，每个 M 都代表了 1 个内核线程，OS 调度器负责把内核线程分配到 CPU 的核上执行</strong>。<br>有关 P 和 M 的个数问题<br>1、P 的数量：</p><ul><li>由启动时环境变量 <code>$GOMAXPROCS</code> 或者是由 <code>runtime</code> 的方法 <code>GOMAXPROCS()</code> 决定。这意味着在程序执行的任意时刻都只有 <code>$GOMAXPROCS</code> 个 goroutine 在同时运行。</li></ul><p>2、M 的数量:</p><ul><li>go 语言本身的限制：go 程序启动时，会设置 M 的最大数量，默认 10000. 但是内核很难支持这么多的线程数，所以这个限制可以忽略。</li><li>runtime&#x2F;debug 中的 SetMaxThreads 函数，设置 M 的最大数量</li><li>一个 M 阻塞了，会创建新的 M。</li></ul><p>M 与 P 的数量没有绝对关系，一个 M 阻塞，P 就会去创建或者切换另一个 M，所以，即使 P 的默认数量是 1，也有可能会创建很多个 M 出来。<br>P 和 M 何时会被创建<br>1、P 何时创建：在确定了 P 的最大数量 n 后，运行时系统会根据这个数量创建 n 个 P。<br>2、M 何时创建：没有足够的 M 来关联 P 并运行其中的可运行的 G。比如所有的 M 此时都阻塞住了，而 P 中还有很多就绪任务，就会去寻找空闲的 M，而没有空闲的，就会去创建新的 M。<br>(2) 调度器的设计策略<br><strong>复用线程</strong>：避免频繁的创建、销毁线程，而是对线程的复用。<br>1）work stealing 机制<br>​ 当本线程无可运行的 G 时，尝试从其他线程绑定的 P 偷取 G，而不是销毁线程。<br>2）hand off 机制<br>​ 当本线程因为 G 进行系统调用阻塞时，线程释放绑定的 P，把 P 转移给其他空闲的线程执行。<br><strong>利用并行</strong>：<code>GOMAXPROCS</code> 设置 P 的数量，最多有 <code>GOMAXPROCS</code> 个线程分布在多个 CPU 上同时运行。<code>GOMAXPROCS</code> 也限制了并发的程度，比如 <code>GOMAXPROCS = 核数/2</code>，则最多利用了一半的 CPU 核进行并行。<br><strong>抢占</strong>：在 coroutine 中要等待一个协程主动让出 CPU 才执行下一个协程，在 Go 中，一个 goroutine 最多占用 CPU 10ms，防止其他 goroutine 被饿死，这就是 goroutine 不同于 coroutine 的一个地方。<br><strong>全局 G 队列</strong>：在新的调度器中依然有全局 G 队列，但功能已经被弱化了，当 M 执行 work stealing 从其他 P 偷不到 G 时，它可以从全局 G 队列获取 G。</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/gofunction.png" alt="image-20220411111312426">go func()启动一个goroutine，即生成一个G</p><ol><li>go func()启动一个goroutine，即生成一个G</li><li>G进入队列，如果P的局部队列满了，则进入全局队列</li><li>M获取到G，并且和P绑定，M和P的关系是1对1，如果M1的本地队列为空，则优先从全局队列获取G，否则就从其他的MP队列中获取G</li><li>M1通过操作系统的调度器和物理CPU进行绑定</li><li>执行G的func()，若func()发生阻塞或者systemCall，则该个M会阻塞，如果当前有一些 G 在执行，runtime 会把这个线程 M 从 P 中摘除 (detach)，则会创建一个新的M（操作系统线程），或者从休眠队列取一个M，用来服务绑定于该个P</li></ol><h3 id="特殊的G和M"><a href="#特殊的G和M" class="headerlink" title="特殊的G和M"></a>特殊的G和M</h3><p><strong>M0</strong><br><code>M0</code> 是启动程序后的编号为 0 的主线程，这个 M 对应的实例会在全局变量 runtime.m0 中，不需要在 heap 上分配，M0 负责执行初始化操作和启动第一个 G， 在之后 M0 就和其他的 M 一样了。<br><strong>G0</strong><br><code>G0</code> 是每次启动一个 M 都会第一个创建的 gourtine，G0 仅用于负责调度的 G，G0 不指向任何可执行的函数，每个 M 都会有一个自己的 G0。在调度或系统调用时会使用 G0 的栈空间，全局变量的 G0 是 M0 的 G0。</p><h3 id="调度器场景"><a href="#调度器场景" class="headerlink" title="调度器场景"></a>调度器场景</h3><ul><li><p>场景 1<br>P 拥有 G1，M1 获取 P 后开始运行 G1，G1 使用 <code>go func()</code> 创建了 G2，为了局部性 G2 优先加入到 P1 的本地队列。</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph1.png" alt="image-20220411154502820"></p></li><li><p>场景 2<br>G1 运行完成后 (函数：<code>goexit</code>)，M 上运行的 goroutine 切换为 G0，G0 负责调度时协程的切换（函数：<code>schedule</code>）。从 P 的本地队列取 G2，从 G0 切换到 G2，并开始运行 G2 (函数：<code>execute</code>)。实现了线程 M1 的复用。</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph2.png" alt="image-20220411160452325"></p></li><li><p>场景 3和4<br>假设每个 P 的本地队列只能存 3 个 G。G2 要创建了 6 个 G，前 3 个 G（G3, G4, G5）已经加入 p1 的本地队列，p1 本地队列满了。</p><p>G2 在创建 G7 的时候，发现 P1 的本地队列已满，需要执行<strong>负载均衡</strong> (把 P1 中本地队列中前一半的 G，还有新创建 G <strong>转移</strong>到全局队列)<br>（实现中并不一定是新的 G，如果 G 是 G2 之后就执行的，会被保存在本地队列，利用某个老的 G 替换新 G 加入全局队列</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph34.png" alt="image-20220411173952310"></p></li><li><p>场景5</p><p>G2 创建 G7 时，P1 的本地队列未满，所以 G7 会被加入到 P1 的本地队列</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph5.png" alt="image-20220412100050605"></p></li><li><p>场景6</p><p>在创建 G 时，运行的 G 会尝试唤醒其他空闲的 P 和 M 组合去执行，假定 G2 唤醒了 M2，M2 绑定了 P2，并运行 G0，但 P2 本地队列没有 G，M2 此时为自旋线程<strong>（没有 G 但为运行状态的线程，不断寻找 G）</strong>。</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph6.png" alt="image-20220412102716761"></p></li><li><p>场景7</p><p>M2 尝试从全局队列 (简称 “GQ”) 取一批 G 放到 P2 的本地队列（函数：<code>findrunnable()</code>）。M2 从全局队列取的 G 数量符合下面的公式：<br>n &#x3D; min(len(GQ)&#x2F;GOMAXPROCS + 1, len(GQ&#x2F;2))<br>至少从全局队列取 1 个 g，但每次不要从全局队列移动太多的 g 到 p 本地队列，给其他 p 留点。这是<strong>从全局队列到 P 本地队列的负载均衡</strong>。</p><p>假定我们场景中一共有 4 个 P（GOMAXPROCS 设置为 4，那么我们允许最多就能用 4 个 P 来供 M 使用）。所以 M2 只从能从全局队列取 1 个 G（即 G3）移动 P2 本地队列，然后完成从 G0 到 G3 的切换，运行 G3。</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/p7.png" alt="p7"></p></li><li><p>场景8</p><ul><li><p>假设 G2 一直在 M1 上运行，经过 2 轮后，M2 已经把 G3、G5 从全局队列获取到了 P2 的本地队列并完成运行，全局队列和 P2 的本地队列都空了，如场景 8 图的左半部分。</p><p><strong>全局队列已经没有 G，那 m 就要执行 work stealing (偷取)：从其他有 G 的 P 哪里偷取一半 G 过来，放到自己的 P 本地队列</strong>。P2 从 P1 的本地队列尾部取一半的 G，本例中一半则只有 1 个 G7，放到 P2 的本地队列并执行。</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph8.png" alt="image-20220412105923959"></p></li></ul></li><li><p>场景9</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph9.png" alt="image-20220412142426339"></p><p>当前 M1 和 M2 分别在运行 G2 和 G8，M3 和 M4 没有 goroutine 可以运行，M3 和 M4 处于<strong>自旋状态</strong>，它们不断寻找 goroutine</p><p>自旋本质是在运行，线程在运行却没有执行 G，就变成了浪费 CPU. 为什么不销毁现场，来节约 CPU 资源。因为创建和销毁 CPU 也会浪费时间，我们<strong>希望当有新 goroutine 创建时，立刻能有 M 运行它</strong>，如果销毁再新建就增加了时延，降低了效率。当然也考虑了过多的自旋线程是浪费 CPU，所以系统中最多有 <code>GOMAXPROCS</code> 个自旋的线程 (当前例子中的 <code>GOMAXPROCS</code>&#x3D;4，所以一共 4 个 P)，多余的没事做线程会让他们休眠。</p></li><li><p>场景10</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph10.png" alt="ph10"></p><p>假定当前除了 M3 和 M4 为自旋线程，还有 M5 和 M6 为休眠的线程 (没有得到 P 的绑定，最多就只能够存在 4 个 P，所以 P 的数量应该永远是 M&gt;&#x3D;P, 大部分都是 M 在抢占需要运行的 P)，G8 创建了 G9，G8 进行了<strong>阻塞的系统调用</strong>，M2 和 P2 立即解绑，P2 会执行以下判断：如果 P2 本地队列有 G、全局队列有 G 或有空闲的 M，P2 都会立马唤醒 1 个 M 和它绑定，否则 P2 则会加入到空闲 P 列表，等待 M 来获取可用的 p。本场景中，P2 本地队列有 G9，可以和其他空闲的线程 M5 绑定。</p></li><li><p>场景11</p><p><img src="https://github.com/JING21/GO/raw/main/GMP/ph11.png" alt="image-20220413103910496"></p></li></ul><p>G8 创建了 G9，假如 G8 进行了<strong>非阻塞系统调用</strong>。 M2 和 P2 会解绑，但 M2 会记住 P2，然后 G8 和 M2 进入<strong>系统调用</strong>状态。当 G8 和 M2 退出系统调用时，会尝试获取 P2，如果无法获取，则获取空闲的 P，如果依然没有，G8 会被记为可运行状态，并加入到全局队列，M2 因为没有 P 的绑定而变成休眠状态 (长时间休眠等待 GC 回收销毁)。</p>]]></content>
      
      
      <categories>
          
          <category> GOLANG </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GOLANG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubelet CPU管理</title>
      <link href="/posts/2592.html"/>
      <url>/posts/2592.html</url>
      
        <content type="html"><![CDATA[<h1 id="Kubelet-cpu绑核功能"><a href="#Kubelet-cpu绑核功能" class="headerlink" title="Kubelet cpu绑核功能"></a>Kubelet cpu绑核功能</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>openstack容器化组件容器化过程中，需要在部署组件的节点预留cpu给系统组件使用，保证容器不使用预留cpu。相关场景的问题是：reserved-cpu保留后，仅对Guaranteed类型的pod有效，同时cpu相关qos必须为整型参数。</p><p>具体的需求如下：</p><ol><li>所有服务 yaml 文件无需修改（既不需要增加 resources：limits(memory+cpu) + requests(memory+cpu) 配置）</li><li>同节点上所有 Pod 共用配置的 reserved-cpus 之外的核池。</li></ol><h2 id="Kubernetes相关参数功能"><a href="#Kubernetes相关参数功能" class="headerlink" title="Kubernetes相关参数功能"></a>Kubernetes相关参数功能</h2><h3 id="pod类型"><a href="#pod类型" class="headerlink" title="pod类型"></a>pod类型</h3><p>Kubernetes中的pod拥有三种QoS类型，分别是：Guaranteed，Burstable，BestEffort</p><ul><li>Guaranteed类型：</li></ul><p>​要求pod中声明了Resources的limit和requests类型，同时还要求两者的值必须相等</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></table></figure><ul><li>Burstable类型：</li></ul><p>​要求pod中声明了Resources的limit和requests类型，但是request可以小于limit，或者cpu和内存资源仅声明其中之一，就会是   Burstable类型的Qos</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span>    </span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></table></figure><ul><li>BestEffort类型</li></ul><p>​ pod的声明中未申请Resources对应的具体的limit和requests类型，就会定义Qos类型为BestEffort</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></table></figure><ul><li><p>Best-Effort 类型的pods：系统用完了全部内存时，该类型pods会最先被kill掉。</p></li><li><p>Burstable类型pods：系统用完了全部内存，且没有Best-Effort container可以被kill时，该类型pods会被kill掉。</p></li><li><p>Guaranteed pods：系统用完了全部内存、且没有Burstable与Best-Effort container可以被kill，该类型的pods会被kill掉。</p><p>如果pod进程因使用超过预先设定的<em>limites</em>而非Node资源紧张情况，系统倾向于在其原所在的机器上重启该container或本机或其他重新创建一个pod。</p></li></ul><h3 id="kubelet相关参数"><a href="#kubelet相关参数" class="headerlink" title="kubelet相关参数"></a>kubelet相关参数</h3><p>Kubernetes中kubelet负责容器的生命周期管理。同时提供了具体参数，–reserved-cpus，–system-reserved，–kube-reserved,(其中reserved-cpus优先级高于system-reserved和kube-reserved，会进行覆盖)对节点资源进行预留。</p><p>cpu-manager作为kubelet的containerManager的一种，负责容器的cpu资源的管理，其中kubelet可以指定参数–cpuManagerPolicy,当前支持2种cpu策略。分别是1.none和2.static</p><ul><li>none类型</li></ul><p>​Kubernetes使用默认的cpu亲和性方案，通过Linux的CFS调度器来管理Guaranteed pods的 CPU 使用以及限制。所谓的CFS（Completely Fair Scheduler），就如字面意思所述，完全公平调度。实际意义即为在一个特定的调度周期内，保证所有的调度的进程都可以被执行，每个进程的vruntime（并不是进程的实际占用cpu时间，是剔除了权重影响的cpu使用时间，而实际的cpu使用时间是会根据进程的优先级权重进行扩缩的）的计算公式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进程运行时间 = 调度周期 * 进程权重 / 所有进程权重之和</span><br><span class="line"></span><br><span class="line">vruntime = 进程运行时间 * NICE_0_LOAD / 进程权重 = (调度周期 * 进程权重 / 所有进程总权重) * NICE_0_LOAD / 进程权重 = 调度周期 * NICE_0_LOAD / 所有进程总权重 </span><br></pre></td></tr></table></figure><p>其中以下的内核参数是CFS调度有关的</p><ul><li>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sched_min_granularity_ns，表示进程最少运行时间，防止进程随意的切换</li><li>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sched_nr_migrate，表示多CPU情况下进行负载均衡时，一次最多移动多少个进程到另一个CPU上</li><li>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sched_wakeup_granularity_ns，表示进程被唤醒后至少应该运行的时间，这个数值越小，那么发生抢占的概率也就越高</li><li>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sched_latency_ns，表示一个运行队列所有进程运行一次的时间长度(正常情况下的队列调度周期，P)</li><li>sched_nr_latency，这个参数是内核内部参数，无法直接设置，是通过sched_latency_ns&#x2F;sched_min_granularity_ns这个公式计算出来的；在实际运行中，如果队列排队进程数 nr_running &gt; sched_nr_latency，则调度周期就不是sched_latency_ns，而是P &#x3D; sched_min_granularity_ns * nr_running，如果 nr_running &lt;&#x3D; sched_nr_latency，则 P &#x3D; sched_latency_ns</li></ul><p>目前环境的参数如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_min_granularity_ns</span></span><br><span class="line">10000000</span><br><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_nr_migrate</span></span><br><span class="line">32</span><br><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_wakeup_granularity_ns</span></span><br><span class="line">15000000</span><br><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_latency_ns</span></span><br><span class="line">24000000</span><br></pre></td></tr></table></figure><p>其中可以算出sched_nr_latency &#x3D; sched_latency_ns&#x2F;sched_min_granularity_ns &#x3D; 24000000&#x2F;10000000 &#x3D; 2.4，表示当进程队列中有2.4个在等待时，开始保证每个进程至少运行10000000ns（即10ms）</p><p>观察对应的进程cpu使用情况，其中se.sum_exec_runtime是实际占用cpu的时间:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /proc/6/sched</span></span><br><span class="line">sh (6, <span class="comment">#threads: 1)</span></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">se.exec_start                                :     257239294.640742</span><br><span class="line">se.vruntime                                  :            17.932870</span><br><span class="line">se.sum_exec_runtime                          :            25.294106</span><br><span class="line">se.nr_migrations                             :                   16</span><br><span class="line">nr_switches                                  :                  107</span><br><span class="line">nr_voluntary_switches                        :                  107</span><br><span class="line">nr_involuntary_switches                      :                    0</span><br><span class="line">se.load.weight                               :              1048576</span><br><span class="line">se.runnable_weight                           :              1048576</span><br><span class="line">se.avg.load_sum                              :                  214</span><br><span class="line">se.avg.runnable_load_sum                     :                  214</span><br><span class="line">se.avg.util_sum                              :               219136</span><br><span class="line">se.avg.load_avg                              :                    0</span><br><span class="line">se.avg.runnable_load_avg                     :                    0</span><br><span class="line">se.avg.util_avg                              :                    0</span><br><span class="line">se.avg.last_update_time                      :      257239294640128</span><br><span class="line">se.avg.util_est.ewma                         :                    8</span><br><span class="line">se.avg.util_est.enqueued                     :                    0</span><br><span class="line">policy                                       :                    0</span><br><span class="line">prio                                         :                  120</span><br><span class="line">clock-delta                                  :                   47</span><br><span class="line">mm-&gt;numa_scan_seq                            :                    0</span><br><span class="line">numa_pages_migrated                          :                    0</span><br><span class="line">numa_preferred_nid                           :                   -1</span><br><span class="line">total_numa_faults                            :                    0</span><br><span class="line">current_node=0, numa_group_id=0</span><br><span class="line">numa_faults node=0 task_private=0 task_shared=0 group_private=0 group_shared=0</span><br><span class="line">/ <span class="comment"># cat /proc/6/sched</span></span><br><span class="line">sh (6, <span class="comment">#threads: 1)</span></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">se.exec_start                                :     257514956.566420</span><br><span class="line">se.vruntime                                  :             4.333984</span><br><span class="line">se.sum_exec_runtime                          :            25.608097</span><br><span class="line">se.nr_migrations                             :                   17</span><br><span class="line">nr_switches                                  :                  110</span><br><span class="line">nr_voluntary_switches                        :                  110</span><br><span class="line">nr_involuntary_switches                      :                    0</span><br><span class="line">se.load.weight                               :              1048576</span><br><span class="line">se.runnable_weight                           :              1048576</span><br><span class="line">se.avg.load_sum                              :                  183</span><br><span class="line">se.avg.runnable_load_sum                     :                  183</span><br><span class="line">se.avg.util_sum                              :               187416</span><br><span class="line">se.avg.load_avg                              :                    3</span><br><span class="line">se.avg.runnable_load_avg                     :                    3</span><br><span class="line">se.avg.util_avg                              :                    3</span><br><span class="line">se.avg.last_update_time                      :      257514956565504</span><br><span class="line">se.avg.util_est.ewma                         :                    8</span><br><span class="line">se.avg.util_est.enqueued                     :                    0</span><br><span class="line">policy                                       :                    0</span><br><span class="line">prio                                         :                  120</span><br><span class="line">clock-delta                                  :                   50</span><br><span class="line">mm-&gt;numa_scan_seq                            :                    0</span><br><span class="line">numa_pages_migrated                          :                    0</span><br><span class="line">numa_preferred_nid                           :                   -1</span><br><span class="line">total_numa_faults                            :                    0</span><br><span class="line">current_node=0, numa_group_id=0</span><br><span class="line">numa_faults node=0 task_private=0 task_shared=0 group_private=0 group_shared=0</span><br></pre></td></tr></table></figure><p>当设置了pod的Resources的limit和requests的属性如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3.5&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3.5&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></table></figure><p>可以观察到对应的Resources的参数被设置成了对应的cgroup参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /sys/fs/cgroup/cpu/cpu.shares </span></span><br><span class="line">3584</span><br><span class="line">/ <span class="comment"># cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us</span></span><br><span class="line">350000</span><br><span class="line">/ <span class="comment"># cat /sys/fs/cgroup/cpu/cpu.cfs_period_us</span></span><br><span class="line">100000</span><br><span class="line">/ <span class="comment"># cat /proc/sys/kernel/sched_latency_ns</span></span><br><span class="line">24000000</span><br></pre></td></tr></table></figure><p>cpu.shares即为request值:3.5*1024&#x3D;3584，cpu.cfs_quota_us即为limits值:350000，因此正常情况下，cfs调度器的调度时周期是24ms，而重分配周期是100ms，并且该pod在一个重分配周期中最多可占用35ms，并且有压力的情况下，pod可以占据cpu的share比例是3584</p><p><img src="https://github.com/JING21/K8S/raw/main/kubelet/cpumanager/cfs%E8%B0%83%E5%BA%A6.jpg" alt="image-20220729102044974"></p><p>在上图的例子中，</p><ul><li>CFS调度周期为24ms，正常负载的情况下，进程队列中的进程每隔24ms就会被保证执行一次</li><li>CFS重分配周期为100ms，用于保证一个进程的limits设置表示每个重分配周期（100ms该例子中）可以占用cpu的时间，多核系统中，max(limit)&#x3D;CFS重分配周期(100ms)*CPU核数</li><li>因为进程A和B的share值一样，所以在cpu中可以占用同样的资源</li><li>因为cpu-quota分别为35ms和20ms，所以两个进程在一个重分配周期中，最多占有cpu35ms和20ms</li><li>在前面的2个CFS调度周期内，进程A和B由于share值是一样的，所以每个CFS调度内(24ms)，进程A和B都会占用10ms</li><li>在第3个CFS调度周期结束的时候，在本CFS重分配周期内，进程B已经占用了20ms，在剩下的2个CFS调度周期即52ms内，进程B都会被限流，一直到下一个CFS重分配周期内，进程B才可以继续占用CPU</li><li>在3-5个CFS调度周期内，进程B会被限流，所以进程A在第三个调度周期内可以拥有完整的cpu资源，但是进程A也只能占用cpu资源35ms，所以在4-5周期内也会被限流。</li></ul><p>所以pod的limit和进程在cfs调度周期内是密切相关的，比如说200m的limit配置，导致进程在cpu的分配周期内100ms只能占用20ms，会出现问题。</p><p>如果不指定该参数则默认使用none类型，否则可以指定参数为static，指定了static的调度策略以及reserved-cpus保留策略，生成Guaranteed类型的pod，则可以达到独占cpu的效果。</p><ul><li>static策略会管理一个CPU共享资源池（Shared CPU Pool），该共享资源池包含节点上所有的CPU资源，可用且可以独占的CPU数量等于节点的CPU总量减去reserved-cpus或者–system-reserved或者–kube-reserved的资源。</li><li>通过参数预留的CPU是整数的形式，仅支持完整的单核，不能支持0.5c，0.2c这样的参数。共享池的cpu是Qos类型BestEffort 和 Burstable pod 运行的CPU 集合。同时如果Guaranteed类型的pod声明了非整数型的CPU也会运行在共享池的cpu上，只有指定了正整数类型的CPU的Guaranteed类型的pod才会独占完整CPU。</li><li>参照以下的yaml文件配置：</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b]<span class="comment"># for i in `ls cpuset.cpus tasks` ; do echo -n &quot;$i &quot;; cat $i ; done</span></span><br><span class="line">cpuset.cpus 4-6</span><br><span class="line">tasks 5560</span><br><span class="line">[root@node2 9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b]<span class="comment"># cd ..</span></span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># ls</span></span><br><span class="line">10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7  cpuset.memory_migrate</span><br><span class="line">9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b  cpuset.memory_pressure</span><br><span class="line">cgroup.clone_children                                             cpuset.memory_spread_page</span><br><span class="line">cgroup.procs                                                      cpuset.memory_spread_slab</span><br><span class="line">cpuset.cpu_exclusive                                              cpuset.mems</span><br><span class="line">cpuset.cpus                                                       cpuset.sched_load_balance</span><br><span class="line">cpuset.effective_cpus                                             cpuset.sched_relax_domain_level</span><br><span class="line">cpuset.effective_mems                                             notify_on_release</span><br><span class="line">cpuset.mem_exclusive                                              tasks</span><br><span class="line">cpuset.mem_hardwall</span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># cd10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7</span></span><br><span class="line">-bash: cd10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7: 未找到命令</span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># ls</span></span><br><span class="line">10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7  cpuset.memory_migrate</span><br><span class="line">9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b  cpuset.memory_pressure</span><br><span class="line">cgroup.clone_children                                             cpuset.memory_spread_page</span><br><span class="line">cgroup.procs                                                      cpuset.memory_spread_slab</span><br><span class="line">cpuset.cpu_exclusive                                              cpuset.mems</span><br><span class="line">cpuset.cpus                                                       cpuset.sched_load_balance</span><br><span class="line">cpuset.effective_cpus                                             cpuset.sched_relax_domain_level</span><br><span class="line">cpuset.effective_mems                                             notify_on_release</span><br><span class="line">cpuset.mem_exclusive                                              tasks</span><br><span class="line">cpuset.mem_hardwall</span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># cd 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7</span></span><br><span class="line">[root@node2 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7]<span class="comment"># for i in `ls cpuset.cpus tasks` ; do echo -n &quot;$i &quot;; cat $i ; done</span></span><br><span class="line">cpuset.cpus 0-7</span><br><span class="line">tasks 5396</span><br><span class="line">(reverse-i-search)`grep <span class="string">&#x27;: history |^Cep cpu</span></span><br><span class="line"><span class="string">[root@node2 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7]# grep &#x27;</span>processor<span class="string">&#x27; /proc/cpuinfo | wc -l</span></span><br><span class="line"><span class="string">8</span></span><br><span class="line"><span class="string">[root@master cpu]# kubectl describe po cpu-test</span></span><br><span class="line"><span class="string">Name:         cpu-test</span></span><br><span class="line"><span class="string">Namespace:    default</span></span><br><span class="line"><span class="string">Priority:     0</span></span><br><span class="line"><span class="string">Node:         node2/100.73.61.22</span></span><br><span class="line"><span class="string">Start Time:   Fri, 29 Jul 2022 14:19:26 +0800</span></span><br><span class="line"><span class="string">Labels:       &lt;none&gt;</span></span><br><span class="line"><span class="string">Annotations:  cni.projectcalico.org/containerID: 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7</span></span><br><span class="line"><span class="string">              cni.projectcalico.org/podIP: 10.244.104.61/32</span></span><br><span class="line"><span class="string">              cni.projectcalico.org/podIPs: 10.244.104.61/32</span></span><br><span class="line"><span class="string">              k8s.v1.cni.cncf.io/network-status:</span></span><br><span class="line"><span class="string">                [&#123;</span></span><br><span class="line"><span class="string">                    &quot;name&quot;: &quot;k8s-pod-network&quot;,</span></span><br><span class="line"><span class="string">                    &quot;ips&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;10.244.104.61&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;default&quot;: true,</span></span><br><span class="line"><span class="string">                    &quot;dns&quot;: &#123;&#125;</span></span><br><span class="line"><span class="string">                &#125;]</span></span><br><span class="line"><span class="string">              k8s.v1.cni.cncf.io/networks-status:</span></span><br><span class="line"><span class="string">                [&#123;</span></span><br><span class="line"><span class="string">                    &quot;name&quot;: &quot;k8s-pod-network&quot;,</span></span><br><span class="line"><span class="string">                    &quot;ips&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;10.244.104.61&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;default&quot;: true,</span></span><br><span class="line"><span class="string">                    &quot;dns&quot;: &#123;&#125;</span></span><br><span class="line"><span class="string">                &#125;]</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/allocated: true</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/cidr: 10.16.0.0/16,fd00:10:16::/64</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/gateway: 10.16.0.1,fd00:10:16::1</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/ip_address: 10.16.0.10,fd00:10:16::a</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/logical_router: ovn-cluster</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/logical_switch: ovn-default</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/mac_address: 00:00:00:4D:3C:02</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/pod_nic_type: veth-pair</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/routed: true</span></span><br><span class="line"><span class="string">Status:       Running</span></span><br><span class="line"><span class="string">IP:           10.244.104.61</span></span><br><span class="line"><span class="string">IPs:</span></span><br><span class="line"><span class="string">  IP:  10.244.104.61</span></span><br><span class="line"><span class="string">Containers:</span></span><br><span class="line"><span class="string">  busybox-pod1:</span></span><br><span class="line"><span class="string">    Container ID:  docker://3d476202aeb46d4431e9073e521103cda36d0262f2def11b41d56d89e78d5c8c</span></span><br><span class="line"><span class="string">    Image:         registry.paas/cmss/busybox:1.24</span></span><br><span class="line"><span class="string">    Image ID:      docker-pullable://registry.paas/cmss/busybox@sha256:f73ae051fae52945d92ee20d62c315306c593c59a429ccbbdcba4a488ee12269</span></span><br><span class="line"><span class="string">    Port:          &lt;none&gt;</span></span><br><span class="line"><span class="string">    Host Port:     &lt;none&gt;</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      sleep</span></span><br><span class="line"><span class="string">      3600</span></span><br><span class="line"><span class="string">    State:          Running</span></span><br><span class="line"><span class="string">      Started:      Fri, 29 Jul 2022 15:19:27 +0800</span></span><br><span class="line"><span class="string">    Last State:     Terminated</span></span><br><span class="line"><span class="string">      Reason:       Completed</span></span><br><span class="line"><span class="string">      Exit Code:    0</span></span><br><span class="line"><span class="string">      Started:      Fri, 29 Jul 2022 14:19:27 +0800</span></span><br><span class="line"><span class="string">      Finished:     Fri, 29 Jul 2022 15:19:27 +0800</span></span><br><span class="line"><span class="string">    Ready:          True</span></span><br><span class="line"><span class="string">    Restart Count:  1</span></span><br><span class="line"><span class="string">    Limits:</span></span><br><span class="line"><span class="string">      cpu:     3</span></span><br><span class="line"><span class="string">      memory:  500Mi</span></span><br><span class="line"><span class="string">    Requests:</span></span><br><span class="line"><span class="string">      cpu:        3</span></span><br><span class="line"><span class="string">      memory:     500Mi</span></span><br><span class="line"><span class="string">    Environment:  &lt;none&gt;</span></span><br><span class="line"><span class="string">    Mounts:</span></span><br><span class="line"><span class="string">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-6z7rt (ro)</span></span><br><span class="line"><span class="string">Conditions:</span></span><br><span class="line"><span class="string">  Type              Status</span></span><br><span class="line"><span class="string">  Initialized       True</span></span><br><span class="line"><span class="string">  Ready             True</span></span><br><span class="line"><span class="string">  ContainersReady   True</span></span><br><span class="line"><span class="string">  PodScheduled      True</span></span><br><span class="line"><span class="string">Volumes:</span></span><br><span class="line"><span class="string">  kube-api-access-6z7rt:</span></span><br><span class="line"><span class="string">    Type:                    Projected (a volume that contains injected data from multiple sources)</span></span><br><span class="line"><span class="string">    TokenExpirationSeconds:  3607</span></span><br><span class="line"><span class="string">    ConfigMapName:           kube-root-ca.crt</span></span><br><span class="line"><span class="string">    ConfigMapOptional:       &lt;nil&gt;</span></span><br><span class="line"><span class="string">    DownwardAPI:             true</span></span><br><span class="line"><span class="string">QoS Class:                   Guaranteed</span></span><br><span class="line"><span class="string">Node-Selectors:              &lt;none&gt;</span></span><br><span class="line"><span class="string">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span></span><br><span class="line"><span class="string">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span></span><br><span class="line"><span class="string">Events:</span></span><br><span class="line"><span class="string">  Type    Reason   Age                From     Message</span></span><br><span class="line"><span class="string">  ----    ------   ----               ----     -------</span></span><br><span class="line"><span class="string">  Normal  Pulled   39m (x2 over 99m)  kubelet  Container image &quot;registry.paas/cmss/busybox:1.24&quot; already present on machine</span></span><br><span class="line"><span class="string">  Normal  Created  39m (x2 over 99m)  kubelet  Created container busybox-pod1</span></span><br><span class="line"><span class="string">  Normal  Started  39m (x2 over 99m)  kubelet  Started container busybox-pod1</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">[root@node2 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7]# cat /var/lib/kubelet/config.yaml</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">authentication:</span></span><br><span class="line"><span class="string">  anonymous:</span></span><br><span class="line"><span class="string">    enabled: false</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheTTL: 0s</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">  x509:</span></span><br><span class="line"><span class="string">    clientCAFile: /etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">authorization:</span></span><br><span class="line"><span class="string">  mode: Webhook</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheAuthorizedTTL: 0s</span></span><br><span class="line"><span class="string">    cacheUnauthorizedTTL: 0s</span></span><br><span class="line"><span class="string">cgroupDriver: cgroupfs</span></span><br><span class="line"><span class="string">clusterDNS:</span></span><br><span class="line"><span class="string">- 10.96.0.10</span></span><br><span class="line"><span class="string">clusterDomain: cluster.local</span></span><br><span class="line"><span class="string">cpuManagerReconcilePeriod: 0s</span></span><br><span class="line"><span class="string">evictionPressureTransitionPeriod: 0s</span></span><br><span class="line"><span class="string">fileCheckFrequency: 0s</span></span><br><span class="line"><span class="string">healthzBindAddress: 127.0.0.1</span></span><br><span class="line"><span class="string">healthzPort: 10248</span></span><br><span class="line"><span class="string">httpCheckFrequency: 0s</span></span><br><span class="line"><span class="string">imageMinimumGCAge: 0s</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration</span></span><br><span class="line"><span class="string">logging: &#123;&#125;</span></span><br><span class="line"><span class="string">nodeStatusReportFrequency: 0s</span></span><br><span class="line"><span class="string">nodeStatusUpdateFrequency: 0s</span></span><br><span class="line"><span class="string">rotateCertificates: true</span></span><br><span class="line"><span class="string">runtimeRequestTimeout: 0s</span></span><br><span class="line"><span class="string">shutdownGracePeriod: 0s</span></span><br><span class="line"><span class="string">shutdownGracePeriodCriticalPods: 0s</span></span><br><span class="line"><span class="string">staticPodPath: /etc/kubernetes/manifests</span></span><br><span class="line"><span class="string">streamingConnectionIdleTimeout: 0s</span></span><br><span class="line"><span class="string">syncFrequency: 0s</span></span><br><span class="line"><span class="string">volumeStatsAggPeriod: 0s</span></span><br><span class="line"><span class="string">reservedSystemCPUs: &quot;0-3&quot;</span></span><br><span class="line"><span class="string">cpuManagerPolicy: static</span></span><br></pre></td></tr></table></figure><p>从结果可以看出，该pod的类型是Guaranteed类型，同时因为kubelet配置了reserved-cpus，保留了4个核，(reservedSystemCPUs: “0-3”)，所以该pod的业务容器只会使用cpuset.cpus 4-6,不会使用0-3这三个核，但是每个pod的根容器（pause容器）则会使用到预留资源的核0-3，会默认随机使用0-7所有的cpu。</p><p>所以目前的能满足的情况是，在pod配置为Guaranteed类型的Qos的pod后，并且cpu使用必须声明为整数类型，才能独占cpu，不使用保留的cpus。</p><h3 id="Kubelet相关代码分析"><a href="#Kubelet相关代码分析" class="headerlink" title="Kubelet相关代码分析"></a>Kubelet相关代码分析</h3><p>kubelet的代码结构使用传统的golang结构cmd&#x2F;pkg结构，启动代码中与cpu-manager相关的如下所示(未包含全部)：</p><p>cmd&#x2F;kubelet&#x2F;app&#x2F;server.go</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(ctx context.Context, s *options.KubeletServer, kubeDeps *kubelet.Dependencies, featureGate featuregate.FeatureGate)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">    ···</span><br><span class="line"><span class="keyword">var</span> reservedSystemCPUs cpuset.CPUSet</span><br><span class="line"><span class="keyword">if</span> s.ReservedSystemCPUs != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="comment">// is it safe do use CAdvisor here ??</span></span><br><span class="line">machineInfo, err := kubeDeps.CAdvisorInterface.MachineInfo()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// if can&#x27;t use CAdvisor here, fall back to non-explicit cpu list behavor</span></span><br><span class="line">klog.InfoS(<span class="string">&quot;Failed to get MachineInfo, set reservedSystemCPUs to empty&quot;</span>)</span><br><span class="line">reservedSystemCPUs = cpuset.NewCPUSet()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">var</span> errParse <span class="type">error</span></span><br><span class="line">reservedSystemCPUs, errParse = cpuset.Parse(s.ReservedSystemCPUs)</span><br><span class="line"><span class="keyword">if</span> errParse != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// invalid cpu list is provided, set reservedSystemCPUs to empty, so it won&#x27;t overwrite kubeReserved/systemReserved</span></span><br><span class="line">klog.InfoS(<span class="string">&quot;Invalid ReservedSystemCPUs&quot;</span>, <span class="string">&quot;systemReservedCPUs&quot;</span>, s.ReservedSystemCPUs)</span><br><span class="line"><span class="keyword">return</span> errParse</span><br><span class="line">&#125;</span><br><span class="line">reservedList := reservedSystemCPUs.ToSlice()</span><br><span class="line">first := reservedList[<span class="number">0</span>]</span><br><span class="line">last := reservedList[<span class="built_in">len</span>(reservedList)<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">if</span> first &lt; <span class="number">0</span> || last &gt;= machineInfo.NumCores &#123;</span><br><span class="line"><span class="comment">// the specified cpuset is outside of the range of what the machine has</span></span><br><span class="line">klog.InfoS(<span class="string">&quot;Invalid cpuset specified by --reserved-cpus&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Invalid cpuset %q specified by --reserved-cpus&quot;</span>, s.ReservedSystemCPUs)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">reservedSystemCPUs = cpuset.NewCPUSet()</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> reservedSystemCPUs.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// at cmd option valication phase it is tested either --system-reserved-cgroup or --kube-reserved-cgroup is specified, so overwrite should be ok</span></span><br><span class="line">klog.InfoS(<span class="string">&quot;Option --reserved-cpus is specified, it will overwrite the cpu setting in KubeReserved and SystemReserved&quot;</span>, <span class="string">&quot;kubeReservedCPUs&quot;</span>, s.KubeReserved, <span class="string">&quot;systemReservedCPUs&quot;</span>, s.SystemReserved)</span><br><span class="line"><span class="keyword">if</span> s.KubeReserved != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">delete</span>(s.KubeReserved, <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> s.SystemReserved == <span class="literal">nil</span> &#123;</span><br><span class="line">s.SystemReserved = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">&#125;</span><br><span class="line">s.SystemReserved[<span class="string">&quot;cpu&quot;</span>] = strconv.Itoa(reservedSystemCPUs.Size())</span><br><span class="line">klog.InfoS(<span class="string">&quot;After cpu setting is overwritten&quot;</span>, <span class="string">&quot;kubeReservedCPUs&quot;</span>, s.KubeReserved, <span class="string">&quot;systemReservedCPUs&quot;</span>, s.SystemReserved)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kubeReserved, err := parseResourceList(s.KubeReserved)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">systemReserved, err := parseResourceList(s.SystemReserved)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    ···</span><br><span class="line">  </span><br><span class="line">kubeDeps.ContainerManager, err = cm.NewContainerManager(</span><br><span class="line">kubeDeps.Mounter,</span><br><span class="line">kubeDeps.CAdvisorInterface,</span><br><span class="line">cm.NodeConfig&#123;</span><br><span class="line">RuntimeCgroupsName:    s.RuntimeCgroups,</span><br><span class="line">SystemCgroupsName:     s.SystemCgroups,</span><br><span class="line">KubeletCgroupsName:    s.KubeletCgroups,</span><br><span class="line">ContainerRuntime:      s.ContainerRuntime,</span><br><span class="line">CgroupsPerQOS:         s.CgroupsPerQOS,</span><br><span class="line">CgroupRoot:            s.CgroupRoot,</span><br><span class="line">CgroupDriver:          s.CgroupDriver,</span><br><span class="line">KubeletRootDir:        s.RootDirectory,</span><br><span class="line">ProtectKernelDefaults: s.ProtectKernelDefaults,</span><br><span class="line">NodeAllocatableConfig: cm.NodeAllocatableConfig&#123;</span><br><span class="line">KubeReservedCgroupName:   s.KubeReservedCgroup,</span><br><span class="line">SystemReservedCgroupName: s.SystemReservedCgroup,</span><br><span class="line">EnforceNodeAllocatable:   sets.NewString(s.EnforceNodeAllocatable...),</span><br><span class="line">KubeReserved:             kubeReserved,</span><br><span class="line">SystemReserved:           systemReserved,</span><br><span class="line">ReservedSystemCPUs:       reservedSystemCPUs,</span><br><span class="line">HardEvictionThresholds:   hardEvictionThresholds,</span><br><span class="line">&#125;,</span><br><span class="line">QOSReserved:                             *experimentalQOSReserved,</span><br><span class="line">ExperimentalCPUManagerPolicy:            s.CPUManagerPolicy,</span><br><span class="line">ExperimentalCPUManagerReconcilePeriod:   s.CPUManagerReconcilePeriod.Duration,</span><br><span class="line">ExperimentalMemoryManagerPolicy:         s.MemoryManagerPolicy,</span><br><span class="line">ExperimentalMemoryManagerReservedMemory: s.ReservedMemory,</span><br><span class="line">ExperimentalPodPidsLimit:                s.PodPidsLimit,</span><br><span class="line">EnforceCPULimits:                        s.CPUCFSQuota,</span><br><span class="line">CPUCFSQuotaPeriod:                       s.CPUCFSQuotaPeriod.Duration,</span><br><span class="line">ExperimentalTopologyManagerPolicy:       s.TopologyManagerPolicy,</span><br><span class="line">ExperimentalTopologyManagerScope:        s.TopologyManagerScope,</span><br><span class="line">&#125;,</span><br><span class="line">s.FailSwapOn,</span><br><span class="line">devicePluginEnabled,</span><br><span class="line">kubeDeps.Recorder)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  ···</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和容器cpu相关的主要是以上的代码，流程主要是取到flag中定义的启动参数–reserved-cpus参数，并使用cpuset.Parse方法将其转换为cpuset类型，然后将ReservedSystemCPUs构建为一个切片数组，与通过cadvisor取到的machineinfo中的cpu字段进行一个对比，判断是否传入的reserved-cpus参数，有不属于该节点实际的cpu。校验通过后，如果ReservedSystemCPUs的值存在，则会覆盖掉另外的两个系统参数中KubeReserved和SystemReserved中关于cpu的相关数据。最后初始化cm.NewContainerManager</p><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;container_manager_linux.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewContainerManager</span><span class="params">(mountUtil mount.Interface, cadvisorInterface cadvisor.Interface, nodeConfig NodeConfig, failSwapOn <span class="type">bool</span>, devicePluginEnabled <span class="type">bool</span>, recorder record.EventRecorder)</span></span> (ContainerManager, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize CPU manager</span></span><br><span class="line"><span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(kubefeatures.CPUManager) &#123;</span><br><span class="line">cm.cpuManager, err = cpumanager.NewManager(</span><br><span class="line">nodeConfig.ExperimentalCPUManagerPolicy,</span><br><span class="line">nodeConfig.ExperimentalCPUManagerReconcilePeriod,</span><br><span class="line">machineInfo,</span><br><span class="line">nodeConfig.NodeAllocatableConfig.ReservedSystemCPUs,</span><br><span class="line">cm.GetNodeAllocatableReservation(),</span><br><span class="line">nodeConfig.KubeletRootDir,</span><br><span class="line">cm.topologyManager,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">klog.ErrorS(err, <span class="string">&quot;Failed to initialize cpu manager&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">cm.topologyManager.AddHintProvider(cm.cpuManager)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> cm, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NewContainerManager初始化containerManager，其中包含了多个实现的ContainerManager：cgroupManager，qosContainerManager，topologyManager，cpuManager，memoryManager等。主要看cpuManager相关的，判断cpuManager特性是否开启，如果特性开启的话，会调用**cpumanager.NewManager()**初始化一个cpuManager。具体代码如下：</p><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;cpu_manager.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewManager creates new cpu manager based on provided policy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewManager</span><span class="params">(cpuPolicyName <span class="type">string</span>, reconcilePeriod time.Duration, machineInfo *cadvisorapi.MachineInfo, specificCPUs cpuset.CPUSet, nodeAllocatableReservation v1.ResourceList, stateFileDirectory <span class="type">string</span>, affinity topologymanager.Store)</span></span> (Manager, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> topo *topology.CPUTopology</span><br><span class="line"><span class="keyword">var</span> policy Policy</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> policyName(cpuPolicyName) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> PolicyNone:</span><br><span class="line">policy = NewNonePolicy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> PolicyStatic:</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">topo, err = topology.Discover(machineInfo)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">klog.InfoS(<span class="string">&quot;Detected CPU topology&quot;</span>, <span class="string">&quot;topology&quot;</span>, topo)</span><br><span class="line"></span><br><span class="line">reservedCPUs, ok := nodeAllocatableReservation[v1.ResourceCPU]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="comment">// The static policy cannot initialize without this information.</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;[cpumanager] unable to determine reserved CPU resources for static policy&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> reservedCPUs.IsZero() &#123;</span><br><span class="line"><span class="comment">// The static policy requires this to be nonzero. Zero CPU reservation</span></span><br><span class="line"><span class="comment">// would allow the shared pool to be completely exhausted. At that point</span></span><br><span class="line"><span class="comment">// either we would violate our guarantee of exclusivity or need to evict</span></span><br><span class="line"><span class="comment">// any pod that has at least one container that requires zero CPUs.</span></span><br><span class="line"><span class="comment">// See the comments in policy_static.go for more details.</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;[cpumanager] the static policy requires systemreserved.cpu + kubereserved.cpu to be greater than zero&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Take the ceiling of the reservation, since fractional CPUs cannot be</span></span><br><span class="line"><span class="comment">// exclusively allocated.</span></span><br><span class="line">reservedCPUsFloat := <span class="type">float64</span>(reservedCPUs.MilliValue()) / <span class="number">1000</span></span><br><span class="line">numReservedCPUs := <span class="type">int</span>(math.Ceil(reservedCPUsFloat))</span><br><span class="line">policy, err = NewStaticPolicy(topo, numReservedCPUs, specificCPUs, affinity)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;new static policy error: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unknown policy: \&quot;%s\&quot;&quot;</span>, cpuPolicyName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">manager := &amp;manager&#123;</span><br><span class="line">policy:                     policy,</span><br><span class="line">reconcilePeriod:            reconcilePeriod,</span><br><span class="line">topology:                   topo,</span><br><span class="line">nodeAllocatableReservation: nodeAllocatableReservation,</span><br><span class="line">stateFileDirectory:         stateFileDirectory,</span><br><span class="line">&#125;</span><br><span class="line">manager.sourcesReady = &amp;sourcesReadyStub&#123;&#125;</span><br><span class="line"><span class="keyword">return</span> manager, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Policy implements logic for pod container to CPU assignment.</span></span><br><span class="line"><span class="keyword">type</span> Policy <span class="keyword">interface</span> &#123;</span><br><span class="line">Name() <span class="type">string</span></span><br><span class="line">Start(s state.State) <span class="type">error</span></span><br><span class="line"><span class="comment">// Allocate call is idempotent</span></span><br><span class="line">Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line"><span class="comment">// RemoveContainer call is idempotent</span></span><br><span class="line">RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"><span class="comment">// GetTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line"><span class="comment">// and is consulted to achieve NUMA aware resource alignment among this</span></span><br><span class="line"><span class="comment">// and other resource controllers.</span></span><br><span class="line">GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line"><span class="comment">// GetPodTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line"><span class="comment">// and is consulted to achieve NUMA aware resource alignment per Pod</span></span><br><span class="line"><span class="comment">// among this and other resource controllers.</span></span><br><span class="line">GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line"><span class="comment">// GetAllocatableCPUs returns the assignable (not allocated) CPUs</span></span><br><span class="line">GetAllocatableCPUs(m state.State) cpuset.CPUSet</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NewManager会创建一个<strong>topology.CPUTopology</strong>，同时会声明一个Policy的接口，根据传入的不同Policy类型，调用具体的Policy实现，Policy需要实现具体的pod容器的cpu 分配方法。现在Kubernetes默认支持的policy有两种，具体参数为kubelet启动时传入的–cpu-manager-policy&#x3D;static，默认不启用default的情况，Policy就是none。</p><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_none.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">limitations under the License.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cpumanager</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/klog/v2&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/kubernetes/pkg/kubelet/cm/cpumanager/state&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/kubernetes/pkg/kubelet/cm/cpuset&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/kubernetes/pkg/kubelet/cm/topologymanager&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> nonePolicy <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ Policy = &amp;nonePolicy&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolicyNone name of none policy</span></span><br><span class="line"><span class="keyword">const</span> PolicyNone policyName = <span class="string">&quot;none&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewNonePolicy returns a cpuset manager policy that does nothing</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNonePolicy</span><span class="params">()</span></span> Policy &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;nonePolicy&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="type">string</span>(PolicyNone)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> Start(s state.State) <span class="type">error</span> &#123;</span><br><span class="line">klog.InfoS(<span class="string">&quot;None policy: Start&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assignable CPUs are the ones that can be exclusively allocated to pods that meet the exclusivity requirement</span></span><br><span class="line"><span class="comment">// (ie guaranteed QoS class and integral CPU request).</span></span><br><span class="line"><span class="comment">// Assignability of CPUs as a concept is only applicable in case of static policy i.e. scenarios where workloads</span></span><br><span class="line"><span class="comment">// CAN get exclusive access to core(s).</span></span><br><span class="line"><span class="comment">// Hence, we return empty set here: no cpus are assignable according to above definition with this policy.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> GetAllocatableCPUs(m state.State) cpuset.CPUSet &#123;</span><br><span class="line"><span class="keyword">return</span> cpuset.NewCPUSet()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>默认None Policy没有具体实现Policy接口，仅仅返回空值，表示对cpu分配不做管理。</p><p>而Static Policy首先在创建CPUManager的时候就会进行校验，首先根据cadvisor取到的machineInfo（节点信息），根据**topology.Dicsovery(machineInfo)**可以生成具体的cpu拓扑信息,包含了节点cpu逻辑核数，物理核数和cpu socket数</p><p><img src="https://github.com/JING21/K8S/raw/main/kubelet/cpumanager/topo.png" alt="image-20220809155145496"></p><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;topology&#x2F;topology.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CPUTopology contains details of node cpu, where :</span></span><br><span class="line"><span class="comment">// CPU  - logical CPU, cadvisor - thread</span></span><br><span class="line"><span class="comment">// Core - physical CPU, cadvisor - Core</span></span><br><span class="line"><span class="comment">// Socket - socket, cadvisor - Node</span></span><br><span class="line"><span class="keyword">type</span> CPUTopology <span class="keyword">struct</span> &#123;</span><br><span class="line">NumCPUs    <span class="type">int</span></span><br><span class="line">NumCores   <span class="type">int</span></span><br><span class="line">NumSockets <span class="type">int</span></span><br><span class="line">CPUDetails CPUDetails</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPUDetails is a map from CPU ID to Core ID, Socket ID, and NUMA ID.</span></span><br><span class="line"><span class="keyword">type</span> CPUDetails <span class="keyword">map</span>[<span class="type">int</span>]CPUInfo</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPUInfo contains the NUMA, socket, and core IDs associated with a CPU.</span></span><br><span class="line"><span class="keyword">type</span> CPUInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">NUMANodeID <span class="type">int</span></span><br><span class="line">SocketID   <span class="type">int</span></span><br><span class="line">CoreID     <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来就会进行校验工作，判断reservedCPUS是否存在，启用Static CPU Policy必须开启reserved-CPUs的特性。在确保reservedCPUs不为0的情况下，向上取整计算出具体保留的numReservedCPUs。同时调用NewStaticPolicy()方法，初始化StaticPolicy。</p><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_static.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewStaticPolicy returns a CPU manager policy that does not change CPU</span></span><br><span class="line"><span class="comment">// assignments for exclusively pinned guaranteed containers after the main</span></span><br><span class="line"><span class="comment">// container process starts.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStaticPolicy</span><span class="params">(topology *topology.CPUTopology, numReservedCPUs <span class="type">int</span>, reservedCPUs cpuset.CPUSet, affinity topologymanager.Store)</span></span> (Policy, <span class="type">error</span>) &#123;</span><br><span class="line">allCPUs := topology.CPUDetails.CPUs()</span><br><span class="line"><span class="keyword">var</span> reserved cpuset.CPUSet</span><br><span class="line"><span class="keyword">if</span> reservedCPUs.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line">reserved = reservedCPUs</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// takeByTopology allocates CPUs associated with low-numbered cores from</span></span><br><span class="line"><span class="comment">// allCPUs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For example: Given a system with 8 CPUs available and HT enabled,</span></span><br><span class="line"><span class="comment">// if numReservedCPUs=2, then reserved=&#123;0,4&#125;</span></span><br><span class="line">reserved, _ = takeByTopology(topology, allCPUs, numReservedCPUs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> reserved.Size() != numReservedCPUs &#123;</span><br><span class="line">err := fmt.Errorf(<span class="string">&quot;[cpumanager] unable to reserve the required amount of CPUs (size of %s did not equal %d)&quot;</span>, reserved, numReservedCPUs)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">klog.InfoS(<span class="string">&quot;Reserved CPUs not available for exclusive assignment&quot;</span>, <span class="string">&quot;reservedSize&quot;</span>, reserved.Size(), <span class="string">&quot;reserved&quot;</span>, reserved)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;staticPolicy&#123;</span><br><span class="line">topology:    topology,</span><br><span class="line">reserved:    reserved,</span><br><span class="line">affinity:    affinity,</span><br><span class="line">cpusToReuse: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet),</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NewStaticPolicy会校验传入的reservedCPUs，如果其为空，则会根据numReservedCPUs，在allCPUs中通过takeByTopology（）方法，随机保留下对应数量的cpu，比如说numReservedCPUs为2，可能会保留0，4两个核。</p><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy.go</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Policy <span class="keyword">interface</span> &#123;</span><br><span class="line">Name() <span class="type">string</span></span><br><span class="line">Start(s state.State) <span class="type">error</span></span><br><span class="line"><span class="comment">// Allocate call is idempotent</span></span><br><span class="line">Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line"><span class="comment">// RemoveContainer call is idempotent</span></span><br><span class="line">RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"><span class="comment">// GetTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line"><span class="comment">// and is consulted to achieve NUMA aware resource alignment among this</span></span><br><span class="line"><span class="comment">// and other resource controllers.</span></span><br><span class="line">GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line"><span class="comment">// GetPodTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line"><span class="comment">// and is consulted to achieve NUMA aware resource alignment per Pod</span></span><br><span class="line"><span class="comment">// among this and other resource controllers.</span></span><br><span class="line">GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line"><span class="comment">// GetAllocatableCPUs returns the assignable (not allocated) CPUs</span></span><br><span class="line">GetAllocatableCPUs(m state.State) cpuset.CPUSet</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cpu分配的具体policy需要实现以下具体的接口，包括了Name，Allocate(用于分配cpu给具体的pod的容器)，RemoveContainer， GetTopologyHints（根据pod的当前情况，获取cpu的topo关系），GetAllocatableCPUs（获取可用的cpuset），GetPodTopologyHints（实现了topologymanager.HintProvider的接口，生成NUMA亲和性相关性的map关系，用于cpu的分配）</p><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_static.go</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> validateState(s state.State) <span class="type">error</span> &#123;</span><br><span class="line">tmpAssignments := s.GetCPUAssignments()</span><br><span class="line">tmpDefaultCPUset := s.GetDefaultCPUSet()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default cpuset cannot be empty when assignments exist</span></span><br><span class="line"><span class="keyword">if</span> tmpDefaultCPUset.IsEmpty() &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(tmpAssignments) != <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;default cpuset cannot be empty&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// state is empty initialize</span></span><br><span class="line">allCPUs := p.topology.CPUDetails.CPUs()</span><br><span class="line">s.SetDefaultCPUSet(allCPUs)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// State has already been initialized from file (is not empty)</span></span><br><span class="line"><span class="comment">// 1. Check if the reserved cpuset is not part of default cpuset because:</span></span><br><span class="line"><span class="comment">// - kube/system reserved have changed (increased) - may lead to some containers not being able to start</span></span><br><span class="line"><span class="comment">// - user tampered with file</span></span><br><span class="line"><span class="keyword">if</span> !p.reserved.Intersection(tmpDefaultCPUset).Equals(p.reserved) &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;not all reserved cpus: \&quot;%s\&quot; are present in defaultCpuSet: \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">p.reserved.String(), tmpDefaultCPUset.String())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Check if state for static policy is consistent</span></span><br><span class="line"><span class="keyword">for</span> pod := <span class="keyword">range</span> tmpAssignments &#123;</span><br><span class="line"><span class="keyword">for</span> container, cset := <span class="keyword">range</span> tmpAssignments[pod] &#123;</span><br><span class="line"><span class="comment">// None of the cpu in DEFAULT cset should be in s.assignments</span></span><br><span class="line"><span class="keyword">if</span> !tmpDefaultCPUset.Intersection(cset).IsEmpty() &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;pod: %s, container: %s cpuset: \&quot;%s\&quot; overlaps with default cpuset \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">pod, container, cset.String(), tmpDefaultCPUset.String())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. It&#x27;s possible that the set of available CPUs has changed since</span></span><br><span class="line"><span class="comment">// the state was written. This can be due to for example</span></span><br><span class="line"><span class="comment">// offlining a CPU when kubelet is not running. If this happens,</span></span><br><span class="line"><span class="comment">// CPU manager will run into trouble when later it tries to</span></span><br><span class="line"><span class="comment">// assign non-existent CPUs to containers. Validate that the</span></span><br><span class="line"><span class="comment">// topology that was received during CPU manager startup matches with</span></span><br><span class="line"><span class="comment">// the set of CPUs stored in the state.</span></span><br><span class="line">totalKnownCPUs := tmpDefaultCPUset.Clone()</span><br><span class="line">tmpCPUSets := []cpuset.CPUSet&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> pod := <span class="keyword">range</span> tmpAssignments &#123;</span><br><span class="line"><span class="keyword">for</span> _, cset := <span class="keyword">range</span> tmpAssignments[pod] &#123;</span><br><span class="line">tmpCPUSets = <span class="built_in">append</span>(tmpCPUSets, cset)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">totalKnownCPUs = totalKnownCPUs.UnionAll(tmpCPUSets)</span><br><span class="line"><span class="keyword">if</span> !totalKnownCPUs.Equals(p.topology.CPUDetails.CPUs()) &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;current set of available CPUs \&quot;%s\&quot; doesn&#x27;t match with CPUs in state \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">p.topology.CPUDetails.CPUs().String(), totalKnownCPUs.String())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAllocatableCPUs returns the set of unassigned CPUs minus the reserved set.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> GetAllocatableCPUs(s state.State) cpuset.CPUSet &#123;</span><br><span class="line"><span class="keyword">return</span> s.GetDefaultCPUSet().Difference(p.reserved)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> updateCPUsToReuse(pod *v1.Pod, container *v1.Container, cset cpuset.CPUSet) &#123;</span><br><span class="line"><span class="comment">// If pod entries to m.cpusToReuse other than the current pod exist, delete them.</span></span><br><span class="line"><span class="keyword">for</span> podUID := <span class="keyword">range</span> p.cpusToReuse &#123;</span><br><span class="line"><span class="keyword">if</span> podUID != <span class="type">string</span>(pod.UID) &#123;</span><br><span class="line"><span class="built_in">delete</span>(p.cpusToReuse, podUID)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// If no cpuset exists for cpusToReuse by this pod yet, create one.</span></span><br><span class="line"><span class="keyword">if</span> _, ok := p.cpusToReuse[<span class="type">string</span>(pod.UID)]; !ok &#123;</span><br><span class="line">p.cpusToReuse[<span class="type">string</span>(pod.UID)] = cpuset.NewCPUSet()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Check if the container is an init container.</span></span><br><span class="line"><span class="comment">// If so, add its cpuset to the cpuset of reusable CPUs for any new allocations.</span></span><br><span class="line"><span class="keyword">for</span> _, initContainer := <span class="keyword">range</span> pod.Spec.InitContainers &#123;</span><br><span class="line"><span class="keyword">if</span> container.Name == initContainer.Name &#123;</span><br><span class="line">p.cpusToReuse[<span class="type">string</span>(pod.UID)] = p.cpusToReuse[<span class="type">string</span>(pod.UID)].Union(cset)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Otherwise it is an app container.</span></span><br><span class="line"><span class="comment">// Remove its cpuset from the cpuset of reusable CPUs for any new allocations.</span></span><br><span class="line">p.cpusToReuse[<span class="type">string</span>(pod.UID)] = p.cpusToReuse[<span class="type">string</span>(pod.UID)].Difference(cset)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> numCPUs := p.guaranteedCPUs(pod, container); numCPUs != <span class="number">0</span> &#123;</span><br><span class="line">klog.InfoS(<span class="string">&quot;Static policy: Allocate&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name)</span><br><span class="line"><span class="comment">// container belongs in an exclusively allocated pool</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> p.options.FullPhysicalCPUsOnly &amp;&amp; ((numCPUs % p.topology.CPUsPerCore()) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// Since CPU Manager has been enabled requesting strict SMT alignment, it means a guaranteed pod can only be admitted</span></span><br><span class="line"><span class="comment">// if the CPU requested is a multiple of the number of virtual cpus per physical cores.</span></span><br><span class="line"><span class="comment">// In case CPU request is not a multiple of the number of virtual cpus per physical cores the Pod will be put</span></span><br><span class="line"><span class="comment">// in Failed state, with SMTAlignmentError as reason. Since the allocation happens in terms of physical cores</span></span><br><span class="line"><span class="comment">// and the scheduler is responsible for ensuring that the workload goes to a node that has enough CPUs,</span></span><br><span class="line"><span class="comment">// the pod would be placed on a node where there are enough physical cores available to be allocated.</span></span><br><span class="line"><span class="comment">// Just like the behaviour in case of static policy, takeByTopology will try to first allocate CPUs from the same socket</span></span><br><span class="line"><span class="comment">// and only in case the request cannot be sattisfied on a single socket, CPU allocation is done for a workload to occupy all</span></span><br><span class="line"><span class="comment">// CPUs on a physical core. Allocation of individual threads would never have to occur.</span></span><br><span class="line"><span class="keyword">return</span> SMTAlignmentError&#123;</span><br><span class="line">RequestedCPUs: numCPUs,</span><br><span class="line">CpusPerCore:   p.topology.CPUsPerCore(),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> cpuset, ok := s.GetCPUSet(<span class="type">string</span>(pod.UID), container.Name); ok &#123;</span><br><span class="line">p.updateCPUsToReuse(pod, container, cpuset)</span><br><span class="line">klog.InfoS(<span class="string">&quot;Static policy: container already present in state, skipping&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call Topology Manager to get the aligned socket affinity across all hint providers.</span></span><br><span class="line">hint := p.affinity.GetAffinity(<span class="type">string</span>(pod.UID), container.Name)</span><br><span class="line">klog.InfoS(<span class="string">&quot;Topology Affinity&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name, <span class="string">&quot;affinity&quot;</span>, hint)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocate CPUs according to the NUMA affinity contained in the hint.</span></span><br><span class="line">cpuset, err := p.allocateCPUs(s, numCPUs, hint.NUMANodeAffinity, p.cpusToReuse[<span class="type">string</span>(pod.UID)])</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">klog.ErrorS(err, <span class="string">&quot;Unable to allocate CPUs&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name, <span class="string">&quot;numCPUs&quot;</span>, numCPUs)</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">s.SetCPUSet(<span class="type">string</span>(pod.UID), container.Name, cpuset)</span><br><span class="line">p.updateCPUsToReuse(pod, container, cpuset)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// container belongs in the shared pool (nothing to do; use default cpuset)</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getAssignedCPUsOfSiblings returns assigned cpus of given container&#x27;s siblings(all containers other than the given container) in the given pod `podUID`.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getAssignedCPUsOfSiblings</span><span class="params">(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>)</span></span> cpuset.CPUSet &#123;</span><br><span class="line">assignments := s.GetCPUAssignments()</span><br><span class="line">cset := cpuset.NewCPUSet()</span><br><span class="line"><span class="keyword">for</span> name, cpus := <span class="keyword">range</span> assignments[podUID] &#123;</span><br><span class="line"><span class="keyword">if</span> containerName == name &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">cset = cset.Union(cpus)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cset</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">klog.InfoS(<span class="string">&quot;Static policy: RemoveContainer&quot;</span>, <span class="string">&quot;podUID&quot;</span>, podUID, <span class="string">&quot;containerName&quot;</span>, containerName)</span><br><span class="line">cpusInUse := getAssignedCPUsOfSiblings(s, podUID, containerName)</span><br><span class="line"><span class="keyword">if</span> toRelease, ok := s.GetCPUSet(podUID, containerName); ok &#123;</span><br><span class="line">s.Delete(podUID, containerName)</span><br><span class="line"><span class="comment">// Mutate the shared pool, adding released cpus.</span></span><br><span class="line">toRelease = toRelease.Difference(cpusInUse)</span><br><span class="line">s.SetDefaultCPUSet(s.GetDefaultCPUSet().Union(toRelease))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> allocateCPUs(s state.State, numCPUs <span class="type">int</span>, numaAffinity bitmask.BitMask, reusableCPUs cpuset.CPUSet) (cpuset.CPUSet, <span class="type">error</span>) &#123;</span><br><span class="line">klog.InfoS(<span class="string">&quot;AllocateCPUs&quot;</span>, <span class="string">&quot;numCPUs&quot;</span>, numCPUs, <span class="string">&quot;socket&quot;</span>, numaAffinity)</span><br><span class="line"></span><br><span class="line">allocatableCPUs := p.GetAllocatableCPUs(s).Union(reusableCPUs)</span><br><span class="line"></span><br><span class="line"><span class="comment">// If there are aligned CPUs in numaAffinity, attempt to take those first.</span></span><br><span class="line">result := cpuset.NewCPUSet()</span><br><span class="line"><span class="keyword">if</span> numaAffinity != <span class="literal">nil</span> &#123;</span><br><span class="line">alignedCPUs := p.getAlignedCPUs(numaAffinity, allocatableCPUs)</span><br><span class="line"></span><br><span class="line">numAlignedToAlloc := alignedCPUs.Size()</span><br><span class="line"><span class="keyword">if</span> numCPUs &lt; numAlignedToAlloc &#123;</span><br><span class="line">numAlignedToAlloc = numCPUs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">alignedCPUs, err := p.takeByTopology(alignedCPUs, numAlignedToAlloc)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> cpuset.NewCPUSet(), err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result = result.Union(alignedCPUs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get any remaining CPUs from what&#x27;s leftover after attempting to grab aligned ones.</span></span><br><span class="line">remainingCPUs, err := p.takeByTopology(allocatableCPUs.Difference(result), numCPUs-result.Size())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> cpuset.NewCPUSet(), err</span><br><span class="line">&#125;</span><br><span class="line">result = result.Union(remainingCPUs)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove allocated CPUs from the shared CPUSet.</span></span><br><span class="line">s.SetDefaultCPUSet(s.GetDefaultCPUSet().Difference(result))</span><br><span class="line"></span><br><span class="line">klog.InfoS(<span class="string">&quot;AllocateCPUs&quot;</span>, <span class="string">&quot;result&quot;</span>, result)</span><br><span class="line"><span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> guaranteedCPUs(pod *v1.Pod, container *v1.Container) <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">if</span> v1qos.GetPodQOS(pod) != v1.PodQOSGuaranteed &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">cpuQuantity := container.Resources.Requests[v1.ResourceCPU]</span><br><span class="line"><span class="keyword">if</span> cpuQuantity.Value()*<span class="number">1000</span> != cpuQuantity.MilliValue() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Safe downcast to do for all systems with &lt; 2.1 billion CPUs.</span></span><br><span class="line"><span class="comment">// Per the language spec, `int` is guaranteed to be at least 32 bits wide.</span></span><br><span class="line"><span class="comment">// https://golang.org/ref/spec#Numeric_types</span></span><br><span class="line"><span class="keyword">return</span> <span class="type">int</span>(cpuQuantity.Value())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> podGuaranteedCPUs(pod *v1.Pod) <span class="type">int</span> &#123;</span><br><span class="line"><span class="comment">// The maximum of requested CPUs by init containers.</span></span><br><span class="line">requestedByInitContainers := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.InitContainers &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := container.Resources.Requests[v1.ResourceCPU]; !ok &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">requestedCPU := p.guaranteedCPUs(pod, &amp;container)</span><br><span class="line"><span class="keyword">if</span> requestedCPU &gt; requestedByInitContainers &#123;</span><br><span class="line">requestedByInitContainers = requestedCPU</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// The sum of requested CPUs by app containers.</span></span><br><span class="line">requestedByAppContainers := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := container.Resources.Requests[v1.ResourceCPU]; !ok &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">requestedByAppContainers += p.guaranteedCPUs(pod, &amp;container)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> requestedByInitContainers &gt; requestedByAppContainers &#123;</span><br><span class="line"><span class="keyword">return</span> requestedByInitContainers</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> requestedByAppContainers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> takeByTopology(availableCPUs cpuset.CPUSet, numCPUs <span class="type">int</span>) (cpuset.CPUSet, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> p.options.DistributeCPUsAcrossNUMA &#123;</span><br><span class="line">cpuGroupSize := <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> p.options.FullPhysicalCPUsOnly &#123;</span><br><span class="line">cpuGroupSize = p.topology.CPUsPerCore()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> takeByTopologyNUMADistributed(p.topology, availableCPUs, numCPUs, cpuGroupSize)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> takeByTopologyNUMAPacked(p.topology, availableCPUs, numCPUs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint &#123;</span><br><span class="line"><span class="comment">// Get a count of how many guaranteed CPUs have been requested.</span></span><br><span class="line">requested := p.guaranteedCPUs(pod, container)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Number of required CPUs is not an integer or a container is not part of the Guaranteed QoS class.</span></span><br><span class="line"><span class="comment">// It will be treated by the TopologyManager as having no preference and cause it to ignore this</span></span><br><span class="line"><span class="comment">// resource when considering pod alignment.</span></span><br><span class="line"><span class="comment">// In terms of hints, this is equal to: TopologyHints[NUMANodeAffinity: nil, Preferred: true].</span></span><br><span class="line"><span class="keyword">if</span> requested == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Short circuit to regenerate the same hints if there are already</span></span><br><span class="line"><span class="comment">// guaranteed CPUs allocated to the Container. This might happen after a</span></span><br><span class="line"><span class="comment">// kubelet restart, for example.</span></span><br><span class="line"><span class="keyword">if</span> allocated, exists := s.GetCPUSet(<span class="type">string</span>(pod.UID), container.Name); exists &#123;</span><br><span class="line"><span class="keyword">if</span> allocated.Size() != requested &#123;</span><br><span class="line">klog.ErrorS(<span class="literal">nil</span>, <span class="string">&quot;CPUs already allocated to container with different number than request&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name, <span class="string">&quot;requestedSize&quot;</span>, requested, <span class="string">&quot;allocatedSize&quot;</span>, allocated.Size())</span><br><span class="line"><span class="comment">// An empty list of hints will be treated as a preference that cannot be satisfied.</span></span><br><span class="line"><span class="comment">// In definition of hints this is equal to: TopologyHint[NUMANodeAffinity: nil, Preferred: false].</span></span><br><span class="line"><span class="comment">// For all but the best-effort policy, the Topology Manager will throw a pod-admission error.</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint&#123;</span><br><span class="line"><span class="type">string</span>(v1.ResourceCPU): &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">klog.InfoS(<span class="string">&quot;Regenerating TopologyHints for CPUs already allocated&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name)</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint&#123;</span><br><span class="line"><span class="type">string</span>(v1.ResourceCPU): p.generateCPUTopologyHints(allocated, cpuset.CPUSet&#123;&#125;, requested),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a list of available CPUs.</span></span><br><span class="line">available := p.GetAllocatableCPUs(s)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a list of reusable CPUs (e.g. CPUs reused from initContainers).</span></span><br><span class="line"><span class="comment">// It should be an empty CPUSet for a newly created pod.</span></span><br><span class="line">reusable := p.cpusToReuse[<span class="type">string</span>(pod.UID)]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate hints.</span></span><br><span class="line">cpuHints := p.generateCPUTopologyHints(available, reusable, requested)</span><br><span class="line">klog.InfoS(<span class="string">&quot;TopologyHints generated&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name, <span class="string">&quot;cpuHints&quot;</span>, cpuHints)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint&#123;</span><br><span class="line"><span class="type">string</span>(v1.ResourceCPU): cpuHints,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint &#123;</span><br><span class="line"><span class="comment">// Get a count of how many guaranteed CPUs have been requested by Pod.</span></span><br><span class="line">requested := p.podGuaranteedCPUs(pod)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Number of required CPUs is not an integer or a pod is not part of the Guaranteed QoS class.</span></span><br><span class="line"><span class="comment">// It will be treated by the TopologyManager as having no preference and cause it to ignore this</span></span><br><span class="line"><span class="comment">// resource when considering pod alignment.</span></span><br><span class="line"><span class="comment">// In terms of hints, this is equal to: TopologyHints[NUMANodeAffinity: nil, Preferred: true].</span></span><br><span class="line"><span class="keyword">if</span> requested == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">assignedCPUs := cpuset.NewCPUSet()</span><br><span class="line"><span class="keyword">for</span> _, container := <span class="keyword">range</span> <span class="built_in">append</span>(pod.Spec.InitContainers, pod.Spec.Containers...) &#123;</span><br><span class="line">requestedByContainer := p.guaranteedCPUs(pod, &amp;container)</span><br><span class="line"><span class="comment">// Short circuit to regenerate the same hints if there are already</span></span><br><span class="line"><span class="comment">// guaranteed CPUs allocated to the Container. This might happen after a</span></span><br><span class="line"><span class="comment">// kubelet restart, for example.</span></span><br><span class="line"><span class="keyword">if</span> allocated, exists := s.GetCPUSet(<span class="type">string</span>(pod.UID), container.Name); exists &#123;</span><br><span class="line"><span class="keyword">if</span> allocated.Size() != requestedByContainer &#123;</span><br><span class="line">klog.ErrorS(<span class="literal">nil</span>, <span class="string">&quot;CPUs already allocated to container with different number than request&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;containerName&quot;</span>, container.Name, <span class="string">&quot;allocatedSize&quot;</span>, requested, <span class="string">&quot;requestedByContainer&quot;</span>, requestedByContainer, <span class="string">&quot;allocatedSize&quot;</span>, allocated.Size())</span><br><span class="line"><span class="comment">// An empty list of hints will be treated as a preference that cannot be satisfied.</span></span><br><span class="line"><span class="comment">// In definition of hints this is equal to: TopologyHint[NUMANodeAffinity: nil, Preferred: false].</span></span><br><span class="line"><span class="comment">// For all but the best-effort policy, the Topology Manager will throw a pod-admission error.</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint&#123;</span><br><span class="line"><span class="type">string</span>(v1.ResourceCPU): &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// A set of CPUs already assigned to containers in this pod</span></span><br><span class="line">assignedCPUs = assignedCPUs.Union(allocated)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> assignedCPUs.Size() == requested &#123;</span><br><span class="line">klog.InfoS(<span class="string">&quot;Regenerating TopologyHints for CPUs already allocated&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod))</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint&#123;</span><br><span class="line"><span class="type">string</span>(v1.ResourceCPU): p.generateCPUTopologyHints(assignedCPUs, cpuset.CPUSet&#123;&#125;, requested),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a list of available CPUs.</span></span><br><span class="line">available := p.GetAllocatableCPUs(s)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a list of reusable CPUs (e.g. CPUs reused from initContainers).</span></span><br><span class="line"><span class="comment">// It should be an empty CPUSet for a newly created pod.</span></span><br><span class="line">reusable := p.cpusToReuse[<span class="type">string</span>(pod.UID)]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ensure any CPUs already assigned to containers in this pod are included as part of the hint generation.</span></span><br><span class="line">reusable = reusable.Union(assignedCPUs)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate hints.</span></span><br><span class="line">cpuHints := p.generateCPUTopologyHints(available, reusable, requested)</span><br><span class="line">klog.InfoS(<span class="string">&quot;TopologyHints generated&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;cpuHints&quot;</span>, cpuHints)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint&#123;</span><br><span class="line"><span class="type">string</span>(v1.ResourceCPU): cpuHints,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// generateCPUtopologyHints generates a set of TopologyHints given the set of</span></span><br><span class="line"><span class="comment">// available CPUs and the number of CPUs being requested.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// It follows the convention of marking all hints that have the same number of</span></span><br><span class="line"><span class="comment">// bits set as the narrowest matching NUMANodeAffinity with &#x27;Preferred: true&#x27;, and</span></span><br><span class="line"><span class="comment">// marking all others with &#x27;Preferred: false&#x27;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> generateCPUTopologyHints(availableCPUs cpuset.CPUSet, reusableCPUs cpuset.CPUSet, request <span class="type">int</span>) []topologymanager.TopologyHint &#123;</span><br><span class="line"><span class="comment">// Initialize minAffinitySize to include all NUMA Nodes.</span></span><br><span class="line">minAffinitySize := p.topology.CPUDetails.NUMANodes().Size()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Iterate through all combinations of numa nodes bitmask and build hints from them.</span></span><br><span class="line">hints := []topologymanager.TopologyHint&#123;&#125;</span><br><span class="line">bitmask.IterateBitMasks(p.topology.CPUDetails.NUMANodes().ToSlice(), <span class="function"><span class="keyword">func</span><span class="params">(mask bitmask.BitMask)</span></span> &#123;</span><br><span class="line"><span class="comment">// First, update minAffinitySize for the current request size.</span></span><br><span class="line">cpusInMask := p.topology.CPUDetails.CPUsInNUMANodes(mask.GetBits()...).Size()</span><br><span class="line"><span class="keyword">if</span> cpusInMask &gt;= request &amp;&amp; mask.Count() &lt; minAffinitySize &#123;</span><br><span class="line">minAffinitySize = mask.Count()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Then check to see if we have enough CPUs available on the current</span></span><br><span class="line"><span class="comment">// numa node bitmask to satisfy the CPU request.</span></span><br><span class="line">numMatching := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _, c := <span class="keyword">range</span> reusableCPUs.ToSlice() &#123;</span><br><span class="line"><span class="comment">// Disregard this mask if its NUMANode isn&#x27;t part of it.</span></span><br><span class="line"><span class="keyword">if</span> !mask.IsSet(p.topology.CPUDetails[c].NUMANodeID) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">numMatching++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, check to see if enough available CPUs remain on the current</span></span><br><span class="line"><span class="comment">// NUMA node combination to satisfy the CPU request.</span></span><br><span class="line"><span class="keyword">for</span> _, c := <span class="keyword">range</span> availableCPUs.ToSlice() &#123;</span><br><span class="line"><span class="keyword">if</span> mask.IsSet(p.topology.CPUDetails[c].NUMANodeID) &#123;</span><br><span class="line">numMatching++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If they don&#x27;t, then move onto the next combination.</span></span><br><span class="line"><span class="keyword">if</span> numMatching &lt; request &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Otherwise, create a new hint from the numa node bitmask and add it to the</span></span><br><span class="line"><span class="comment">// list of hints.  We set all hint preferences to &#x27;false&#x27; on the first</span></span><br><span class="line"><span class="comment">// pass through.</span></span><br><span class="line">hints = <span class="built_in">append</span>(hints, topologymanager.TopologyHint&#123;</span><br><span class="line">NUMANodeAffinity: mask,</span><br><span class="line">Preferred:        <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop back through all hints and update the &#x27;Preferred&#x27; field based on</span></span><br><span class="line"><span class="comment">// counting the number of bits sets in the affinity mask and comparing it</span></span><br><span class="line"><span class="comment">// to the minAffinitySize. Only those with an equal number of bits set (and</span></span><br><span class="line"><span class="comment">// with a minimal set of numa nodes) will be considered preferred.</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> hints &#123;</span><br><span class="line"><span class="keyword">if</span> p.options.AlignBySocket &amp;&amp; p.isHintSocketAligned(hints[i], minAffinitySize) &#123;</span><br><span class="line">hints[i].Preferred = <span class="literal">true</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> hints[i].NUMANodeAffinity.Count() == minAffinitySize &#123;</span><br><span class="line">hints[i].Preferred = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> hints</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// isHintSocketAligned function return true if numa nodes in hint are socket aligned.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> isHintSocketAligned(hint topologymanager.TopologyHint, minAffinitySize <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line">numaNodesBitMask := hint.NUMANodeAffinity.GetBits()</span><br><span class="line">numaNodesPerSocket := p.topology.NumNUMANodes / p.topology.NumSockets</span><br><span class="line"><span class="keyword">if</span> numaNodesPerSocket == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// minSockets refers to minimum number of socket required to satify allocation.</span></span><br><span class="line"><span class="comment">// A hint is considered socket aligned if sockets across which numa nodes span is equal to minSockets</span></span><br><span class="line">minSockets := (minAffinitySize + numaNodesPerSocket - <span class="number">1</span>) / numaNodesPerSocket</span><br><span class="line"><span class="keyword">return</span> p.topology.CPUDetails.SocketsInNUMANodes(numaNodesBitMask...).Size() == minSockets</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getAlignedCPUs return set of aligned CPUs based on numa affinity mask and configured policy options.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> getAlignedCPUs(numaAffinity bitmask.BitMask, allocatableCPUs cpuset.CPUSet) cpuset.CPUSet &#123;</span><br><span class="line">alignedCPUs := cpuset.NewCPUSet()</span><br><span class="line">numaBits := numaAffinity.GetBits()</span><br><span class="line"></span><br><span class="line"><span class="comment">// If align-by-socket policy option is enabled, NUMA based hint is expanded to</span></span><br><span class="line"><span class="comment">// socket aligned hint. It will ensure that first socket aligned available CPUs are</span></span><br><span class="line"><span class="comment">// allocated before we try to find CPUs across socket to satisfy allocation request.</span></span><br><span class="line"><span class="keyword">if</span> p.options.AlignBySocket &#123;</span><br><span class="line">socketBits := p.topology.CPUDetails.SocketsInNUMANodes(numaBits...).ToSliceNoSort()</span><br><span class="line"><span class="keyword">for</span> _, socketID := <span class="keyword">range</span> socketBits &#123;</span><br><span class="line">alignedCPUs = alignedCPUs.Union(allocatableCPUs.Intersection(p.topology.CPUDetails.CPUsInSockets(socketID)))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> alignedCPUs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, numaNodeID := <span class="keyword">range</span> numaBits &#123;</span><br><span class="line">alignedCPUs = alignedCPUs.Union(allocatableCPUs.Intersection(p.topology.CPUDetails.CPUsInNUMANodes(numaNodeID)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> alignedCPUs</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_static.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ContainerCPUAssignments type used in cpu manager state</span></span><br><span class="line"><span class="keyword">type</span> ContainerCPUAssignments <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clone returns a copy of ContainerCPUAssignments</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(as ContainerCPUAssignments)</span></span> Clone() ContainerCPUAssignments &#123;</span><br><span class="line">ret := <span class="built_in">make</span>(ContainerCPUAssignments)</span><br><span class="line"><span class="keyword">for</span> pod := <span class="keyword">range</span> as &#123;</span><br><span class="line">ret[pod] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet)</span><br><span class="line"><span class="keyword">for</span> container, cset := <span class="keyword">range</span> as[pod] &#123;</span><br><span class="line">ret[pod][container] = cset</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reader interface used to read current cpu/pod assignment state</span></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">GetCPUSet(podUID <span class="type">string</span>, containerName <span class="type">string</span>) (cpuset.CPUSet, <span class="type">bool</span>)</span><br><span class="line">GetDefaultCPUSet() cpuset.CPUSet</span><br><span class="line">GetCPUSetOrDefault(podUID <span class="type">string</span>, containerName <span class="type">string</span>) cpuset.CPUSet</span><br><span class="line">GetCPUAssignments() ContainerCPUAssignments</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> writer <span class="keyword">interface</span> &#123;</span><br><span class="line">SetCPUSet(podUID <span class="type">string</span>, containerName <span class="type">string</span>, cpuset cpuset.CPUSet)</span><br><span class="line">SetDefaultCPUSet(cpuset cpuset.CPUSet)</span><br><span class="line">SetCPUAssignments(ContainerCPUAssignments)</span><br><span class="line">Delete(podUID <span class="type">string</span>, containerName <span class="type">string</span>)</span><br><span class="line">ClearState()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// State interface provides methods for tracking and setting cpu/pod assignment</span></span><br><span class="line"><span class="keyword">type</span> State <span class="keyword">interface</span> &#123;</span><br><span class="line">Reader</span><br><span class="line">writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上是static-policy的策略的具体实现，分析一下其中主要的具体方法：</p><ul><li><p>**validateState(s state.State) **方法:  </p><p>state数据结构可以理解为cpu-policy的缓存，缓存了具体的cpu绑定的情况和现存的剩余cpu情况，state接口分别包含了<strong>Reader</strong>和<strong>Writer</strong>两个接口，需要实现<strong>GetCPUSet</strong>和<strong>SetCPUSet</strong>等方法。</p><p>首先会通过缓存方法<strong>s.GetCPUAssignments</strong>获取当前cpu的分配情况，通过<strong>s.GetDefaultCPUSet</strong>获取当前default的cpuset（pod在去除reserved的情况下，再去除单独绑核的cpu后剩余的cpu集合）</p><p>当tmpDefaultCPUset为空时，即首次初始化时，会通过**topology.CPUDetails.CPUs()**方法获取节点所有的CPU，并且存入缓存设置为DefaultCPUSet</p><p>当tmpDefaultCPUset缓存不为空时，会校验两种情况，</p><p>1.校验reserved的cpuset不在default中</p><p>2.校验已分配的cpu不在剩余的defaultcpu池中</p><p>3.校验实际可用的CPUs和缓存对比是否发生变化（比如说下线了一个cpu，同时kubelet没有在正常工作），获取到缓存中的DefaultCPUs和计算出已分配的cpu合计，使用<strong>unionall</strong>方法和新使用**topology.CPUDetails.CPUs()**获取的cpu进行对比，是否相同</p></li><li><p>**GetAllocatableCPUs (s state.State)**方法:</p><p>从缓存中获取default-cpus除去reserved-cpus以外的cpus，设置为可分配cpu</p></li><li><p>**Allocate(s state.State, pod *v1.Pod, container *v1.Container)**方法：</p><p>核心方法用于分配CPU,首先会分为两种情况判断pod的类型：</p><p>1.首先使用p.guaranteedCPUs判断是否是Guaranteed类型的pod，并且获取所需要的cpu核数，（需要是整数）当pod是Guaranteed类型时，表明pod有独占CPU核的需求。然后从缓存中获取信息，查看该pod是否已经创建，并分配了cpu，如果存在，仅需要<strong>p.updateCPUToReuse()<strong>进行更新。如果是新创建的pod，需要绑核操作，使用</strong>p.affinity.GetAffinity()<strong>方法获取亲和性拓扑关系，然后根据numa亲和性进行分配使用</strong>p.allocateCPUs()<strong>方法，最后使用</strong>setCPUSet</strong>更新缓存，最后调用**p.updateCPUToReuse()**更新实际的cpu</p><p>2.如果不是Guaranteed类型的pod，则会不作处理，直接使用default cpuset</p></li><li><p>**allocateCPUs(s state.State, numCPUs int, numaAffinity bitmask.BitMask, reusableCPUs cpuset.CPUSet)**方法：</p><p>首先调用**p.GetAllocatableCPUs(s).Union(reusableCPUs)**获取可供分配的cpu，如果根据numaAffinity有匹配一致的cpu，优先使用这些cpu。分为两种情况：</p><p>1.当存在numaAffinity时，根据具体的cpuID和numaNode的对应关系得出具体的cpu</p><p>2.当不存在numaAffinity时，直接根据<strong>takeByTopology</strong>方法获取剩余的cpus</p><p>之后将亲和性策略计算出的结果，与默认的defaultcpuset区分开，并且返回亲和性结果的cpuset</p></li><li><p>**GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container)**方法：</p><p>首先确定pod属于Guaranteed Pod的类型，获取所需cpu核数<strong>request</strong>，然后从缓存中对比，该pod是否已分配cpu，如果已分配的cpu和计算出所需核数<strong>request</strong>不同，则返回拓扑亲和性结果为空，如果核数和分配数相同，则调用<strong>p.generateCPUTopologyHints</strong>方法计算亲和性。如果该pod是初次分配cpu，不存在缓存的情况，则通过扣除缓存<strong>p.GetAllocatableCPUs(s)<strong>计算出可用的cpu <strong>available</strong>，再通过</strong>p.generateCPUTopologyHints</strong>计算出亲和性</p></li><li><p>**GetPodTopologyHints(s state.State, pod *v1.Pod)**方法：</p><p>同样首先会确认pod是否属于Guaranteed类型，然后遍历pod中所有的容器，包括initContainer,通过方法<strong>assignedCPUs.Union(allocated)<strong>计算出所有已分配的container所需的cpu核数：</strong>assignedCPUs</strong> 。同<strong>GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container)<strong>方法一样，获取所需cpu核数</strong>request**，然后从缓存中对比，该pod是否已分配cpu，如果已分配的cpu和计算出所需核数</strong>request<strong>不同，则返回拓扑亲和性结果为空，如果核数和分配数相同，则调用</strong>p.generateCPUTopologyHints**方法计算亲和性。</p></li></ul><p>pkg&#x2F;kubelet&#x2F;kubelet.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> initializeRuntimeDependentModules() &#123;</span><br><span class="line"><span class="keyword">if</span> err := kl.cadvisor.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Fail kubelet and rely on the babysitter to retry starting kubelet.</span></span><br><span class="line">klog.ErrorS(err, <span class="string">&quot;Failed to start cAdvisor&quot;</span>)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  .........</span><br><span class="line"><span class="comment">// containerManager must start after cAdvisor because it needs filesystem capacity information</span></span><br><span class="line"><span class="keyword">if</span> err := kl.containerManager.Start(node, kl.GetActivePods, kl.sourcesReady, kl.statusManager, kl.runtimeService); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Fail kubelet and rely on the babysitter to retry starting kubelet.</span></span><br><span class="line">klog.ErrorS(err, <span class="string">&quot;Failed to start ContainerManager&quot;</span>)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.........</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pkg&#x2F;kubelet&#x2F;cm&#x2F;container_manager_linux.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cm *containerManagerImpl)</span></span> Start(node *v1.Node,</span><br><span class="line">runtimeService internalapi.RuntimeService) <span class="type">error</span> &#123;</span><br><span class="line">······</span><br><span class="line"><span class="comment">// Initialize CPU manager</span></span><br><span class="line"><span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(kubefeatures.CPUManager) &#123;</span><br><span class="line">containerMap, err := buildContainerMapFromRuntime(runtimeService)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to build map of initial containers from runtime: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">err = cm.cpuManager.Start(cpumanager.ActivePodsFunc(activePods), sourcesReady, podStatusProvider, runtimeService, containerMap)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;start cpu manager error: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">·········</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体调用逻辑：在Kubelet方法<strong>initializeRuntimeDependentModule</strong>s中调用ContainerManager的<strong>Start</strong>方法，具体实现是container_manager_linux.go的<strong>Start</strong>方法:与cpu相关的就是<strong>cm.cpuManager.Start</strong></p><h3 id="相关功能改进"><a href="#相关功能改进" class="headerlink" title="相关功能改进"></a>相关功能改进</h3><p>有上述源码分析可以看出，Kubelet原生的cpumanager将节点的cpu资源做了以下的划分，在启用static模式和reservedCpus的情况下，kubelet会将cpu全部放入DefaultCpuSet，以下图为例：该节点的总CPU核数为8个，默认为0-7.其中reserved预留了0-5核，因此Guaranteed类型的Pod的只能绑核在6，7两个核上</p><p>defaultCPUSet&#x3D; reservedCPU+guaranteedCPU</p><p><img src="/image/KubeletCPU/defaultCPU.png" alt="header"></p><p>在此种情况下，非Guarantee类型的Pod不受约束仍会调度到0-5核上，并没有起到绝对隔离的作用。因此EKI修改了了cpu管理的策略，变成了以下模型</p><p><img src="/image/KubeletCPU/defaultNonCPU.png" alt="header"></p><p><img src="/image/KubeletCPU/cpustate.png" alt="header"></p><p><img src="/image/KubeletCPU/kubeletConfig.png" alt="header"></p><p>该功能添加了kubelet的新启动参数—defaultNonGuaranteeSystemCPUs，用于表示非Guaranteed类型的POD进行范围绑核调度，与系统reserved的资源进行强隔离，保证了隔离资源不会被容器进程占用，公式修改为: defaultCPUSet&#x3D; reservedCPU+guarantendCPU+nonGuaranteedCPU</p><h3 id="缺陷和改进"><a href="#缺陷和改进" class="headerlink" title="缺陷和改进"></a>缺陷和改进</h3><h4 id="缺陷部分"><a href="#缺陷部分" class="headerlink" title="缺陷部分"></a>缺陷部分</h4><p>1.该参数仅能适用于范围绑核的情况，并不能对容器的cpu进行指定绑核，例如并不能指定容器绑核绑定在cpu3上。</p><ol start="2"><li>开启该参数后，应合理规划default池的大小，因为所有的非Guaranteed类型的pod都会分配在该cpuset中，要根据集群规模，pod数量进行合理分配，否则pod会抢占cpu，根据cfs调度规则，分配到各个pod（即各个进程的cpu使用时间会发生冲突，导致进程不可用）</li></ol><p>3.开启该参数后，再关闭该参数，需要手动释放kubelet-cpu相关缓存，否则会造成cpu-overlap，导致kubelet不可用，具体删&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;cpu_manager_state。（默认部署Kubernetes的情况）</p><p>4.启用该特性后，现有pod需要重启，才能重新分配cpu，才可以生效。（线上生产环境业务会中断，谨慎操作）</p><p>5.对Kubernetes源生代码进行了修改，并没有以插件化的形式注入，不利用后续Kubernetes版本的升级和维护</p><h4 id="后续可改进部分"><a href="#后续可改进部分" class="headerlink" title="后续可改进部分"></a>后续可改进部分</h4><p>1.可以扩展CPUManger，防止同一个物理核的虚拟分配带来干扰，比如说一个容器申请了5个独占虚拟核，cpu0-4都分配了，那么cpu5应该也要被锁定，不能分配给其他工作负载使用。</p><p><img src="/image/KubeletCPU/cpubingding.png" alt="header"></p><p>2.避免修改Kubernetes源码，已无侵入，插件化的方式进行cpu的调度，参考kube-scheduler的调度流程，用extender-scheduler实现cpu绑核的功能和cpu池化功能</p><p>3.或者可以将cpu绑定的插件下放至runtime，以插件化的形式绑定在CRI中</p><p>​</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NVIDIA共享GPU方案</title>
      <link href="/posts/65526.html"/>
      <url>/posts/65526.html</url>
      
        <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>NVIDIA GPU硬件结合CUDA软件，提供了多重并发机制，以此来提高GPU的利用率。分别是从软件层面和硬件层面，包括CUDA流，time slice时间切片(compute preemption)，MPS(Multi-Process with CUDA)m,MIG(Multi-Instance GPU), VGPU(virtualization GPU)   </p><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p>CUDA是一个通用的并行计算平台和编程模型，利用NVIDIA GPU中的并行计算引擎来解决许多复杂的计算问题，相比在CPU上效率更高。从一个CUDA程序从为特定GPU创建一个CUDA上下文开始，上下文既可以通过驱动程序API显式地创建，也可以通过运行时API隐式地创建。上下文封装了程序所需的所有硬件资源，使程序能够管理内存并使用特定GPU</p><p>在GPU上的计算流程通常涉及将数据复制到先前分配的GPU内存区域中，运行一个CUDA核函数操作该数据，然后将结果从GPU内存复制回系统内存。CUDA核函数由一组线程组成，这些线程在GPU的计算引擎上并行执行</p><p>使用CUDA启动的GPU上的所有任务都是显式地启动到一个CUDA流中，或者隐式地使用默认流启动。流是一个软件抽象，代表一系列命令，这些命令可以是内核、复制和其他命令的组合，按顺序执行。在两个不同的流中启动的工作可以同时执行，从而实现了粗粒度的并行</p><p>CUDA流是由驱动程序别名定义到GPU上的一个或多个工作队列。工作队列是代表流中要由GPU上的特定引擎执行的命令子集的硬件资源，例如内核执行或内存复制。具有Hyper-Q的GPU具有并发调度器，用于调度属于单个CUDA上下文的工作队列中的工作。从属于同一CUDA上下文的工作队列启动到计算引擎的工作可以在GPU上并行执行</p><p>GPU还有一个时间切片调度器，用于调度属于不同CUDA上下文的工作队列中的工作。从不同CUDA上下文的工作队列启动到计算引擎的工作不能同时执行。如果从单个CUDA上下文启动的工作不足以使用其可用资源，这可能会导致GPU的计算资源被低效利用。</p><p><img src="/image/GPUShare/CS.png" alt="header"></p><p>该图表显示了在没有MPS的情况下运行由多个操作系统进程组成的MPI应用程序时，CUDA核函数的可能调度情况。请注意，虽然每个MPI进程内部的CUDA核函数可能会同时调度，但每个MPI进程在整个GPU上被分配了一个串行调度的时间片</p><h2 id="cuda流"><a href="#cuda流" class="headerlink" title="cuda流"></a>cuda流</h2><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>对于gpu应用，可以通过cuda流（Stream）来管理对应的并发操作。流是指按顺序执行的命令序列（可能从属于不同的主机进程）。但是不同的流之间可以并发性乱序的执行自己想对应的命令，因为执行的不确定性，导致执行的结果的正确性不可控制。在所有命令的依赖项满足时，流上配置的命令可以执行，依赖项即可以是同一流的前置命令，也可以是其他不同流的命令。</p><h4 id="流的创建与销毁"><a href="#流的创建与销毁" class="headerlink" title="流的创建与销毁"></a>流的创建与销毁</h4><p>一个流的定义包含了以下操作，通过创建流对象，并将其这个对象指定为内核启动和主机&lt;-&gt;设备内存拷贝的序列中的参数，以下的示例代码会创建两个流，并且在页锁定内存中分配一个float类型的数组hostPtr</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cudaStream_t stream[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaStreamCreate</span>(&amp;stream[i]);</span><br><span class="line"><span class="type">float</span>* hostPtr;</span><br><span class="line"><span class="built_in">cudaMallocHost</span>(&amp;hostPtr, <span class="number">2</span> * size);</span><br></pre></td></tr></table></figure><p>以下的示例代码包含了，每个流包含了以下操作序列：从主机到设备的内存拷贝，一次内核启动，以及从设备到主机的内存拷贝。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(inputDevPtr + i * size, hostPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line">    MyKernel &lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;</span><br><span class="line">          (outputDevPtr + i * size, inputDevPtr + i * size, size);</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr + i * size, outputDevPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每个流将输入数组hostPtr的部分复制到设备内存中的数组inputDevPtr，通过调用Mykernel()方法在设备上处理inputDevPtr，处理结果为outputDevPtr,最后将结过outputDevPtr复制回hostPtr的相同部分。重叠行为是指流和流之间的重叠，在本次示例代码中，重叠部分就是指涉及到设备相关的，本例中使用了页锁定内存来存储hostPtr数组避免了overlap。</p><p>流的销毁和释放需要调用方法<code>cudaStreamDestroy()</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaStreamDestroy</span>(stream[i]);</span><br></pre></td></tr></table></figure><h4 id="默认流"><a href="#默认流" class="headerlink" title="默认流"></a>默认流</h4><p>如果内核启动或者主机&lt;-&gt;设备的内存拷贝的操作，没有指定任何的流作为参数，或者将流参数设置为0，则表示将使用默认流来操作，因此这些操作都是顺序执行的。</p><p>默认流是一个常规流，每个主机线程都有自己的默认流，对于编译的代码中使用<code>--default-stream per-thread</code> 或者在包含cuda.h和cuda_runtime.h的头文件中定义CUDA_API_PER_THREAD_DEFAULT_STREAM宏，都使用的是默认流。</p><p>对于使用<code>--default-stream</code>legacy标志编译的代码，默认流是一个特殊的流，被称之为NULL流，每个设备都有一个用于处理主机线程的NULL流。NULL流比较特殊，因为他会导致隐式同步。</p><h4 id="显示同步（Explicit-Synchronization）"><a href="#显示同步（Explicit-Synchronization）" class="headerlink" title="显示同步（Explicit Synchronization）"></a>显示同步（Explicit Synchronization）</h4><p>以下举例的是流之间多种的显示同步方法:</p><p><code>cudaDeviceSynchronize()</code> 等待所有主机线程的所有流中的所有前序命令完成</p><p><code>cudaStreamSynchronize()</code> 将流作为参数并且等待执行，直到给定流中的所有前序命令完成。该方法可以用来同步主机与特定的流，允许其他流在设备上执行</p><p><code>cudaStreamWaitEvent()</code> 将一个流和一个事件作为参数，并调用<code>cudaStreamWaitEvent()</code> 方法使得特定流的所有的命令都延迟执行，直到给定的所有事件完成后，才继续执行</p><p><code>cudaStreamQuery()</code> 给应用程序提供方法，用于感知流中的前置命令是否都已经完成了</p><h4 id="隐式同步（Implicit-Synchronization）"><a href="#隐式同步（Implicit-Synchronization）" class="headerlink" title="隐式同步（Implicit Synchronization）"></a>隐式同步（Implicit Synchronization）</h4><p>如果主机线程满足以下情况，那么来自不同流的两个命令不可以并发运行:</p><p>1.页锁定内存的分配</p><p>2.设备内存的分配</p><p>3.设备存储集</p><p>4.同一个设备内存中两个地址间的内存拷贝</p><p>5.任何在NULL流上执行的cuda命令</p><p>6.L1&#x2F;共享内存配置之间的切换（在Compute Capability 7.x支持）</p><p>需要依赖性检查的的操作，其中包括了与被检查的同一流上的启动操作和其他任意调用<code>cudaStreamQuery()</code> 的操作，遵循以下规则：</p><p>1.所有独立操作都需要在从属操作之前发出</p><p>2.任何类型的同步操作都应当尽可能延迟</p><h4 id="重叠行为（Overlapping-behavior）"><a href="#重叠行为（Overlapping-behavior）" class="headerlink" title="重叠行为（Overlapping behavior）"></a>重叠行为（Overlapping behavior）</h4><p>两个流之间重叠量取决于,每个流发出命令的顺序以及设备是否支持重叠的数据传输以及内核执行系统调用，以及并发的内核执行或者并发的数据传输</p><h5 id="数据传输和内核执行的重叠（Overlap-of-Data-Transfer-and-Kernel-Execution）"><a href="#数据传输和内核执行的重叠（Overlap-of-Data-Transfer-and-Kernel-Execution）" class="headerlink" title="数据传输和内核执行的重叠（Overlap of Data Transfer and Kernel Execution）"></a>数据传输和内核执行的重叠（Overlap of Data Transfer and Kernel Execution）</h5><p>一些设备可以在内核执行系统调用时，可以异步的从GPU或者向GPU复制内存的操作。应用程序可以通过<code>asyncEngineCount</code> 来检查设备的属性，来确定设备是支持该功能，值大于0时，表示该设备支持。如果涉及到主机内存的拷贝操作，那必须是锁定页面的内存。</p><p>当设备支持<code>concurrentKernels</code> 特性时，可以在内核执行的同时，进行设备内复制,当设备支持<code>asyncEngineCount</code> 特性时，可以在内核执行的同时，也可以从设备进行复制。设备内复制是通过标准的内存复制函数发起的，其目的地址和源地址都是位于同一设备</p><h5 id="并发内核执行（Concurrent-Kernel-Execution）"><a href="#并发内核执行（Concurrent-Kernel-Execution）" class="headerlink" title="并发内核执行（Concurrent Kernel Execution）"></a>并发内核执行（Concurrent Kernel Execution）</h5><p>部分设备的计算能力支持2.X及以上版本，可以并发的执行多个内核。应用可以通过<code>concurrentKernels </code> 来检查设备的属性，支持该功能的设备，该属性的值等于1</p><p>一个设备可以并发执行的最大内核启动数取决于它的计算能力，如下表所示。</p><table><thead><tr><th>Technical Specifications</th><th>5.0</th><th>5.2</th><th>5.3</th><th>6.0</th><th>6.1</th><th>6.2</th><th>7.0</th><th>7.2</th><th>7.5</th><th>8.0</th><th>8.6</th><th>8.7</th><th>8.9</th><th>9.0</th></tr></thead><tbody><tr><td>Maximum number of resident grids per device (Concurrent Kernel Execution)</td><td>32</td><td>32</td><td>16</td><td>128</td><td>32</td><td>16</td><td>128</td><td>16</td><td>128</td><td>128</td><td>128</td><td>128</td><td>128</td><td>128</td></tr></tbody></table><p>来自一个CUDA的上下文的内核不能与另一个CUDA上下文的内核并发执行，GPU可以进行时间切片，为每个上下文提供forward progress。如果用户希望在SM上同时运行来自多个进程的内核，必须开启MPS。</p><p>内核大量使用纹理内存或者使用大量的本地内存的话，该内核就不太能和其他内核并发执行。</p><h5 id="并发数据传输（Concurrent-Data-Transfers）"><a href="#并发数据传输（Concurrent-Data-Transfers）" class="headerlink" title="并发数据传输（Concurrent Data Transfers）"></a>并发数据传输（Concurrent Data Transfers）</h5><p>部分设备的计算能力支持2.X及以上版本，可以重叠设备的拷贝，应用可以通过<code>asyncEngineCount</code>来检查设备的属性，是否支持该功能，为了能够实现重叠拷贝，涉及到的传输的任意主机内存必须是页锁定的。</p><p>例如，在不支持并发数据传输的设备上，create和destruction的示例代码的两个流并不会发生重叠行为，因为从主机到设备的内存拷贝，是将设备到主机的内存拷贝发送到stream[0]之后，才发送到stream[1]的。</p><p>以下的示例代码，在支持并发数据传输的设备上，两个流确实会发生重叠，从主机到设备的内存拷贝的操作发送到stream[1]流上与从设备到主机的内存拷贝拷贝操作发送到stream[0]以及与发送到stream[0]的内核启动操作都有可能发生重叠</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(inputDevPtr + i * size, hostPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    MyKernel&lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;</span><br><span class="line">          (outputDevPtr + i * size, inputDevPtr + i * size, size);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr + i * size, outputDevPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(inputDevPtr + i * size, hostPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line">    MyKernel &lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;</span><br><span class="line">          (outputDevPtr + i * size, inputDevPtr + i * size, size);</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr + i * size, outputDevPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="主机函数（回调函数-Host-Functions-CallBacks）"><a href="#主机函数（回调函数-Host-Functions-CallBacks）" class="headerlink" title="主机函数（回调函数 Host Functions CallBacks）"></a>主机函数（回调函数 Host Functions CallBacks）</h5><p>运行时通过<code>cudaLaunchHostFunc()</code>函数提供了可以在流中任意节点插入CPU函数调用的能力，一旦在回调之前，流上所有的命令都执行完成了，那么提供的函数就会在主机上执行。</p><p>以下示例代码将主机到设备的内存拷贝，内核启动，设备到主机的内存拷贝发送到每个流之后，还将主机<code>MyCallback</code> 函数添加到了两个流中，该主机函数会在每个设备到主机的内存拷贝完成后在主机上开始执行。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> CUDART_CB <span class="title">MyCallback</span><span class="params">(<span class="type">void</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Inside callback %d\n&quot;</span>, (<span class="type">size_t</span>)data);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(devPtrIn[i], hostPtr[i], size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line">    MyKernel&lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;(devPtrOut[i], devPtrIn[i], size);</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr[i], devPtrOut[i], size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line">    <span class="built_in">cudaLaunchHostFunc</span>(stream[i], MyCallback, (<span class="type">void</span>*)i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在主机函数完成之前，流中发出的命令不会开始执行，当一个主机函数添加到流中，该函数不能调用CUDA API（无论是直接或者间接的调用），因为有可能会导致死锁，因为他会等到自己完成后才开始执行。</p><h5 id="流优先级"><a href="#流优先级" class="headerlink" title="流优先级"></a>流优先级</h5><p>流的优先级可以在创建时使用<code>cudaStreamCreateWithPriority（）</code> 这个函数指定，在可允许的优先级范围（按照从高到低的顺序）可以通过<code>cudaDeviceGetStreamPriorityRange()</code> 函数获取。在运行时侧处理时，高优先级的流中待处理的工作会优先于低优先级的流中的任务。</p><p>以下的示例代码首先获取了当前设备的可允许的优先级范围，并创建对应最高和最低的可用的优先级的流</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the range of stream priorities for this device</span></span><br><span class="line"><span class="type">int</span> priority_high, priority_low;</span><br><span class="line"><span class="built_in">cudaDeviceGetStreamPriorityRange</span>(&amp;priority_low, &amp;priority_high);</span><br><span class="line"><span class="comment">// create streams with highest and lowest available priorities</span></span><br><span class="line">cudaStream_t st_high, st_low;</span><br><span class="line"><span class="built_in">cudaStreamCreateWithPriority</span>(&amp;st_high, cudaStreamNonBlocking, priority_high);</span><br><span class="line"><span class="built_in">cudaStreamCreateWithPriority</span>(&amp;st_low, cudaStreamNonBlocking, priority_low);</span><br></pre></td></tr></table></figure><h3 id="时间分片（Compute-Preemption）"><a href="#时间分片（Compute-Preemption）" class="headerlink" title="时间分片（Compute Preemption）"></a>时间分片（Compute Preemption）</h3><h4 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h4><p>在处理多个 CUDA 应用程序时，每个应用程序都可能没有充分利用 GPU 的资源，可以使用简单的超额订阅策略来利用 GPU 的时间切片调度器。从 Pascal 体系结构开始 支持这一点。这种技术有时被称为暂时 GPU 共享，在不同的 CUDA 应用程序之间切换上下文确实会带来成本，但一些未充分利用的应用程序仍然可以从该策略中受益。</p><h4 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h4><p>计算抢占（compute preemption）是GP100特有的新功能，计算抢占允许以指令级别的粒度中断正在GPU运行的计算任务。执行上下文（包括寄存器，共享内存等等）被交换到GPU的DRAM（Dynamic random-access memory），以便另一个应用程序可以替换进当前上下文并开始进行他的计算任务。抢占计算提供以下两个主要的优势:</p><ul><li>长时间运行的内核不再需要被分割成小的时间片段，避免当GPU同时用于计算和图形化时出现未响应的GUI和内核超时的情况。</li><li>可以在单GPU的系统环境进行交互式内核调试</li></ul><h3 id="MPS-Multi-Process-Service"><a href="#MPS-Multi-Process-Service" class="headerlink" title="MPS(Multi-Process Service)"></a>MPS(Multi-Process Service)</h3><h4 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h4><p>MPS是CUDA API的另一种与二进制兼容的实现，MPS运行时架构的目的是透明化地协同启动多进程的CUDA应用，一般来说比如说是MPI作业任务。利用NVIDIA（Kepler以后）的GPU上的Hyper-Q能力，Hyper-Q允许CUDA内核在同一GPU上并发处理。特别是GPU的计算能力对于单个应用程序过剩时，可以提供GPU的利用。</p><p><img src="/image/GPUShare/mps-cs.png" alt="header"></p><p>使用Volta之前版本的GPU MPS时，服务器管理与单个CUDA上下文相关联的硬件资源。属于MPS客户端的CUDA上下文通过MPS服务器传输它们的工作。这使得客户端CUDA上下文能够绕过与时间切片调度相关的硬件限制，并允许它们的CUDA核函数同时执行</p><p>Volta后版本的GPU提供了新的硬件功能，以减少MPS服务器必须管理的硬件资源类型。在Volta-MPS上，客户端CUDA上下文管理大多数硬件资源，并直接向硬件提交工作。Volta MPS服务器调解了需要确保单个客户端提交的工作同时调度所需的其余共享资源，并避开了关键的执行路径。</p><p>MPS客户端与MPS服务器之间的通信完全封装在CUDA API背后的CUDA驱动程序中。因此，对MPI程序来说，MPS是透明的。MPS客户端CUDA上下文保留其上调处理程序线程和任何异步执行器线程。MPS服务器为每个客户端创建一个额外的上调处理程序线程，并为每个客户端创建一个工作线程。</p><h4 id="Volta-MPS"><a href="#Volta-MPS" class="headerlink" title="Volta MPS"></a>Volta MPS</h4><p>Volta架构引入了新的MPS功能（V100即是Volta架构下的显卡），与之前架构的GPU的MPS功能相比，Volta架构下的MPS在以下方面有了关键的提升</p><ul><li>Volta MPS客户端会直接将任务提交给GPU去执行，不需要经过MPS的服务端</li><li>每个Volta MPS客户端会配置自己的GPU地址空间而不是像老板的MPS客户端共享GPU地址空间</li><li>Volta MPS支持资源限制的配置，支持QoS</li></ul><p><img src="/image/GPUShare/VoltaMPS.png" alt="header"></p><h4 id="MPS结构"><a href="#MPS结构" class="headerlink" title="MPS结构"></a>MPS结构</h4><p>MPS是由以下几个组件组成的一个对于CUDA API的CS架构的二进制运行时实现：</p><ul><li>控制守护进程-守护进程负责服务器的启停，以及协调服务器和客户端之间的连接</li><li>客户端运行时- MPS的客户端运行时内置于CUDA的驱动库中，可以被任意CUDA程序透明调用</li><li>服务器进程- 服务器进程是与客户端共享的GPU的连接，并给客户端之间提供并发能力</li></ul><h4 id="MPS的优劣势"><a href="#MPS的优劣势" class="headerlink" title="MPS的优劣势"></a>MPS的优劣势</h4><h5 id="提高GPU利用率"><a href="#提高GPU利用率" class="headerlink" title="提高GPU利用率"></a>提高GPU利用率</h5><p>单个进程可能无法充分利用GPU上可用的全部计算资源和内存带宽容量。MPS允许来自不同的进程的内核操作和内存复制操作在同一个GPU上重叠，实行更高的利用率和更短的运行时间。</p><h5 id="减少GPU上下文存储"><a href="#减少GPU上下文存储" class="headerlink" title="减少GPU上下文存储"></a>减少GPU上下文存储</h5><p>当不使用MPS的情况下，每个使用GPU的cuda进程都会在GPU上分配单独的存储和调度资源，而使用MPS的情况下，MPS服务器会为所有的客户端分配一个共享的GPU存储调度资源的副本。并且Volta MPS增加了MPS客户端之间的隔离</p><h5 id="减少GPU上下文的切换"><a href="#减少GPU上下文的切换" class="headerlink" title="减少GPU上下文的切换"></a>减少GPU上下文的切换</h5><p>当进程共享GPU时，他们的调度资源必须在GPU上进行切换（比如说timeSlicing共享的情况下）。而在使用MPS的情况下，由于MPS服务器为所有的客户端配置了共享的调度资源，因此从根本上消除了客户端之间调度时上下文的切换</p><h5 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h5><ul><li>MPS仅支持Liunx操作系统，在非linux系统上，MPS服务无法启动</li><li>MPS不支持Tegra平台，在Terga平台上，MPS服务无法启动</li><li>MPS仅支持CUDA_VISBILE_DEVICES 3.5及以上版本，低于3.5的版本，MPS服务无法启动</li><li>MPS的UVA（Unified Virtual Addressing）功能必须开启，默认情况下，2.0以上是都支持该功能特性的</li><li>MPS 客户端可以分配的页锁定主机内存受 tmpfs 文件系统（&#x2F;dev&#x2F;shm）的大小限制</li><li>Exclusive-mode的限制只针对MPS的服务端，对客户端不影响</li><li>系统只能有一个MPS服务端提供服务</li><li>MPS守护控制进程会将来自MPS服务端不同的用户的不同激活请求放入队列，导致用户间在GPU上进行串行的排他访问，不管GPU相关的排他设置</li><li>NVIDIA监控相关的进程，会将MPS-client客户端的操作统一归结到MPS服务端，以服务端名义上报（例如NVML API, nvidia-smi）</li></ul><h5 id="GPU计算模式"><a href="#GPU计算模式" class="headerlink" title="GPU计算模式"></a>GPU计算模式</h5><p>NVIDIA GPU支持以下三种计算模式</p><ul><li>PROHIBITED（禁止模式）- GPU不可用于计算应用程序</li><li>EXCLUSIVE_PROCESS （独占进程模式）- GPU一次只分配一个进程，并且各个进程线程可以同时向GPU提交工作任务</li><li>DEFAULT（默认模式）- 多个进程可以同时使用GPU，每个进程的各个线程可以同时向GPU提交工作任务</li></ul><p>有效地使用MPS机制会导致独占模式下所有MPS的客户端表现得像默认模式一样，MPS通过MPS服务端保持允许多个客户端连接，并使用GPU。</p><p>使用MPS时，建议使用独占模式，以确保只有单个MPS服务端正在使用GPU，因为是独占的情况，能确保该MPS服务是所有CUDA进程在该GPU上的唯一仲裁点（arbitration）</p><h5 id="内存保护和错误包容机制（Memory-Protection-and-Error-Containment-）"><a href="#内存保护和错误包容机制（Memory-Protection-and-Error-Containment-）" class="headerlink" title="内存保护和错误包容机制（Memory Protection and Error Containment ）"></a>内存保护和错误包容机制（Memory Protection and Error Containment ）</h5><h5 id="内存保护（Memory-Protection）"><a href="#内存保护（Memory-Protection）" class="headerlink" title="内存保护（Memory Protection）"></a>内存保护（Memory Protection）</h5><ul><li>Volta MPS客户端进程具有完全隔离的GPU地址空间</li><li>Volta之前的MPS客户端进程从同一GPU的虚拟地址空间的不同分区中分配内存 ，会出现以下情况：<ul><li>CUDA内核中的越界写入可能会修改另一个进程的CUDA可访问的内存状态，并且不会触发错误</li><li>CUDA内核中的越界读取可能会访问另一个进程修改的CUDA可访问内存，并且不会触发错误，导致发生未定义的行为</li></ul></li><li>Volta MPS操作限制在CUDA内核中的指针内存访问，任何CUDA API都限制MPS客户端访问该MPS客户端内存分区之外的任何资源，例如：不可能使用cudaMemcpy() API覆盖另一个MPS客户端的内存</li></ul><h5 id="错误容忍机制"><a href="#错误容忍机制" class="headerlink" title="错误容忍机制"></a>错误容忍机制</h5><p>Volta MPS支持有限的错误隔离：</p><ul><li>当由某个Volta MPS 客户端进程产生严重故障时，该故障将包含在共享该严重故障的GPU的所有客户端的子集中</li><li>当由某个Volta MPS 客户端进程产生严重故障时，该故障将包含在共享该严重故障的GPU的所有客户端的子集中，同时这个故障会报告给该子集中所有的客户端，但是不会指出是由哪个客户端导致了这个故障。值得注意的是，严重故障产生后，产生故障的这个客户端有责任退出进程，避免运行在该GPU上的其他客户端受到影响</li><li>一旦检测到有严重故障，MPS服务器将等待所有和受影响的GPU关联的客户端退出，禁止新的客户端连接到这些有故障的GPU上。MPS服务器的状态将从’ACTIVE’更改为’FAULT’。当所有受影响的GPU关联的客户端都退出后，MPS服务端在该GPU上重新创建上下文，并继续处理发送到该GPU的客户端请求。MPS服务端会将服务器状态再次更改为’ACTIVE’，表示可以重新接收处理客户端请求</li></ul><p>举例来说，如果系统有GPU设备0，1，2，并且有四个客户端clientA，clientB，clientC，clientD连接到MPS服务器，假设clientA运行在设备0上，clientB运行在设备0和1上，clientC运行在设备1上，clientD运行在设备2上。如果clientA产生了一个严重错误，由于clientB使用了设备0和1，GPU故障会被包含在设备0和1中，因此故障将会上报给clientA,clientB和clientC，而运行在设备2 GPU上的clientD则不会受到影响。MPS服务端将等待clientA，clientB， clientC退出，并在服务器状态为’FAULT’时拒绝任何新的客户端请求连接。clientA，clientB，clientC都退出后，MPS服务器端会在GPU设备0，1上重建上下文，然后重新接收客户端的请求，最后MPS服务端会将状态重新修改为’ACTIVE’</p><p>以下与错误相关的信息将会被服务端记录：</p><ul><li>如果是严重的内存故障，触发该故障的客户端的PID将会被记录</li><li>受到故障影响的设备的设备ID</li><li>所有受到影响的客户端的PID，所有的客户端都会变成’INACTIVE’状态，服务端则会变成’FAULT’状态</li></ul><p>而在Volta之前版本的MPS中，关于GPU共享调度的错误报告机制，有如下情况：</p><ul><li>由任何客户端产生的GPU故障，将会报告给所有的客户端，但是并不会指明具体是哪个客户端产生了错误</li><li>由一个客户端产生的严重故障，会使MPS服务端和所有的客户端都停止运行中的GPU相关进程</li></ul><p>CUDA 运行时或者CUDA驱动在用CPU调用CUDA API产生的错误仅会传递给对应访问的客户端</p><h4 id="多GPU系统MPS"><a href="#多GPU系统MPS" class="headerlink" title="多GPU系统MPS"></a>多GPU系统MPS</h4><p>MPS支持使用多个GPU，在具有多GPU的系统上，可以通过设置CUDA_VISIBLE_DEVICES来枚举希望使用的GPU。</p><p>当系统混合了Volta和Volta前架构的GPU，如果MPS服务段设置为枚举所有的Volta GPU，那么会丢弃所有Volta前的GPU。简单来说，MPS服务端仅能工作只在Volta型GPU上运行，或者仅在Volta前型号的GPU上运行，不能混合使用</p><h5 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h5><h5 id="客户端-服务端连接限制"><a href="#客户端-服务端连接限制" class="headerlink" title="客户端-服务端连接限制"></a>客户端-服务端连接限制</h5><p>Volta前的MPS服务端同支持每个设备16个客户端的CUDA上下文。Volta后的MPS服务端支持每个设备最多48个客户端的上下文。这些上下文可以分布在多个进程中。如果连接超出限制，CUDA应用将会无法创建CUDA上下文，调用<code>cuCtxCreate()</code>或者调用创建的第一个CUDA运行时API会报错，MPS服务端会记录失败的连接尝试</p><h5 id="Volta-MPS执行资源分配"><a href="#Volta-MPS执行资源分配" class="headerlink" title="Volta MPS执行资源分配"></a>Volta MPS执行资源分配</h5><p>Volta MPS有限的支持执行资源的分配，客户端上下文仅可以设置为可用线程，分配功能通常用于实现两个目标：</p><ul><li>减少客户端的内存占用：于每个MPS客户端进程具有完全隔离的地址空间，每个客户端上下文都会分配独立的上下文存储和调度资源。这些资源随着客户端可用线程的数量而缩放。默认情况下，每个MPS客户端都可以使用所有可用线程。由于MPS通常与同时运行的多个进程一起使用，使每个线程对每个客户端都可访问通常是不必要的，因此分配完整的上下文存储通常是浪费的。减少可用线程数将有效减少上下文存储分配大小</li><li>提高QoS: 分配机制可以用作经典的QoS机制来限制可用的计算带宽。减少可用线程的部分还将使客户端提交的工作集中到一组SM（Streaming Multiprocessor）中，减少对其他客户端提交的作业任务的干扰</li></ul><p>设置限制不会为任何MPS客户端上下文保留任何的专用资源，它只会限制客户端上下文的可使用资源是多少。从不同MPS客户端上下文启动的内核可能在同一个SM（Streaming Multiprocessor），具体取决于负载均衡的情况</p><p>下图为V100-GPU架构和SM（Streaming Multiprocessor）,其中包含了84个SM单元</p><p><img src="/image/GPUShare/02-sm.png" alt="header"><img src="/image/GPUShare/v100.png" alt="header"></p><p>默认情况下，每个客户端都被设置为可以访问所有可用线程。这将允许最大程度的调度自由度，但由于浪费的执行资源分配而产生更高的内存占用。可以通过nvidia-smi查询每个客户端进程的内存使用情况。</p><p>限制可以通过几种不同的机制进行设置，以达到不同的效果。分为两种机制：活动线程百分比和编程接口。而通过活动线程百分比进行分区被分类为两种策略：均匀分区和非均匀分区。</p><ul><li><p>MPS控制实用程序提供了两组命令来设置&#x2F;查询所有未来MPS客户端的限制,例如 ：  </p><ul><li>get_device_client_list [<PID>] - this lists the devices and PIDs of client applications that enumerated this device. It optionally takes the server instance PID.</li><li>set_default_active_thread_percentage <percentage> - this overrides the default active thread percentage for MPS servers. If there is already a server spawned, this command will only affect the next server. The set value is lost if a quit command is executed. The default is 100.</li><li>get_default_active_thread_percentage - queries the current default available thread percentage.</li><li>set_active_thread_percentage <PID> <percentage> - this overrides the active thread percentage for the MPS server instance of the given PID. All clients created with that server afterwards will observe the new limit. Existing clients are not affected.</li><li>get_active_thread_percentage <PID> - queries the current available thread percentage of the MPS server instance of the given PID.</li><li>set_default_device_pinned_mem_limit <dev> <value> - this sets the default device pinned memory limit for each MPS client. If there is already a server spawned, this command will only affect the next server. The set value is lost if a quit command is executed. The value must be in the form of an integer followed by a qualifier, either “G” or “M” that specifies the value in Gigabyte or Megabyte respectively. For example: In order to set limit to 10 gigabytes for device 0, the command used is:</li><li>set_default_device_pinned_mem_limit 0 10G.</li><li>By default memory limiting is disabled.</li><li>get_default_device_pinned_mem_limit <dev> - queries the current default pinned memory limit for the device.</li><li>set_device_pinned_mem_limit <PID> <dev> <value> - this overrides the device pinned memory limit for MPS servers. This sets the device pinned memory limit for each client of MPS server instance of the given PID for the device dev. All clients created with that server afterwards will observe the new limit. Existing clients are not affected. Example usage to set memory limit of 900MB for server with pid 1024 for device 0.set_device_pinned_mem_limit 1024 0 900M</li><li>get_device_pinned_mem_limit <PID> <dev> - queries the current device pinned memory limit of the MPS server instance of the given PID for the device dev.</li></ul></li><li><p>或者，所有未来的MPS客户端的限制也可以通过设置环境变量CUDA_MPS_ACTIVE_THREAD_PERCENTAGE来进行MPS控制进程。限制可以通过仅为客户端进程设置环境变量CUDA_MPS_ACTIVE_THREAD_PERCENTAGE来进一步约束新客户端</p></li></ul><p>非均匀活动线程百分比限制是针对每个客户端CUDA上下文配置的，并且可以在整个客户端进程中更改。执行的限制通过设备属性<code>cudaDevAttrMultiProcessorCoun</code>t反映，返回值的表示了由调用线程的当前客户端CUDA上下文使用的可用线程的部分</p><ul><li>统一分区机制可以通过设置环境变量<code>CUDA_MPS_ACTIVE_THREAD_PERCENTAGE</code>以及环境变量<code>CUDA_MPS_ENABLE_PER_CTX_DEVICE_MULTIPROCESSOR_PARTITIONING</code>来进一步约束的客户端CUDA上下文，进而限制MPS的客户端</li></ul><p>程序化分区限制是通过<code>cuCtxCreate_v3()</code>创建的客户端CUDA上下文配置的，其执行关联性<code>CUexecAffinityParam</code>指定上下文限制使用的SM数。可以通过<code>cuCtxGetExecAffinity()</code>查询上下文的执行限制</p><p>一种常见的分配策略是将可用线程等均匀地分配给每个MPS客户端进程（即，将活动线程百分比设置为100% &#x2F; n，对于预期的n个MPS客户端进程）。此策略将分配接近最小量的执行资源，但这种分配策略可能会限制偶尔可以利用空闲资源的客户端的性能</p><p>更优化的策略是将部分按照预期客户端数量的一半等均匀分配（即，将活动线程百分比设置为100% &#x2F; 0.5n），以便在有空闲资源时给负载平衡器更多的重叠执行自由度</p><p>非均匀活动线程百分比限制是针对每个客户端CUDA上下文配置的，并且可以在整个客户端进程中更改。执行的限制通过设备属性cudaDevAttrMultiProcessorCount反映，其值返回可以由调用线程的当前客户端CUDA上下文使用的可用线程的部分。</p><p>统一分区机制约束的限制可以通过设置环境变量<code>CUDA_MPS_ACTIVE_THREAD_PERCENTAGE</code>以及环境变量<code>CUDA_MPS_ENABLE_PER_CTX_DEVICE_MULTIPROCESSOR_PARTITIONING</code>来进一步约束新的客户端CUDA上下文。</p><p> 由程序化分区约束的限制是通过<code>cuCtxCreate_v3()</code>创建的客户端CUDA上下文配置的，其执行关联性<code>CUexecAffinityParam</code>指定上下文限制使用的SM数。可以通过<code>cuCtxGetExecAffinity()</code>查询上下文的执行限制,分配策略包含以下几种：</p><p>一种常见的分配策略是将可用线程等均匀地分配给每个MPS客户端进程（即，将活动线程百分比设置为100% &#x2F; n，对于预期的n个MPS客户端进程）。此策略将分配接近最小量的执行资源，但它可能会限制偶尔可以利用空闲资源的客户端的性能。</p><p>更优化的策略是将部分按照预期客户端数量的一半等均匀分配（即，将活动线程百分比设置为100% &#x2F; 0.5n），以便在有空闲资源时给负载平衡器更多的重叠执行自由度。</p><p>近乎最佳的策略是根据每个MPS客户端的工作负载非均匀地分配可用线程（即如果客户端1的工作负载和客户端2的工作负载的比率为30%: 70%，则将活动线程百分比设置为30%为客户端1，将活动线程百分比设置为70%为客户端2）。此策略将不同客户端提交的工作集中到不相交的SM集合中，并有效地最小化了不同客户端提交的作业之间的干扰</p><p>最优的策略是准确限制每个MPS客户端要使用的SM数，了解每个客户端的执行资源要求（例如，在具有84个SM的设备上，客户端1的SM数为24，客户端2的SM数为60）。此策略提供了比活动线程百分比更精细和更灵活的对工作将在其中运行的SM集的控制</p><p>如果使用活动线程百分比进行分区，则限制将在内部四舍五入到最接近的硬件支持的线程计数限制。如果使用编程接口进行分区，则限制将在内部四舍五入到最接近的硬件支持的SM计数</p><h5 id="线程和Linux调度"><a href="#线程和Linux调度" class="headerlink" title="线程和Linux调度"></a>线程和Linux调度</h5><p>在Volta前的版本的GPU上，如果启动的MPS客户端数量超过计算机上可用的逻辑核心数量，将会导致启动延迟增加，并且通常会由于Linux CFS（完全公平调度程序）对线程的调度方式而减慢客户端-服务器通信。对于使用多个GPU并为每个GPU启动MPS控制守护程序和服务器的设置，我们建议将每个MPS服务端固定到一个不同的核心。这可以通过使用实用程序<code>taskset</code>来实现，该实用程序允许将运行中的程序绑定到多个核心或在它们上启动新程序。要在MPS中实现这一点，请将控制守护程序绑定到特定核心上启动，例如，<code>taskset –c 0 nvidia-cuda-mps-control –d</code>。当MPS服务器启动时，进程亲和力将被继承</p><h5 id="Volta-MPS的内存限制"><a href="#Volta-MPS的内存限制" class="headerlink" title="Volta MPS的内存限制"></a>Volta MPS的内存限制</h5><p>在Volta MPS上，用户可以强制客户端遵循内存分配限制。这个机制提供了跨特定GPU上运行的MPS客户端的GPU内存细分化的能力，这使得调度和部署系统能够根据客户端的内存使用情况做出对应决策。如果客户端尝试分配超过预设限制的内存，则cuda内存分配调用将返回内存不足错误。内存限制还将考虑CUDA内部设备分配，这将帮助用户做出关于最佳GPU利用率的调度决策。用户可以通过一系列控制机制来限制MPS客户端的固定设备内存。<code>default</code>限制设置将强制将设备内存限制应用于所有未来生成的MPS服务器的所有MPS客户端。<code>per server</code>限制设置允许对内存资源限制进行更精细的控制，用户可以使用服务器PID选择性地设置内存限制，从而影响服务器的所有客户端。此外，MPS客户端还可以通过使用<code>CUDA_MPS_PINNED_DEVICE_MEM_LIMIT</code>环境变量进一步约束来自服务器的内存限制设置</p><h3 id="MIG（multi-instance-GPU）"><a href="#MIG（multi-instance-GPU）" class="headerlink" title="MIG（multi-instance GPU）"></a>MIG（multi-instance GPU）</h3><h4 id="背景-3"><a href="#背景-3" class="headerlink" title="背景"></a>背景</h4><p><img src="/image/GPUShare/mig.png" alt="header"></p><p>实例GPU（MIG）功能允许GPU（从NVIDIA Ampere架构开始）安全地分区为最多七个单独的GPU实例，用于CUDA应用程序，为多个用户提供独立的GPU资源，以实现最佳的GPU利用率。该功能特别适用于不完全饱和GPU计算能力的工作负载，因此用户可能希望并行运行不同的工作负载以最大化利用率。</p><p>对于具有多租户用例的云服务提供商（CSP），MIG机制确保一个客户端不会影响其他客户端的工作或调度，为客户提供了强隔离性。</p><p>通过MIG，每个实例的处理器都具有通过整个内存系统的单独和隔离的路径 - 芯片上的交叉点端口、L2缓存块、内存控制器和DRAM地址总线都被唯一地分配给一个单独的实例。这确保了单个用户的工作负载可以以可预测的吞吐量和延迟运行，具有相同的L2缓存分配和DRAM带宽，即使其他任务正在破坏它们自己的缓存或饱和它们的DRAM接口。MIG可以分区可用的GPU计算资源（包括流式多处理器或SM和GPU引擎，例如复制引擎或解码器），为不同的客户（如VM、容器或进程）提供定义良好的服务质量（QoS）和故障隔离。MIG使多个GPU实例可以在单个物理NVIDIA Ampere GPU上并行运行。</p><p>使用MIG，用户将能够像处理物理GPU一样查看和调度其新的虚拟GPU实例上的作业。MIG与Linux操作系统配合使用，支持使用Docker 容器，支持Kubernetes和使用Red Hat Virtualization和VMware vSphere等虚拟机。</p><p>MIG支持以下部署方式：</p><ul><li><p>裸机，包含容器以及Kubernetes</p></li><li><p>GPU直通虚拟化到Linux客户机，由上层hypervisor进行管理</p></li><li><p>vGPU，由上层hypervisor支持（MIG允许多个vGPU（从而是VM）在单个GPU上并行运行，同时保留了vGPU提供的隔离保证）</p></li></ul><h4 id="GPU-Instance"><a href="#GPU-Instance" class="headerlink" title="GPU Instance"></a>GPU Instance</h4><p>下图示例为A100-40GB（同理A800-80GB的型号，显存80g）</p><p><img src="/image/GPUShare/A100.png" alt="header"></p><p>mig机制可以将其分为最多7个设备，所以A800-80G可以包含以下7几种配置7个<strong>1g.10gb</strong>,4个<strong>1g.20gb</strong>,1个<strong>1g.10gb+me</strong>,3个<strong>2g.20gb</strong>,2个<strong>3g.40gb</strong>,1个<strong>4g.40gb</strong>,1个<strong>7g.80gb</strong></p><p>建一个GPU实例（GI）需要将一定数量的内存切片与一定数量的计算切片组合起来。在下面的图表中，一个5GB的内存切片与一个计算切片结合起来创建了一个<strong>1g.5gb</strong>的GI配置(对应的A800-80GB的情况就是<strong>1g.10gb</strong>的配置),还有一个是4个计算切片和4个5GB内存切片组合的<strong>4g.20gb</strong>的GI配置（对应的A800-80GB的情况就是<strong>4g.40gb</strong>的配置）</p><p><img src="/image/GPUShare/mig1g.5g.png" alt="header"></p><p><img src="/image/GPUShare/mig.4g.20g.png" alt="header"></p><p>同理，使用上面的<strong>4g.20gb</strong>示例，可以创建一个CI，仅使用第一个计算切片，如下所示：</p><p><img src="/image/GPUShare/mig.1c.4g.20gb.png" alt="header"></p><p>在这种情况下，可以通过选择任何计算切片来创建4个不同的CI。也可以将两个计算切片结合在一起，创建一个2c.4g.20gb配置，除此之外，还可以组合 3 个计算切片以创建计算配置，或者可以组合所有 4 个计算切片以创建 <strong>3c.4g.20gb</strong> 、 <strong>4c.4g.20gb</strong> 计算配置。 合并所有 4 个计算切片时，配置简称为 <strong>4g.20gb</strong> </p><p><img src="/image/GPUShare/mig.2c.4g.20gb.png" alt="header"></p><p>A100(A800)的mig配置如下图所示：</p><p><img src="/image/GPUShare/a100-mig-profile.png" alt="header"></p><h3 id="Kubernetes部署相关组件配置"><a href="#Kubernetes部署相关组件配置" class="headerlink" title="Kubernetes部署相关组件配置"></a>Kubernetes部署相关组件配置</h3><p>从 CUDA 11.1 （ R455 +驱动程序）开始， CUDA 应用程序的时间片持续时间可通过**<code>nvidia-smi</code>**实用程序：</p><p>![header](image&#x2F;GPUShare&#x2F;nvidia-smi compute-policy.png)</p><p>在Kubernetes中，NVIDIA GPU是以device-pluging的形式，作为node的资源提供。然而，在device-pluging的框架下仅允许将设备（包括 GPU （作为<code>nvidia.com/gpu</code>）作为整数资源进行上报，不允过度订阅，而下文则讨论的是使用时间切片在Kubernetes中超分gpu的方案，首先需要需要部署以下的组件来进行gpu的配置</p><h4 id="node-feature-discovery-部署"><a href="#node-feature-discovery-部署" class="headerlink" title="node-feature-discovery 部署"></a>node-feature-discovery 部署</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.14.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodefeaturerules.nfd.k8s-sigs.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">NodeFeatureRule</span></span><br><span class="line">    <span class="attr">listKind:</span> <span class="string">NodeFeatureRuleList</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">nodefeaturerules</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfr</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">nodefeaturerule</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1alpha1</span></span><br><span class="line">    <span class="attr">schema:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">          NodeFeatureRule resource specifies a configuration for feature-based</span></span><br><span class="line"><span class="string">          customization of node objects, such as node labeling.</span></span><br><span class="line"><span class="string"></span>        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">apiVersion:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              APIVersion defines the versioned schema of this representation of an object.</span></span><br><span class="line"><span class="string">              Servers should convert recognized schemas to the latest internal value, and</span></span><br><span class="line"><span class="string">              may reject unrecognized values.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">kind:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              Kind is a string value representing the REST resource this object represents.</span></span><br><span class="line"><span class="string">              Servers may infer this from the endpoint the client submits requests to.</span></span><br><span class="line"><span class="string">              Cannot be updated.</span></span><br><span class="line"><span class="string">              In CamelCase.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">NodeFeatureRuleSpec</span> <span class="string">describes</span> <span class="string">a</span> <span class="string">NodeFeatureRule.</span></span><br><span class="line">            <span class="attr">properties:</span></span><br><span class="line">              <span class="attr">rules:</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">Rules</span> <span class="string">is</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">node</span> <span class="string">customization</span> <span class="string">rules.</span></span><br><span class="line">                <span class="attr">items:</span></span><br><span class="line">                  <span class="attr">description:</span> <span class="string">Rule</span> <span class="string">defines</span> <span class="string">a</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">node</span> <span class="string">customization</span> <span class="string">such</span> <span class="string">as</span></span><br><span class="line">                    <span class="string">labeling.</span></span><br><span class="line">                  <span class="attr">properties:</span></span><br><span class="line">                    <span class="attr">annotations:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Annotations</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">extendedResources:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">ExtendedResources</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">labels:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Labels</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">labelsTemplate:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                        LabelsTemplate specifies a template to expand for dynamically generating</span></span><br><span class="line"><span class="string">                        multiple labels. Data (after template expansion) must be keys with an</span></span><br><span class="line"><span class="string">                        optional value (&lt;key&gt;[=&lt;value&gt;]) separated by newlines.</span></span><br><span class="line"><span class="string"></span>                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                    <span class="attr">matchAny:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">MatchAny</span> <span class="string">specifies</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">matchers</span> <span class="string">one</span> <span class="string">of</span> <span class="string">which</span></span><br><span class="line">                        <span class="string">must</span> <span class="string">match.</span></span><br><span class="line">                      <span class="attr">items:</span></span><br><span class="line">                        <span class="attr">description:</span> <span class="string">MatchAnyElem</span> <span class="string">specifies</span> <span class="string">one</span> <span class="string">sub-matcher</span> <span class="string">of</span> <span class="string">MatchAny.</span></span><br><span class="line">                        <span class="attr">properties:</span></span><br><span class="line">                          <span class="attr">matchFeatures:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">MatchFeatures</span> <span class="string">specifies</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">matcher</span></span><br><span class="line">                              <span class="string">terms</span> <span class="string">all</span> <span class="string">of</span> <span class="string">which</span> <span class="string">must</span> <span class="string">match.</span></span><br><span class="line">                            <span class="attr">items:</span></span><br><span class="line">                              <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                FeatureMatcherTerm defines requirements against one feature set. All</span></span><br><span class="line"><span class="string">                                requirements (specified as MatchExpressions) are evaluated against each</span></span><br><span class="line"><span class="string">                                element in the feature set.</span></span><br><span class="line"><span class="string"></span>                              <span class="attr">properties:</span></span><br><span class="line">                                <span class="attr">feature:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">Feature</span> <span class="string">is</span> <span class="string">the</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">feature</span></span><br><span class="line">                                    <span class="string">set</span> <span class="string">to</span> <span class="string">match</span> <span class="string">against.</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">matchExpressions:</span></span><br><span class="line">                                  <span class="attr">additionalProperties:</span></span><br><span class="line">                                    <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                      MatchExpression specifies an expression to evaluate against a set of input</span></span><br><span class="line"><span class="string">                                      values. It contains an operator that is applied when matching the input and</span></span><br><span class="line"><span class="string">                                      an array of values that the operator evaluates the input against.</span></span><br><span class="line"><span class="string"></span>                                    <span class="attr">properties:</span></span><br><span class="line">                                      <span class="attr">op:</span></span><br><span class="line">                                        <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                        <span class="attr">enum:</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                      <span class="attr">value:</span></span><br><span class="line">                                        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                          Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                          against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                          IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                          operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                          In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                        <span class="attr">items:</span></span><br><span class="line">                                          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                        <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                                    <span class="attr">required:</span></span><br><span class="line">                                    <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                    MatchExpressions is the set of per-element expressions evaluated. These</span></span><br><span class="line"><span class="string">                                    match against the value of the specified elements.</span></span><br><span class="line"><span class="string"></span>                                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                                <span class="attr">matchName:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                    MatchName in an expression that is matched against the name of each</span></span><br><span class="line"><span class="string">                                    element in the feature set.</span></span><br><span class="line"><span class="string"></span>                                  <span class="attr">properties:</span></span><br><span class="line">                                    <span class="attr">op:</span></span><br><span class="line">                                      <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                      <span class="attr">enum:</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                    <span class="attr">value:</span></span><br><span class="line">                                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                        Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                        against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                        IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                        operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                        In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                      <span class="attr">items:</span></span><br><span class="line">                                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                                  <span class="attr">required:</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                              <span class="attr">required:</span></span><br><span class="line">                              <span class="bullet">-</span> <span class="string">feature</span></span><br><span class="line">                              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                        <span class="attr">required:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">matchFeatures</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                    <span class="attr">matchFeatures:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">MatchFeatures</span> <span class="string">specifies</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">matcher</span> <span class="string">terms</span></span><br><span class="line">                        <span class="string">all</span> <span class="string">of</span> <span class="string">which</span> <span class="string">must</span> <span class="string">match.</span></span><br><span class="line">                      <span class="attr">items:</span></span><br><span class="line">                        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                          FeatureMatcherTerm defines requirements against one feature set. All</span></span><br><span class="line"><span class="string">                          requirements (specified as MatchExpressions) are evaluated against each</span></span><br><span class="line"><span class="string">                          element in the feature set.</span></span><br><span class="line"><span class="string"></span>                        <span class="attr">properties:</span></span><br><span class="line">                          <span class="attr">feature:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">Feature</span> <span class="string">is</span> <span class="string">the</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">feature</span> <span class="string">set</span> <span class="string">to</span></span><br><span class="line">                              <span class="string">match</span> <span class="string">against.</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">matchExpressions:</span></span><br><span class="line">                            <span class="attr">additionalProperties:</span></span><br><span class="line">                              <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                MatchExpression specifies an expression to evaluate against a set of input</span></span><br><span class="line"><span class="string">                                values. It contains an operator that is applied when matching the input and</span></span><br><span class="line"><span class="string">                                an array of values that the operator evaluates the input against.</span></span><br><span class="line"><span class="string"></span>                              <span class="attr">properties:</span></span><br><span class="line">                                <span class="attr">op:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                  <span class="attr">enum:</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">value:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                    Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                    against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                    IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                    operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                    In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                  <span class="attr">items:</span></span><br><span class="line">                                    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                              <span class="attr">required:</span></span><br><span class="line">                              <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              MatchExpressions is the set of per-element expressions evaluated. These</span></span><br><span class="line"><span class="string">                              match against the value of the specified elements.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                          <span class="attr">matchName:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              MatchName in an expression that is matched against the name of each</span></span><br><span class="line"><span class="string">                              element in the feature set.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">properties:</span></span><br><span class="line">                              <span class="attr">op:</span></span><br><span class="line">                                <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                <span class="attr">enum:</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                              <span class="attr">value:</span></span><br><span class="line">                                <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                  Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                  against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                  IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                  operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                  In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                <span class="attr">items:</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                            <span class="attr">required:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                        <span class="attr">required:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">feature</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                    <span class="attr">name:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">rule.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                    <span class="attr">taints:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Taints</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">items:</span></span><br><span class="line">                        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                          The node this Taint is attached to has the &quot;effect&quot; on</span></span><br><span class="line"><span class="string">                          any pod that does not tolerate the Taint.</span></span><br><span class="line"><span class="string"></span>                        <span class="attr">properties:</span></span><br><span class="line">                          <span class="attr">effect:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              Required. The effect of the taint on pods</span></span><br><span class="line"><span class="string">                              that do not tolerate the taint.</span></span><br><span class="line"><span class="string">                              Valid effects are NoSchedule, PreferNoSchedule and NoExecute.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">key:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">Required.</span> <span class="string">The</span> <span class="string">taint</span> <span class="string">key</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied</span> <span class="string">to</span></span><br><span class="line">                              <span class="string">a</span> <span class="string">node.</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">timeAdded:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              TimeAdded represents the time at which the taint was added.</span></span><br><span class="line"><span class="string">                              It is only written for NoExecute taints.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">format:</span> <span class="string">date-time</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">value:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">The</span> <span class="string">taint</span> <span class="string">value</span> <span class="string">corresponding</span> <span class="string">to</span> <span class="string">the</span> <span class="string">taint</span></span><br><span class="line">                              <span class="string">key.</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                        <span class="attr">required:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">effect</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">key</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                    <span class="attr">vars:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                        Vars is the variables to store if the rule matches. Variables do not</span></span><br><span class="line"><span class="string">                        directly inflict any changes in the node object. However, they can be</span></span><br><span class="line"><span class="string">                        referenced from other rules enabling more complex rule hierarchies,</span></span><br><span class="line"><span class="string">                        without exposing intermediary output values as labels.</span></span><br><span class="line"><span class="string"></span>                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">varsTemplate:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                        VarsTemplate specifies a template to expand for dynamically generating</span></span><br><span class="line"><span class="string">                        multiple variables. Data (after template expansion) must be keys with an</span></span><br><span class="line"><span class="string">                        optional value (&lt;key&gt;[=&lt;value&gt;]) separated by newlines.</span></span><br><span class="line"><span class="string"></span>                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">required:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">name</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">            <span class="attr">required:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">rules</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">required:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">spec</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">    <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.14.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodefeatures.nfd.k8s-sigs.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">NodeFeature</span></span><br><span class="line">    <span class="attr">listKind:</span> <span class="string">NodeFeatureList</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">nodefeatures</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">nodefeature</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1alpha1</span></span><br><span class="line">    <span class="attr">schema:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">          NodeFeature resource holds the features discovered for one node in the</span></span><br><span class="line"><span class="string">          cluster.</span></span><br><span class="line"><span class="string"></span>        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">apiVersion:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              APIVersion defines the versioned schema of this representation of an object.</span></span><br><span class="line"><span class="string">              Servers should convert recognized schemas to the latest internal value, and</span></span><br><span class="line"><span class="string">              may reject unrecognized values.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">kind:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              Kind is a string value representing the REST resource this object represents.</span></span><br><span class="line"><span class="string">              Servers may infer this from the endpoint the client submits requests to.</span></span><br><span class="line"><span class="string">              Cannot be updated.</span></span><br><span class="line"><span class="string">              In CamelCase.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">NodeFeatureSpec</span> <span class="string">describes</span> <span class="string">a</span> <span class="string">NodeFeature</span> <span class="string">object.</span></span><br><span class="line">            <span class="attr">properties:</span></span><br><span class="line">              <span class="attr">features:</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">Features</span> <span class="string">is</span> <span class="string">the</span> <span class="string">full</span> <span class="string">&quot;raw&quot;</span> <span class="string">features</span> <span class="string">data</span> <span class="string">that</span> <span class="string">has</span> <span class="string">been</span></span><br><span class="line">                  <span class="string">discovered.</span></span><br><span class="line">                <span class="attr">properties:</span></span><br><span class="line">                  <span class="attr">attributes:</span></span><br><span class="line">                    <span class="attr">additionalProperties:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">AttributeFeatureSet</span> <span class="string">is</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">features</span> <span class="string">having</span></span><br><span class="line">                        <span class="string">string</span> <span class="string">value.</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">elements:</span></span><br><span class="line">                          <span class="attr">additionalProperties:</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">required:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">elements</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">description:</span> <span class="string">Attributes</span> <span class="string">contains</span> <span class="string">all</span> <span class="string">the</span> <span class="string">attribute-type</span> <span class="string">features</span></span><br><span class="line">                      <span class="string">of</span> <span class="string">the</span> <span class="string">node.</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                  <span class="attr">flags:</span></span><br><span class="line">                    <span class="attr">additionalProperties:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">FlagFeatureSet</span> <span class="string">is</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">simple</span> <span class="string">features</span> <span class="string">only</span></span><br><span class="line">                        <span class="string">containing</span> <span class="string">names</span> <span class="string">without</span> <span class="string">values.</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">elements:</span></span><br><span class="line">                          <span class="attr">additionalProperties:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">Nil</span> <span class="string">is</span> <span class="string">a</span> <span class="string">dummy</span> <span class="string">empty</span> <span class="string">struct</span> <span class="string">for</span> <span class="string">protobuf</span></span><br><span class="line">                              <span class="string">compatibility</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">required:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">elements</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">description:</span> <span class="string">Flags</span> <span class="string">contains</span> <span class="string">all</span> <span class="string">the</span> <span class="string">flag-type</span> <span class="string">features</span> <span class="string">of</span> <span class="string">the</span></span><br><span class="line">                      <span class="string">node.</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                  <span class="attr">instances:</span></span><br><span class="line">                    <span class="attr">additionalProperties:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">InstanceFeatureSet</span> <span class="string">is</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">features</span> <span class="string">each</span> <span class="string">of</span></span><br><span class="line">                        <span class="string">which</span> <span class="string">is</span> <span class="string">an</span> <span class="string">instance</span> <span class="string">having</span> <span class="string">multiple</span> <span class="string">attributes.</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">elements:</span></span><br><span class="line">                          <span class="attr">items:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">InstanceFeature</span> <span class="string">represents</span> <span class="string">one</span> <span class="string">instance</span> <span class="string">of</span></span><br><span class="line">                              <span class="string">a</span> <span class="string">complex</span> <span class="string">features,</span> <span class="string">e.g.</span> <span class="string">a</span> <span class="string">device.</span></span><br><span class="line">                            <span class="attr">properties:</span></span><br><span class="line">                              <span class="attr">attributes:</span></span><br><span class="line">                                <span class="attr">additionalProperties:</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                            <span class="attr">required:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">attributes</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                      <span class="attr">required:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">elements</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">description:</span> <span class="string">Instances</span> <span class="string">contains</span> <span class="string">all</span> <span class="string">the</span> <span class="string">instance-type</span> <span class="string">features</span></span><br><span class="line">                      <span class="string">of</span> <span class="string">the</span> <span class="string">node.</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">labels:</span></span><br><span class="line">                <span class="attr">additionalProperties:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">Labels</span> <span class="string">is</span> <span class="string">the</span> <span class="string">set</span> <span class="string">of</span> <span class="string">node</span> <span class="string">labels</span> <span class="string">that</span> <span class="string">are</span> <span class="string">requested</span> <span class="string">to</span></span><br><span class="line">                  <span class="string">be</span> <span class="string">created.</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">required:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">spec</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">    <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">topology.node.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">noderesourcetopologies</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeaturerules</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">  <span class="attr">resourceNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd-master.nfd.kubernetes.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nfd-master.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # noPublish: false</span></span><br><span class="line"><span class="string">    # autoDefaultNs: true</span></span><br><span class="line"><span class="string">    # extraLabelNs: [&quot;added.ns.io&quot;,&quot;added.kubernets.io&quot;]</span></span><br><span class="line"><span class="string">    # denyLabelNs: [&quot;denied.ns.io&quot;,&quot;denied.kubernetes.io&quot;]</span></span><br><span class="line"><span class="string">    # resourceLabels: [&quot;vendor-1.com/feature-1&quot;,&quot;vendor-2.io/feature-2&quot;]</span></span><br><span class="line"><span class="string">    # enableTaints: false</span></span><br><span class="line"><span class="string">    # labelWhiteList: &quot;foo&quot;</span></span><br><span class="line"><span class="string">    # resyncPeriod: &quot;2h&quot;</span></span><br><span class="line"><span class="string">    # klog:</span></span><br><span class="line"><span class="string">    #    addDirHeader: false</span></span><br><span class="line"><span class="string">    #    alsologtostderr: false</span></span><br><span class="line"><span class="string">    #    logBacktraceAt:</span></span><br><span class="line"><span class="string">    #    logtostderr: true</span></span><br><span class="line"><span class="string">    #    skipHeaders: false</span></span><br><span class="line"><span class="string">    #    stderrthreshold: 2</span></span><br><span class="line"><span class="string">    #    v: 0</span></span><br><span class="line"><span class="string">    #    vmodule:</span></span><br><span class="line"><span class="string">    ##   NOTE: the following options are not dynamically run-time configurable</span></span><br><span class="line"><span class="string">    ##         and require a nfd-master restart to take effect after being changed</span></span><br><span class="line"><span class="string">    #    logDir:</span></span><br><span class="line"><span class="string">    #    logFile:</span></span><br><span class="line"><span class="string">    #    logFileMaxSize: 1800</span></span><br><span class="line"><span class="string">    #    skipLogHeaders: false</span></span><br><span class="line"><span class="string">    # leaderElection:</span></span><br><span class="line"><span class="string">    #   leaseDuration: 15s</span></span><br><span class="line"><span class="string">    #   # this value has to be lower than leaseDuration and greater than retryPeriod*1.2</span></span><br><span class="line"><span class="string">    #   renewDeadline: 10s</span></span><br><span class="line"><span class="string">    #   # this value has to be greater than 0</span></span><br><span class="line"><span class="string">    #   retryPeriod: 2s</span></span><br><span class="line"><span class="string">    # nfdApiParallelism: 10</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nfd-worker.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    #core:</span></span><br><span class="line"><span class="string">    #  labelWhiteList:</span></span><br><span class="line"><span class="string">    #  noPublish: false</span></span><br><span class="line"><span class="string">    #  sleepInterval: 60s</span></span><br><span class="line"><span class="string">    #  featureSources: [all]</span></span><br><span class="line"><span class="string">    #  labelSources: [all]</span></span><br><span class="line"><span class="string">    #  klog:</span></span><br><span class="line"><span class="string">    #    addDirHeader: false</span></span><br><span class="line"><span class="string">    #    alsologtostderr: false</span></span><br><span class="line"><span class="string">    #    logBacktraceAt:</span></span><br><span class="line"><span class="string">    #    logtostderr: true</span></span><br><span class="line"><span class="string">    #    skipHeaders: false</span></span><br><span class="line"><span class="string">    #    stderrthreshold: 2</span></span><br><span class="line"><span class="string">    #    v: 0</span></span><br><span class="line"><span class="string">    #    vmodule:</span></span><br><span class="line"><span class="string">    ##   NOTE: the following options are not dynamically run-time configurable</span></span><br><span class="line"><span class="string">    ##         and require a nfd-worker restart to take effect after being changed</span></span><br><span class="line"><span class="string">    #    logDir:</span></span><br><span class="line"><span class="string">    #    logFile:</span></span><br><span class="line"><span class="string">    #    logFileMaxSize: 1800</span></span><br><span class="line"><span class="string">    #    skipLogHeaders: false</span></span><br><span class="line"><span class="string">    #sources:</span></span><br><span class="line"><span class="string">    #  cpu:</span></span><br><span class="line"><span class="string">    #    cpuid:</span></span><br><span class="line"><span class="string">    ##     NOTE: whitelist has priority over blacklist</span></span><br><span class="line"><span class="string">    #      attributeBlacklist:</span></span><br><span class="line"><span class="string">    #        - &quot;BMI1&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;BMI2&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;CLMUL&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;CMOV&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;CX16&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;ERMS&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;F16C&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;HTT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;LZCNT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;MMX&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;MMXEXT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;NX&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;POPCNT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;RDRAND&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;RDSEED&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;RDTSCP&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SGX&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE2&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE3&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE4&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE42&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSSE3&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;TDX_GUEST&quot;</span></span><br><span class="line"><span class="string">    #      attributeWhitelist:</span></span><br><span class="line"><span class="string">    #  kernel:</span></span><br><span class="line"><span class="string">    #    kconfigFile: &quot;/path/to/kconfig&quot;</span></span><br><span class="line"><span class="string">    #    configOpts:</span></span><br><span class="line"><span class="string">    #      - &quot;NO_HZ&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;X86&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;DMI&quot;</span></span><br><span class="line"><span class="string">    #  pci:</span></span><br><span class="line"><span class="string">    #    deviceClassWhitelist:</span></span><br><span class="line"><span class="string">    #      - &quot;0200&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;03&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;12&quot;</span></span><br><span class="line"><span class="string">    #    deviceLabelFields:</span></span><br><span class="line"><span class="string">    #      - &quot;class&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;vendor&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;device&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;subsystem_vendor&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;subsystem_device&quot;</span></span><br><span class="line"><span class="string">    #  usb:</span></span><br><span class="line"><span class="string">    #    deviceClassWhitelist:</span></span><br><span class="line"><span class="string">    #      - &quot;0e&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;ef&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;fe&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;ff&quot;</span></span><br><span class="line"><span class="string">    #    deviceLabelFields:</span></span><br><span class="line"><span class="string">    #      - &quot;class&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;vendor&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;device&quot;</span></span><br><span class="line"><span class="string">    #  local:</span></span><br><span class="line"><span class="string">    #    hooksEnabled: false</span></span><br><span class="line"><span class="string">    #  custom:</span></span><br><span class="line"><span class="string">    #    # The following feature demonstrates the capabilities of the matchFeatures</span></span><br><span class="line"><span class="string">    #    - name: &quot;my custom rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my-ng-feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      # matchFeatures implements a logical AND over all matcher terms in the</span></span><br><span class="line"><span class="string">    #      # list (i.e. all of the terms, or per-feature matchers, must match)</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            AVX512F: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cstate</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            enabled: &#123;op: IsTrue&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.pstate</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            no_turbo: &#123;op: IsFalse&#125;</span></span><br><span class="line"><span class="string">    #            scaling_governor: &#123;op: In, value: [&quot;performance&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.rdt</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            RDTL3CA: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.sst</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            bf.enabled: &#123;op: IsTrue&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.topology</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            hardware_multithreading: &#123;op: IsFalse&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: kernel.config</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            X86: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #            LSM: &#123;op: InRegexp, value: [&quot;apparmor&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: kernel.loadedmodule</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            e1000e: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #        - feature: kernel.selinux</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            enabled: &#123;op: IsFalse&#125;</span></span><br><span class="line"><span class="string">    #        - feature: kernel.version</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            major: &#123;op: In, value: [&quot;5&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            minor: &#123;op: Gt, value: [&quot;10&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: storage.block</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            rotational: &#123;op: In, value: [&quot;0&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            dax: &#123;op: In, value: [&quot;0&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: network.device</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            operstate: &#123;op: In, value: [&quot;up&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            speed: &#123;op: Gt, value: [&quot;100&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: memory.numa</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            node_count: &#123;op: Gt, value: [&quot;2&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: memory.nv</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            devtype: &#123;op: In, value: [&quot;nd_dax&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            mode: &#123;op: In, value: [&quot;memory&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: system.osrelease</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            ID: &#123;op: In, value: [&quot;fedora&quot;, &quot;centos&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: system.name</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            nodename: &#123;op: InRegexp, value: [&quot;^worker-X&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: local.label</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            custom-feature-knob: &#123;op: Gt, value: [&quot;100&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    # The following feature demonstrates the capabilities of the matchAny</span></span><br><span class="line"><span class="string">    #    - name: &quot;my matchAny rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my-ng-feature-2&quot;: &quot;my-value&quot;</span></span><br><span class="line"><span class="string">    #      # matchAny implements a logical IF over all elements (sub-matchers) in</span></span><br><span class="line"><span class="string">    #      # the list (i.e. at least one feature matcher must match)</span></span><br><span class="line"><span class="string">    #      matchAny:</span></span><br><span class="line"><span class="string">    #        - matchFeatures:</span></span><br><span class="line"><span class="string">    #            - feature: kernel.loadedmodule</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                driver-module-X: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #            - feature: pci.device</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                vendor: &#123;op: In, value: [&quot;8086&quot;]&#125;</span></span><br><span class="line"><span class="string">    #                class: &#123;op: In, value: [&quot;0200&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - matchFeatures:</span></span><br><span class="line"><span class="string">    #            - feature: kernel.loadedmodule</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                driver-module-Y: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #            - feature: usb.device</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                vendor: &#123;op: In, value: [&quot;8086&quot;]&#125;</span></span><br><span class="line"><span class="string">    #                class: &#123;op: In, value: [&quot;02&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;avx wildcard rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;my-avx-feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchName: &#123;op: InRegexp, value: [&quot;^AVX512&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    # The following features demonstreate label templating capabilities</span></span><br><span class="line"><span class="string">    #    - name: &quot;my template rule&quot;</span></span><br><span class="line"><span class="string">    #      labelsTemplate: |</span></span><br><span class="line"><span class="string">    #        &#123;&#123; range .system.osrelease &#125;&#125;vendor.io/my-system-feature.&#123;&#123; .Name &#125;&#125;=&#123;&#123; .Value &#125;&#125;</span></span><br><span class="line"><span class="string">    #        &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: system.osrelease</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            ID: &#123;op: InRegexp, value: [&quot;^open.*&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            VERSION_ID.major: &#123;op: In, value: [&quot;13&quot;, &quot;15&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;my template rule 2&quot;</span></span><br><span class="line"><span class="string">    #      labelsTemplate: |</span></span><br><span class="line"><span class="string">    #        &#123;&#123; range .pci.device &#125;&#125;vendor.io/my-pci-device.&#123;&#123; .class &#125;&#125;-&#123;&#123; .device &#125;&#125;=with-cpuid</span></span><br><span class="line"><span class="string">    #        &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: pci.device</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            class: &#123;op: InRegexp, value: [&quot;^06&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            vendor: [&quot;8086&quot;]</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            AVX: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    # The following examples demonstrate vars field and back-referencing</span></span><br><span class="line"><span class="string">    #    # previous labels and vars</span></span><br><span class="line"><span class="string">    #    - name: &quot;my dummy kernel rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my.kernel.feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: kernel.version</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            major: &#123;op: Gt, value: [&quot;2&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;my dummy rule with no labels&quot;</span></span><br><span class="line"><span class="string">    #      vars:</span></span><br><span class="line"><span class="string">    #        &quot;my.dummy.var&quot;: &quot;1&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchExpressions: &#123;&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;my rule using backrefs&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my.backref.feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: rule.matched</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            vendor.io/my.kernel.feature: &#123;op: IsTrue&#125;</span></span><br><span class="line"><span class="string">    #            my.dummy.var: &#123;op: Gt, value: [&quot;0&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;kconfig template rule&quot;</span></span><br><span class="line"><span class="string">    #      labelsTemplate: |</span></span><br><span class="line"><span class="string">    #        &#123;&#123; range .kernel.config &#125;&#125;kconfig-&#123;&#123; .Name &#125;&#125;=&#123;&#123; .Value &#125;&#125;</span></span><br><span class="line"><span class="string">    #        &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: kernel.config</span></span><br><span class="line"><span class="string">    #          matchName: &#123;op: In, value: [&quot;SWAP&quot;, &quot;X86&quot;, &quot;ARM&quot;]&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfd-gc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nfd-gc</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_UID</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.uid</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/node-feature-discovery:v0.16.0-devel-179-gcc9cb875</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">20m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfd-master</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/control-plane</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nfd-master</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_UID</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.uid</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/node-feature-discovery:v0.16.0-devel-179-gcc9cb875</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enableServiceLinks:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfd-master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/control-plane</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfd-worker</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-server=nfd-master:8080</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nfd-worker</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_UID</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.uid</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/node-feature-discovery:v0.16.0-devel-179-gcc9cb875</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">5m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">64Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-boot</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-boot</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-etc/os-release</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-os-release</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-sys</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-proc/swaps</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-proc-swaps</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-usr/lib</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-usr-lib</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-lib</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-lib</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery/source.d/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">source-d</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">features-d</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfd-worker</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/boot</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-boot</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/proc/swaps</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-proc-swaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/os-release</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-os-release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/usr/lib</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-usr-lib</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/lib</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-lib</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/kubernetes/node-feature-discovery/source.d/</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">source-d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d/</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">features-d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br></pre></td></tr></table></figure><h4 id="gpu-feature-discovery部署"><a href="#gpu-feature-discovery部署" class="headerlink" title="gpu-feature-discovery部署"></a>gpu-feature-discovery部署</h4><p>Kubernetes device-pluging提供了许多可配置项，这些配置项可以设置为命令行选项或者环境变量，例如设置MIG策略，设备枚举等等，使用gpu-feature-discovery可以使用以label的形式来附加在Kubernetes的node资源对象上，随着配置的复杂，也可以抽象配置为configmap便于管理，部署gpu-feature前需要部署nfd（node-feature-discovery）,以下为配置相关的主要参数</p><p><code>migStrategy</code> : 是否开启mig策略（A100及以后版本的GPU支持），支持的参数为<code>none</code>,<code>single</code>,<code>mixed</code></p><p><code>sharing</code>:是否开启GPU共享，其中包含了两个参数<code>timeSlicing</code>和<code>mps</code>（都可以设置为空）</p><p><code>timeSlicing</code>: 开启共享模式的时间切片模式，配置对应的gpu资源的字段包含以下资源</p><ul><li><code>renameByDefault</code>: 是否默认重命名共享的GPU资源，设置为true后，kubelet上报的资源会变成<code>nvidia.com/gpu.shared</code>,当前测试v0.15.0版本默认禁用了重命名</li><li><code>failRequestsGreaterThanOne</code>:该字段的目的申请多个GPU副本并不会获取更多比例的GPU访问权，当设置为true时，对于超过一个GPU的资源请求会导致UnexpectedAdmissionError（建议默认设置为false）</li><li><code>resourcess</code>：该字段包含了以下四个字段<code>name</code>, 代表对应的GPU资源名，默认为<code>nvidia.com/gpu</code>，<code>reanme</code>字段表示要讲资源重命名为一个名称，当前测试v0.15.0版本默认禁用了重命名，<code>replicas</code>字段表示要将gpu共享的份数，当配置了比如说10时，可用的GPU资源会变成实际*Replicas，<code>device</code>表示需要配置的GPU，当前测试v0.15.0版本默认禁用了自定义设备</li></ul><p><img src="/image/GPUShare/label.png" alt="header"></p><p>nvidia-plugin-configs可以配置多个配置，根据节点来区分不同配置，以下dp-example-config0.yaml，dp-example-config1.yaml两个配置，分别是开启mig和不开启mig的配置，命名为T4-config和A800-conifg,可以创建多个节点的配置，然后根据label由nvidia-gpu-operator去下发不同节点的配置,例如以下命令和配置，并且可以通过node的label去选择该节点使用哪个device-plugin配置，具体的label是<strong>nvidia.com&#x2F;device-plugin.config <strong>，比如说在T4节点不能使用mig的情况下，就应该是</strong>nvidia.com&#x2F;device-plugin.config&#x3D;T4-config</strong>，然后gpu-feature-discovery就会读取T4-conifg的配置，将对应标签配置比如说<strong>nvidia.com&#x2F;mig.strategy&#x3D;none</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">kubectl create cm -n nvidia-device-plugin nvidia-plugin-configs \</span><br><span class="line">    --from-file=T4-config=/tmp/dp-example-config0.yaml \</span><br><span class="line">    --from-file=A800-config=/tmp/dp-example-config1.yaml</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; dp-example-config0.yaml</span></span><br><span class="line"><span class="string">version: v1</span></span><br><span class="line"><span class="string">flags:</span></span><br><span class="line"><span class="string">  migStrategy: &quot;none&quot; </span></span><br><span class="line"><span class="string">  failOnInitError: true</span></span><br><span class="line"><span class="string">  nvidiaDriverRoot: &quot;/&quot;</span></span><br><span class="line"><span class="string">  plugin:</span></span><br><span class="line"><span class="string">    passDeviceSpecs: false</span></span><br><span class="line"><span class="string">    deviceListStrategy: envvar</span></span><br><span class="line"><span class="string">    deviceIDStrategy: uuid</span></span><br><span class="line"><span class="string">sharing: #timeSlicing和MPS不能同时开启</span></span><br><span class="line"><span class="string">  timeSlicing:</span></span><br><span class="line"><span class="string">    renameByDefault: true</span></span><br><span class="line"><span class="string">    failRequestsGreaterThanOne: true</span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">    - name: nvidia.com/gpu</span></span><br><span class="line"><span class="string">      replicas: 10</span></span><br><span class="line"><span class="string">  mps:   </span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">        name: nvidia.com/gpu</span></span><br><span class="line"><span class="string">        rename: nvidia.com/gpu-1gb</span></span><br><span class="line"><span class="string">        replicas: 16</span></span><br><span class="line"><span class="string">        devices: [&quot;0&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; dp-example-config1.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">version: v1</span></span><br><span class="line"><span class="string">flags:</span></span><br><span class="line"><span class="string">  migStrategy: &quot;mixed&quot; # Only change from config1.yaml</span></span><br><span class="line"><span class="string">  failOnInitError: true</span></span><br><span class="line"><span class="string">  nvidiaDriverRoot: &quot;/&quot;</span></span><br><span class="line"><span class="string">  plugin:</span></span><br><span class="line"><span class="string">    passDeviceSpecs: false</span></span><br><span class="line"><span class="string">    deviceListStrategy: envvar</span></span><br><span class="line"><span class="string">    deviceIDStrategy: uuid</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>部署yaml文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-gpu-feature-discovery</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/pci-0302_10de.present</span> <span class="comment">#根据node-feature-discovery修改pci对应标签</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/cpu-model.vendor_id</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NVIDIA</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-feature-discovery-sidecar</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GFD_USE_NODE_FEATURE_API</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_MIG_MONITOR_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-feature-discovery-ctr</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">output-dir</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-feature-discovery-init</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">output-dir</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nvidia-plugin-configs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure><h4 id="nvidia-device-pluging部署"><a href="#nvidia-device-pluging部署" class="headerlink" title="nvidia-device-pluging部署"></a>nvidia-device-pluging部署</h4><p>部署yaml文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-role-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;nfd.k8s-sigs.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodefeatures&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/pci-0302_10de.present</span> <span class="comment">#根据node-feature-discovery修改pci对应标签</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/cpu-model.vendor_id</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NVIDIA</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">        <span class="attr">image:</span> </span><br><span class="line">        </span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-sidecar</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_MIG_MONITOR_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_VISIBLE_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_DRIVER_CAPABILITIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">compute,utility</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-ctr</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">SYS_ADMIN</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/kubelet/device-plugins</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/cdi</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cdi-root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-init</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/kubelet/device-plugins</span> <span class="comment">#注意宿主机的kubelet目录是否修改过</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/run/cdi</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cdi-root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nvidia-plugin-configs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure><p> 部署MPS相关组件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-mps-control-daemon</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/pci-0302_10de.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/cpu-model.vendor_id</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NVIDIA</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/usr/bin/1mps-control-daemon</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-sidecar</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mps-control-daemon</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_MIG_MONITOR_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_VISIBLE_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_DRIVER_CAPABILITIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">compute,utility</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-ctr</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/dev/shm</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mps-shm</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mps</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mps-root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mps-control-daemon</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mount-shm</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-mounts</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mps</span></span><br><span class="line">          <span class="attr">mountPropagation:</span> <span class="string">Bidirectional</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mps-root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-init</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">nvidia.com/mps.capable:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/nvidia/mps</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/nvidia/mps/shm</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-shm</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nvidia-plugin-configs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure><p>部署MGI管理组件：</p><p>mig配置一般来说需要手动配置，以下该组件可以根据node-label自动切分进行mig配置，其中mig-parted-config的配置，需要你对不同的型号进行不同的配置，标准对应了<strong>A100-40G</strong>,<strong>A800-40G</strong>,<strong>A100-80G</strong>,<strong>A800-80G</strong>,<strong>A30-24GB</strong>,<strong>PG506-96GB</strong> 等多种规格的GPU显卡服务器，同时你也可以自定义你的分配方式，其中<code>devices</code>字段对应服务器中显卡的index，<code>devicesfilter</code>对应需要过滤的的型号。mig服务在enable分配时，需要关闭所有连接该节点GPU的服务（其中包含gpu-clients配置的服务，但是这仅仅会关闭systemd起的服务，容器起的服务需要手动关闭，比如说dcgm-exporter等），然后可以使用label来控制具体的label是<strong>nvidia.com&#x2F;mig.config</strong>，你可以选择的配置就是mig-parted-config中的配置，比如说<strong>all-1g.10gb</strong>，mig-manager就会把所有gpu切分为7个<strong>1g.10gb</strong>规格</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">nvidia.com/gpu.deploy.mig-manager:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-mig-manager:v0.7.0-ubi8</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/mig-parted-config/config.yaml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GPU_CLIENTS_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/gpu-clients/clients.yaml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_ROOT_MOUNT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/host&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_NVIDIA_DIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/usr/local/nvidia&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_KUBELET_SYSTEMD_SERVICE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubelet.service&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_MIG_MANAGER_STATE_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/etc/systemd/system/nvidia-mig-manager.service.d/override.conf&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_GPU_CLIENTS_NAMESPACE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;default&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WITH_SHUTDOWN_HOST_GPU_CLIENTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WITH_REBOOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/gpu-clients</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mig-parted-config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-root</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-role-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">clients.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    version: v1</span></span><br><span class="line"><span class="string">    systemd-services:</span></span><br><span class="line"><span class="string">      - nvsm.service</span></span><br><span class="line"><span class="string">      - nvsm-mqtt.service</span></span><br><span class="line"><span class="string">      - nvsm-core.service</span></span><br><span class="line"><span class="string">      - nvsm-api-gateway.service</span></span><br><span class="line"><span class="string">      - nvsm-notifier.service</span></span><br><span class="line"><span class="string">      - nv_peer_mem.service</span></span><br><span class="line"><span class="string">      - nvidia-dcgm.service</span></span><br><span class="line"><span class="string">      - dcgm.service</span></span><br><span class="line"><span class="string">      - dcgm-exporter.service</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    version: v1</span></span><br><span class="line"><span class="string">    mig-configs:</span></span><br><span class="line"><span class="string">      all-disabled:</span></span><br><span class="line"><span class="string">        - devices: all</span></span><br><span class="line"><span class="string">          mig-enabled: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">      <span class="attr">all-1g.5gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.5gb&quot;:</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">      <span class="attr">all-1g.5gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;1g.5gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.10gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.10gb&quot;:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-3g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;3g.20gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-4g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;4g.20gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-7g.40gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;7g.40gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-80GB, A800-80GB, A100-40GB, A800-40GB</span></span><br><span class="line">      <span class="attr">all-1g.10gb:</span></span><br><span class="line">        <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B210DE&quot;</span>, <span class="string">&quot;0x20B510DE&quot;</span>, <span class="string">&quot;0x20F310DE&quot;</span>, <span class="string">&quot;0x20F510DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.10gb&quot;:</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B010DE&quot;</span>, <span class="string">&quot;0x20B110DE&quot;</span>, <span class="string">&quot;0x20F110DE&quot;</span>, <span class="string">&quot;0x20F610DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.10gb&quot;:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">      <span class="attr">all-1g.10gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;1g.10gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">      <span class="attr">all-1g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.20gb&quot;:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.20gb&quot;:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-3g.40gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;3g.40gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-4g.40gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;4g.40gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-7g.80gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;7g.80gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A30-24GB</span></span><br><span class="line">      <span class="attr">all-1g.6gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.6gb&quot;:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-1g.6gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;1g.6gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.12gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.12gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.12gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;2g.12gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-4g.24gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;4g.24gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># PG506-96GB</span></span><br><span class="line">      <span class="attr">all-1g.12gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.12gb&quot;:</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.24gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.24gb&quot;:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-3g.48gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;3g.48gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-7g.96gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;7g.96gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-40GB, A100-80GB, A800-40GB, A800-80GB, A30-24GB, PG506-96GB</span></span><br><span class="line">      <span class="attr">all-balanced:</span></span><br><span class="line">        <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B010DE&quot;</span>, <span class="string">&quot;0x20B110DE&quot;</span>, <span class="string">&quot;0x20F110DE&quot;</span>, <span class="string">&quot;0x20F610DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.5gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.10gb&quot;:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">&quot;3g.20gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B210DE&quot;</span>, <span class="string">&quot;0x20B510DE&quot;</span>, <span class="string">&quot;0x20F310DE&quot;</span>, <span class="string">&quot;0x20F510DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.10gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.20gb&quot;:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">&quot;3g.40gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># A30-24GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> <span class="string">&quot;0x20B710DE&quot;</span></span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.6gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.12gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># PG506-96GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> <span class="string">&quot;0x20B610DE&quot;</span></span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.12gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.24gb&quot;:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">&quot;3g.48gb&quot;:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="对比结论"><a href="#对比结论" class="headerlink" title="对比结论"></a>对比结论</h3><h4 id="多种并发机制对比"><a href="#多种并发机制对比" class="headerlink" title="多种并发机制对比"></a>多种并发机制对比</h4><table><thead><tr><th align="center"></th><th>Streams</th><th>MPS</th><th>Time-Slicing</th><th>MIG</th><th>VGPU</th></tr></thead><tbody><tr><td align="center">分区方式(Partition Types)</td><td>单进程（Single Process）</td><td>逻辑分割(Logical)</td><td>临时（单进程）(Temporal (Single process))</td><td>物理分割（Physical）</td><td>临时+物理VMS虚拟化（Temporal &amp; Physical – VMs）</td></tr><tr><td align="center">最大分割数（Max Partitions）</td><td>无限制</td><td>48</td><td>无限制</td><td>7</td><td>变量可配置</td></tr><tr><td align="center">SM隔离 (SM Performance Isolation)</td><td>不支持</td><td>支持（但是仅支持百分比，不支持分区）</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">内存保护（Memory Protection）</td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">内存带宽Qos（Memory Bandwidth QoS）</td><td>不支持</td><td>不支持</td><td>不支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">故障隔离（Error Isolation）</td><td>不支持</td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">跨分区互操作性（Cross-Partition Interop</td><td>永远</td><td>进程间通信（IPC）</td><td>有限的进程间通信（Limited IPC）</td><td>有限的进程间通信（Limited IPC）</td><td>不支持</td></tr><tr><td align="center">重新配置（Reconfigure）</td><td>动态</td><td>进程启动时</td><td>N&#x2F;A</td><td>空闲时（When idle）</td><td>N&#x2F;A</td></tr><tr><td align="center">GPU监控(GPU Management (telemetry))</td><td>N&#x2F;A</td><td>有限的GPU metrics(Limited GPU metrics)</td><td>N&#x2F;A</td><td>支持（适用GPU metrics，支持容器化）</td><td>支持（适配上层虚拟化工具相关监控）</td></tr><tr><td align="center">用例和使用场景</td><td>优化单个应用程序的并发性</td><td>在并行运行多个应用程序但可以处理优先恢复性处理</td><td>多应用程序同时运行并且对延迟不敏感或能够容忍抖动</td><td>并行运行多个应用程序但需要恢复性处理和QoS</td><td>通过虚拟化支持 GPU 上的多租户</td></tr></tbody></table><p>以下是Volta-MPS和Pre-Volta MPS的对比</p><ol><li><strong>资源管理方式：</strong><ul><li><strong>Pre-Volta MPS：</strong> 在 Pre-Volta MPS 中，服务器管理与单个 CUDA 上下文相关的硬件资源。MPS 客户端的 CUDA 上下文通过 MPS 服务器进行工作处理，使客户端 CUDA 上下文能够绕过与时间片调度相关的硬件限制，允许其 CUDA 内核同时执行。</li><li><strong>Volta MPS：</strong> 在 Volta MPS 中，Volta 提供了新的硬件功能，减少了 MPS 服务器必须管理的硬件资源类型。在 Volta 中，客户端 CUDA 上下文管理大部分硬件资源，并直接向硬件提交工作。Volta MPS 服务器调节剩余的共享资源，以确保通过单个客户端提交的工作可以同时调度，且不涉及关键执行路径。</li></ul></li><li><strong>通信方式：</strong><ul><li><strong>Pre-Volta MPS：</strong> MPS 客户端与 MPS 服务器之间的通信完全封装在 CUDA 驱动程序的 CUDA API 后面。因此，对于 MPI 程序而言，MPS 是透明的。</li><li><strong>Volta MPS：</strong> 通信方式与 Pre-Volta MPS 类似，但是 Volta MPS 允许客户端 CUDA 上下文保留其上行调用处理线程和任何异步执行器线程。MPS 服务器为每个客户端创建一个额外的上行调用处理线程，并为每个客户端创建一个工作线程。</li></ul></li><li><strong>硬件资源分配：</strong><ul><li><strong>Pre-Volta MPS：</strong> 在 Pre-Volta MPS 中，硬件资源的分配由 MPS 服务器管理，客户端通过服务器获取资源。</li><li><strong>Volta MPS：</strong> 在 Volta MPS 中，客户端直接管理大部分硬件资源，而 MPS 服务器调节共享资源，以确保同时调度来自各个客户端的工作。</li></ul></li></ol><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>- [1] <a href="https://developer.nvidia.com/zh-cn/blog/improving-gpu-utilization-in-kubernetes/">Nvidia</a><br>- [2] <a href="https://docs.nvidia.com/datacenter/tesla/mig-user-guide/">Nvidia MIG</a><br>- [3] <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-sharing.html">Nvidia time-slice</a><br>- [4] <a href="https://docs.nvidia.com/deploy/mps/index.html#topic_5_1_1">Nvidia MPS</a></p>]]></content>
      
      
      <categories>
          
          <category> GPU </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> GPU </tag>
            
            <tag> NVIDIA </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
