<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>NVIDIA共享GPU方案</title>
      <link href="/posts/65526.html"/>
      <url>/posts/65526.html</url>
      
        <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>NVIDIA GPU硬件结合CUDA软件，提供了多重并发机制，以此来提高GPU的利用率。分别是从软件层面和硬件层面，包括CUDA流，time slice时间切片(compute preemption)，MPS(Multi-Process with CUDA)m,MIG(Multi-Instance GPU), VGPU(virtualization GPU)   </p><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p>CUDA是一个通用的并行计算平台和编程模型，利用NVIDIA GPU中的并行计算引擎来解决许多复杂的计算问题，相比在CPU上效率更高。从一个CUDA程序从为特定GPU创建一个CUDA上下文开始，上下文既可以通过驱动程序API显式地创建，也可以通过运行时API隐式地创建。上下文封装了程序所需的所有硬件资源，使程序能够管理内存并使用特定GPU</p><p>在GPU上的计算流程通常涉及将数据复制到先前分配的GPU内存区域中，运行一个CUDA核函数操作该数据，然后将结果从GPU内存复制回系统内存。CUDA核函数由一组线程组成，这些线程在GPU的计算引擎上并行执行</p><p>使用CUDA启动的GPU上的所有任务都是显式地启动到一个CUDA流中，或者隐式地使用默认流启动。流是一个软件抽象，代表一系列命令，这些命令可以是内核、复制和其他命令的组合，按顺序执行。在两个不同的流中启动的工作可以同时执行，从而实现了粗粒度的并行</p><p>CUDA流是由驱动程序别名定义到GPU上的一个或多个工作队列。工作队列是代表流中要由GPU上的特定引擎执行的命令子集的硬件资源，例如内核执行或内存复制。具有Hyper-Q的GPU具有并发调度器，用于调度属于单个CUDA上下文的工作队列中的工作。从属于同一CUDA上下文的工作队列启动到计算引擎的工作可以在GPU上并行执行</p><p>GPU还有一个时间切片调度器，用于调度属于不同CUDA上下文的工作队列中的工作。从不同CUDA上下文的工作队列启动到计算引擎的工作不能同时执行。如果从单个CUDA上下文启动的工作不足以使用其可用资源，这可能会导致GPU的计算资源被低效利用。</p><p><img src="/image/GPUShare/CS.png" alt="header"></p><p>该图表显示了在没有MPS的情况下运行由多个操作系统进程组成的MPI应用程序时，CUDA核函数的可能调度情况。请注意，虽然每个MPI进程内部的CUDA核函数可能会同时调度，但每个MPI进程在整个GPU上被分配了一个串行调度的时间片</p><h2 id="cuda流"><a href="#cuda流" class="headerlink" title="cuda流"></a>cuda流</h2><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>对于gpu应用，可以通过cuda流（Stream）来管理对应的并发操作。流是指按顺序执行的命令序列（可能从属于不同的主机进程）。但是不同的流之间可以并发性乱序的执行自己想对应的命令，因为执行的不确定性，导致执行的结果的正确性不可控制。在所有命令的依赖项满足时，流上配置的命令可以执行，依赖项即可以是同一流的前置命令，也可以是其他不同流的命令。</p><h4 id="流的创建与销毁"><a href="#流的创建与销毁" class="headerlink" title="流的创建与销毁"></a>流的创建与销毁</h4><p>一个流的定义包含了以下操作，通过创建流对象，并将其这个对象指定为内核启动和主机&lt;-&gt;设备内存拷贝的序列中的参数，以下的示例代码会创建两个流，并且在页锁定内存中分配一个float类型的数组hostPtr</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cudaStream_t stream[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaStreamCreate</span>(&amp;stream[i]);</span><br><span class="line"><span class="type">float</span>* hostPtr;</span><br><span class="line"><span class="built_in">cudaMallocHost</span>(&amp;hostPtr, <span class="number">2</span> * size);</span><br></pre></td></tr></table></figure><p>以下的示例代码包含了，每个流包含了以下操作序列：从主机到设备的内存拷贝，一次内核启动，以及从设备到主机的内存拷贝。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(inputDevPtr + i * size, hostPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line">    MyKernel &lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;</span><br><span class="line">          (outputDevPtr + i * size, inputDevPtr + i * size, size);</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr + i * size, outputDevPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每个流将输入数组hostPtr的部分复制到设备内存中的数组inputDevPtr，通过调用Mykernel()方法在设备上处理inputDevPtr，处理结果为outputDevPtr,最后将结过outputDevPtr复制回hostPtr的相同部分。重叠行为是指流和流之间的重叠，在本次示例代码中，重叠部分就是指涉及到设备相关的，本例中使用了页锁定内存来存储hostPtr数组避免了overlap。</p><p>流的销毁和释放需要调用方法<code>cudaStreamDestroy()</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaStreamDestroy</span>(stream[i]);</span><br></pre></td></tr></table></figure><h4 id="默认流"><a href="#默认流" class="headerlink" title="默认流"></a>默认流</h4><p>如果内核启动或者主机&lt;-&gt;设备的内存拷贝的操作，没有指定任何的流作为参数，或者将流参数设置为0，则表示将使用默认流来操作，因此这些操作都是顺序执行的。</p><p>默认流是一个常规流，每个主机线程都有自己的默认流，对于编译的代码中使用<code>--default-stream per-thread</code> 或者在包含cuda.h和cuda_runtime.h的头文件中定义CUDA_API_PER_THREAD_DEFAULT_STREAM宏，都使用的是默认流。</p><p>对于使用<code>--default-stream</code>legacy标志编译的代码，默认流是一个特殊的流，被称之为NULL流，每个设备都有一个用于处理主机线程的NULL流。NULL流比较特殊，因为他会导致隐式同步。</p><h4 id="显示同步（Explicit-Synchronization）"><a href="#显示同步（Explicit-Synchronization）" class="headerlink" title="显示同步（Explicit Synchronization）"></a>显示同步（Explicit Synchronization）</h4><p>以下举例的是流之间多种的显示同步方法:</p><p><code>cudaDeviceSynchronize()</code> 等待所有主机线程的所有流中的所有前序命令完成</p><p><code>cudaStreamSynchronize()</code> 将流作为参数并且等待执行，直到给定流中的所有前序命令完成。该方法可以用来同步主机与特定的流，允许其他流在设备上执行</p><p><code>cudaStreamWaitEvent()</code> 将一个流和一个事件作为参数，并调用<code>cudaStreamWaitEvent()</code> 方法使得特定流的所有的命令都延迟执行，直到给定的所有事件完成后，才继续执行</p><p><code>cudaStreamQuery()</code> 给应用程序提供方法，用于感知流中的前置命令是否都已经完成了</p><h4 id="隐式同步（Implicit-Synchronization）"><a href="#隐式同步（Implicit-Synchronization）" class="headerlink" title="隐式同步（Implicit Synchronization）"></a>隐式同步（Implicit Synchronization）</h4><p>如果主机线程满足以下情况，那么来自不同流的两个命令不可以并发运行:</p><p>1.页锁定内存的分配</p><p>2.设备内存的分配</p><p>3.设备存储集</p><p>4.同一个设备内存中两个地址间的内存拷贝</p><p>5.任何在NULL流上执行的cuda命令</p><p>6.L1&#x2F;共享内存配置之间的切换（在Compute Capability 7.x支持）</p><p>需要依赖性检查的的操作，其中包括了与被检查的同一流上的启动操作和其他任意调用<code>cudaStreamQuery()</code> 的操作，遵循以下规则：</p><p>1.所有独立操作都需要在从属操作之前发出</p><p>2.任何类型的同步操作都应当尽可能延迟</p><h4 id="重叠行为（Overlapping-behavior）"><a href="#重叠行为（Overlapping-behavior）" class="headerlink" title="重叠行为（Overlapping behavior）"></a>重叠行为（Overlapping behavior）</h4><p>两个流之间重叠量取决于,每个流发出命令的顺序以及设备是否支持重叠的数据传输以及内核执行系统调用，以及并发的内核执行或者并发的数据传输</p><h5 id="数据传输和内核执行的重叠（Overlap-of-Data-Transfer-and-Kernel-Execution）"><a href="#数据传输和内核执行的重叠（Overlap-of-Data-Transfer-and-Kernel-Execution）" class="headerlink" title="数据传输和内核执行的重叠（Overlap of Data Transfer and Kernel Execution）"></a>数据传输和内核执行的重叠（Overlap of Data Transfer and Kernel Execution）</h5><p>一些设备可以在内核执行系统调用时，可以异步的从GPU或者向GPU复制内存的操作。应用程序可以通过<code>asyncEngineCount</code> 来检查设备的属性，来确定设备是支持该功能，值大于0时，表示该设备支持。如果涉及到主机内存的拷贝操作，那必须是锁定页面的内存。</p><p>当设备支持<code>concurrentKernels</code> 特性时，可以在内核执行的同时，进行设备内复制,当设备支持<code>asyncEngineCount</code> 特性时，可以在内核执行的同时，也可以从设备进行复制。设备内复制是通过标准的内存复制函数发起的，其目的地址和源地址都是位于同一设备</p><h5 id="并发内核执行（Concurrent-Kernel-Execution）"><a href="#并发内核执行（Concurrent-Kernel-Execution）" class="headerlink" title="并发内核执行（Concurrent Kernel Execution）"></a>并发内核执行（Concurrent Kernel Execution）</h5><p>部分设备的计算能力支持2.X及以上版本，可以并发的执行多个内核。应用可以通过<code>concurrentKernels </code> 来检查设备的属性，支持该功能的设备，该属性的值等于1</p><p>一个设备可以并发执行的最大内核启动数取决于它的计算能力，如下表所示。</p><table><thead><tr><th>Technical Specifications</th><th>5.0</th><th>5.2</th><th>5.3</th><th>6.0</th><th>6.1</th><th>6.2</th><th>7.0</th><th>7.2</th><th>7.5</th><th>8.0</th><th>8.6</th><th>8.7</th><th>8.9</th><th>9.0</th></tr></thead><tbody><tr><td>Maximum number of resident grids per device (Concurrent Kernel Execution)</td><td>32</td><td>32</td><td>16</td><td>128</td><td>32</td><td>16</td><td>128</td><td>16</td><td>128</td><td>128</td><td>128</td><td>128</td><td>128</td><td>128</td></tr></tbody></table><p>来自一个CUDA的上下文的内核不能与另一个CUDA上下文的内核并发执行，GPU可以进行时间切片，为每个上下文提供forward progress。如果用户希望在SM上同时运行来自多个进程的内核，必须开启MPS。</p><p>内核大量使用纹理内存或者使用大量的本地内存的话，该内核就不太能和其他内核并发执行。</p><h5 id="并发数据传输（Concurrent-Data-Transfers）"><a href="#并发数据传输（Concurrent-Data-Transfers）" class="headerlink" title="并发数据传输（Concurrent Data Transfers）"></a>并发数据传输（Concurrent Data Transfers）</h5><p>部分设备的计算能力支持2.X及以上版本，可以重叠设备的拷贝，应用可以通过<code>asyncEngineCount</code>来检查设备的属性，是否支持该功能，为了能够实现重叠拷贝，涉及到的传输的任意主机内存必须是页锁定的。</p><p>例如，在不支持并发数据传输的设备上，create和destruction的示例代码的两个流并不会发生重叠行为，因为从主机到设备的内存拷贝，是将设备到主机的内存拷贝发送到stream[0]之后，才发送到stream[1]的。</p><p>以下的示例代码，在支持并发数据传输的设备上，两个流确实会发生重叠，从主机到设备的内存拷贝的操作发送到stream[1]流上与从设备到主机的内存拷贝拷贝操作发送到stream[0]以及与发送到stream[0]的内核启动操作都有可能发生重叠</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(inputDevPtr + i * size, hostPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    MyKernel&lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;</span><br><span class="line">          (outputDevPtr + i * size, inputDevPtr + i * size, size);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i)</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr + i * size, outputDevPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(inputDevPtr + i * size, hostPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line">    MyKernel &lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;</span><br><span class="line">          (outputDevPtr + i * size, inputDevPtr + i * size, size);</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr + i * size, outputDevPtr + i * size,</span><br><span class="line">                    size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="主机函数（回调函数-Host-Functions-CallBacks）"><a href="#主机函数（回调函数-Host-Functions-CallBacks）" class="headerlink" title="主机函数（回调函数 Host Functions CallBacks）"></a>主机函数（回调函数 Host Functions CallBacks）</h5><p>运行时通过<code>cudaLaunchHostFunc()</code>函数提供了可以在流中任意节点插入CPU函数调用的能力，一旦在回调之前，流上所有的命令都执行完成了，那么提供的函数就会在主机上执行。</p><p>以下示例代码将主机到设备的内存拷贝，内核启动，设备到主机的内存拷贝发送到每个流之后，还将主机<code>MyCallback</code> 函数添加到了两个流中，该主机函数会在每个设备到主机的内存拷贝完成后在主机上开始执行。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> CUDART_CB <span class="title">MyCallback</span><span class="params">(<span class="type">void</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Inside callback %d\n&quot;</span>, (<span class="type">size_t</span>)data);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(devPtrIn[i], hostPtr[i], size, cudaMemcpyHostToDevice, stream[i]);</span><br><span class="line">    MyKernel&lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;(devPtrOut[i], devPtrIn[i], size);</span><br><span class="line">    <span class="built_in">cudaMemcpyAsync</span>(hostPtr[i], devPtrOut[i], size, cudaMemcpyDeviceToHost, stream[i]);</span><br><span class="line">    <span class="built_in">cudaLaunchHostFunc</span>(stream[i], MyCallback, (<span class="type">void</span>*)i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在主机函数完成之前，流中发出的命令不会开始执行，当一个主机函数添加到流中，该函数不能调用CUDA API（无论是直接或者间接的调用），因为有可能会导致死锁，因为他会等到自己完成后才开始执行。</p><h5 id="流优先级"><a href="#流优先级" class="headerlink" title="流优先级"></a>流优先级</h5><p>流的优先级可以在创建时使用<code>cudaStreamCreateWithPriority（）</code> 这个函数指定，在可允许的优先级范围（按照从高到低的顺序）可以通过<code>cudaDeviceGetStreamPriorityRange()</code> 函数获取。在运行时侧处理时，高优先级的流中待处理的工作会优先于低优先级的流中的任务。</p><p>以下的示例代码首先获取了当前设备的可允许的优先级范围，并创建对应最高和最低的可用的优先级的流</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the range of stream priorities for this device</span></span><br><span class="line"><span class="type">int</span> priority_high, priority_low;</span><br><span class="line"><span class="built_in">cudaDeviceGetStreamPriorityRange</span>(&amp;priority_low, &amp;priority_high);</span><br><span class="line"><span class="comment">// create streams with highest and lowest available priorities</span></span><br><span class="line">cudaStream_t st_high, st_low;</span><br><span class="line"><span class="built_in">cudaStreamCreateWithPriority</span>(&amp;st_high, cudaStreamNonBlocking, priority_high);</span><br><span class="line"><span class="built_in">cudaStreamCreateWithPriority</span>(&amp;st_low, cudaStreamNonBlocking, priority_low);</span><br></pre></td></tr></table></figure><h3 id="时间分片（Compute-Preemption）"><a href="#时间分片（Compute-Preemption）" class="headerlink" title="时间分片（Compute Preemption）"></a>时间分片（Compute Preemption）</h3><h4 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h4><p>在处理多个 CUDA 应用程序时，每个应用程序都可能没有充分利用 GPU 的资源，可以使用简单的超额订阅策略来利用 GPU 的时间切片调度器。从 Pascal 体系结构开始 支持这一点。这种技术有时被称为暂时 GPU 共享，在不同的 CUDA 应用程序之间切换上下文确实会带来成本，但一些未充分利用的应用程序仍然可以从该策略中受益。</p><h4 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h4><p>计算抢占（compute preemption）是GP100特有的新功能，计算抢占允许以指令级别的粒度中断正在GPU运行的计算任务。执行上下文（包括寄存器，共享内存等等）被交换到GPU的DRAM（Dynamic random-access memory），以便另一个应用程序可以替换进当前上下文并开始进行他的计算任务。抢占计算提供以下两个主要的优势:</p><ul><li>长时间运行的内核不再需要被分割成小的时间片段，避免当GPU同时用于计算和图形化时出现未响应的GUI和内核超时的情况。</li><li>可以在单GPU的系统环境进行交互式内核调试</li></ul><h3 id="MPS-Multi-Process-Service"><a href="#MPS-Multi-Process-Service" class="headerlink" title="MPS(Multi-Process Service)"></a>MPS(Multi-Process Service)</h3><h4 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h4><p>MPS是CUDA API的另一种与二进制兼容的实现，MPS运行时架构的目的是透明化地协同启动多进程的CUDA应用，一般来说比如说是MPI作业任务。利用NVIDIA（Kepler以后）的GPU上的Hyper-Q能力，Hyper-Q允许CUDA内核在同一GPU上并发处理。特别是GPU的计算能力对于单个应用程序过剩时，可以提供GPU的利用。</p><p><img src="/image/GPUShare/mps-cs.png" alt="header"></p><p>使用Volta之前版本的GPU MPS时，服务器管理与单个CUDA上下文相关联的硬件资源。属于MPS客户端的CUDA上下文通过MPS服务器传输它们的工作。这使得客户端CUDA上下文能够绕过与时间切片调度相关的硬件限制，并允许它们的CUDA核函数同时执行</p><p>Volta后版本的GPU提供了新的硬件功能，以减少MPS服务器必须管理的硬件资源类型。在Volta-MPS上，客户端CUDA上下文管理大多数硬件资源，并直接向硬件提交工作。Volta MPS服务器调解了需要确保单个客户端提交的工作同时调度所需的其余共享资源，并避开了关键的执行路径。</p><p>MPS客户端与MPS服务器之间的通信完全封装在CUDA API背后的CUDA驱动程序中。因此，对MPI程序来说，MPS是透明的。MPS客户端CUDA上下文保留其上调处理程序线程和任何异步执行器线程。MPS服务器为每个客户端创建一个额外的上调处理程序线程，并为每个客户端创建一个工作线程。</p><h4 id="Volta-MPS"><a href="#Volta-MPS" class="headerlink" title="Volta MPS"></a>Volta MPS</h4><p>Volta架构引入了新的MPS功能（V100即是Volta架构下的显卡），与之前架构的GPU的MPS功能相比，Volta架构下的MPS在以下方面有了关键的提升</p><ul><li>Volta MPS客户端会直接将任务提交给GPU去执行，不需要经过MPS的服务端</li><li>每个Volta MPS客户端会配置自己的GPU地址空间而不是像老板的MPS客户端共享GPU地址空间</li><li>Volta MPS支持资源限制的配置，支持QoS</li></ul><p><img src="/image/GPUShare/VoltaMPS.png" alt="header"></p><h4 id="MPS结构"><a href="#MPS结构" class="headerlink" title="MPS结构"></a>MPS结构</h4><p>MPS是由以下几个组件组成的一个对于CUDA API的CS架构的二进制运行时实现：</p><ul><li>控制守护进程-守护进程负责服务器的启停，以及协调服务器和客户端之间的连接</li><li>客户端运行时- MPS的客户端运行时内置于CUDA的驱动库中，可以被任意CUDA程序透明调用</li><li>服务器进程- 服务器进程是与客户端共享的GPU的连接，并给客户端之间提供并发能力</li></ul><h4 id="MPS的优劣势"><a href="#MPS的优劣势" class="headerlink" title="MPS的优劣势"></a>MPS的优劣势</h4><h5 id="提高GPU利用率"><a href="#提高GPU利用率" class="headerlink" title="提高GPU利用率"></a>提高GPU利用率</h5><p>单个进程可能无法充分利用GPU上可用的全部计算资源和内存带宽容量。MPS允许来自不同的进程的内核操作和内存复制操作在同一个GPU上重叠，实行更高的利用率和更短的运行时间。</p><h5 id="减少GPU上下文存储"><a href="#减少GPU上下文存储" class="headerlink" title="减少GPU上下文存储"></a>减少GPU上下文存储</h5><p>当不使用MPS的情况下，每个使用GPU的cuda进程都会在GPU上分配单独的存储和调度资源，而使用MPS的情况下，MPS服务器会为所有的客户端分配一个共享的GPU存储调度资源的副本。并且Volta MPS增加了MPS客户端之间的隔离</p><h5 id="减少GPU上下文的切换"><a href="#减少GPU上下文的切换" class="headerlink" title="减少GPU上下文的切换"></a>减少GPU上下文的切换</h5><p>当进程共享GPU时，他们的调度资源必须在GPU上进行切换（比如说timeSlicing共享的情况下）。而在使用MPS的情况下，由于MPS服务器为所有的客户端配置了共享的调度资源，因此从根本上消除了客户端之间调度时上下文的切换</p><h5 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h5><ul><li>MPS仅支持Liunx操作系统，在非linux系统上，MPS服务无法启动</li><li>MPS不支持Tegra平台，在Terga平台上，MPS服务无法启动</li><li>MPS仅支持CUDA_VISBILE_DEVICES 3.5及以上版本，低于3.5的版本，MPS服务无法启动</li><li>MPS的UVA（Unified Virtual Addressing）功能必须开启，默认情况下，2.0以上是都支持该功能特性的</li><li>MPS 客户端可以分配的页锁定主机内存受 tmpfs 文件系统（&#x2F;dev&#x2F;shm）的大小限制</li><li>Exclusive-mode的限制只针对MPS的服务端，对客户端不影响</li><li>系统只能有一个MPS服务端提供服务</li><li>MPS守护控制进程会将来自MPS服务端不同的用户的不同激活请求放入队列，导致用户间在GPU上进行串行的排他访问，不管GPU相关的排他设置</li><li>NVIDIA监控相关的进程，会将MPS-client客户端的操作统一归结到MPS服务端，以服务端名义上报（例如NVML API, nvidia-smi）</li></ul><h5 id="GPU计算模式"><a href="#GPU计算模式" class="headerlink" title="GPU计算模式"></a>GPU计算模式</h5><p>NVIDIA GPU支持以下三种计算模式</p><ul><li>PROHIBITED（禁止模式）- GPU不可用于计算应用程序</li><li>EXCLUSIVE_PROCESS （独占进程模式）- GPU一次只分配一个进程，并且各个进程线程可以同时向GPU提交工作任务</li><li>DEFAULT（默认模式）- 多个进程可以同时使用GPU，每个进程的各个线程可以同时向GPU提交工作任务</li></ul><p>有效地使用MPS机制会导致独占模式下所有MPS的客户端表现得像默认模式一样，MPS通过MPS服务端保持允许多个客户端连接，并使用GPU。</p><p>使用MPS时，建议使用独占模式，以确保只有单个MPS服务端正在使用GPU，因为是独占的情况，能确保该MPS服务是所有CUDA进程在该GPU上的唯一仲裁点（arbitration）</p><h5 id="内存保护和错误包容机制（Memory-Protection-and-Error-Containment-）"><a href="#内存保护和错误包容机制（Memory-Protection-and-Error-Containment-）" class="headerlink" title="内存保护和错误包容机制（Memory Protection and Error Containment ）"></a>内存保护和错误包容机制（Memory Protection and Error Containment ）</h5><h5 id="内存保护（Memory-Protection）"><a href="#内存保护（Memory-Protection）" class="headerlink" title="内存保护（Memory Protection）"></a>内存保护（Memory Protection）</h5><ul><li>Volta MPS客户端进程具有完全隔离的GPU地址空间</li><li>Volta之前的MPS客户端进程从同一GPU的虚拟地址空间的不同分区中分配内存 ，会出现以下情况：<ul><li>CUDA内核中的越界写入可能会修改另一个进程的CUDA可访问的内存状态，并且不会触发错误</li><li>CUDA内核中的越界读取可能会访问另一个进程修改的CUDA可访问内存，并且不会触发错误，导致发生未定义的行为</li></ul></li><li>Volta MPS操作限制在CUDA内核中的指针内存访问，任何CUDA API都限制MPS客户端访问该MPS客户端内存分区之外的任何资源，例如：不可能使用cudaMemcpy() API覆盖另一个MPS客户端的内存</li></ul><h5 id="错误容忍机制"><a href="#错误容忍机制" class="headerlink" title="错误容忍机制"></a>错误容忍机制</h5><p>Volta MPS支持有限的错误隔离：</p><ul><li>当由某个Volta MPS 客户端进程产生严重故障时，该故障将包含在共享该严重故障的GPU的所有客户端的子集中</li><li>当由某个Volta MPS 客户端进程产生严重故障时，该故障将包含在共享该严重故障的GPU的所有客户端的子集中，同时这个故障会报告给该子集中所有的客户端，但是不会指出是由哪个客户端导致了这个故障。值得注意的是，严重故障产生后，产生故障的这个客户端有责任退出进程，避免运行在该GPU上的其他客户端受到影响</li><li>一旦检测到有严重故障，MPS服务器将等待所有和受影响的GPU关联的客户端退出，禁止新的客户端连接到这些有故障的GPU上。MPS服务器的状态将从’ACTIVE’更改为’FAULT’。当所有受影响的GPU关联的客户端都退出后，MPS服务端在该GPU上重新创建上下文，并继续处理发送到该GPU的客户端请求。MPS服务端会将服务器状态再次更改为’ACTIVE’，表示可以重新接收处理客户端请求</li></ul><p>举例来说，如果系统有GPU设备0，1，2，并且有四个客户端clientA，clientB，clientC，clientD连接到MPS服务器，假设clientA运行在设备0上，clientB运行在设备0和1上，clientC运行在设备1上，clientD运行在设备2上。如果clientA产生了一个严重错误，由于clientB使用了设备0和1，GPU故障会被包含在设备0和1中，因此故障将会上报给clientA,clientB和clientC，而运行在设备2 GPU上的clientD则不会受到影响。MPS服务端将等待clientA，clientB， clientC退出，并在服务器状态为’FAULT’时拒绝任何新的客户端请求连接。clientA，clientB，clientC都退出后，MPS服务器端会在GPU设备0，1上重建上下文，然后重新接收客户端的请求，最后MPS服务端会将状态重新修改为’ACTIVE’</p><p>以下与错误相关的信息将会被服务端记录：</p><ul><li>如果是严重的内存故障，触发该故障的客户端的PID将会被记录</li><li>受到故障影响的设备的设备ID</li><li>所有受到影响的客户端的PID，所有的客户端都会变成’INACTIVE’状态，服务端则会变成’FAULT’状态</li></ul><p>而在Volta之前版本的MPS中，关于GPU共享调度的错误报告机制，有如下情况：</p><ul><li>由任何客户端产生的GPU故障，将会报告给所有的客户端，但是并不会指明具体是哪个客户端产生了错误</li><li>由一个客户端产生的严重故障，会使MPS服务端和所有的客户端都停止运行中的GPU相关进程</li></ul><p>CUDA 运行时或者CUDA驱动在用CPU调用CUDA API产生的错误仅会传递给对应访问的客户端</p><h4 id="多GPU系统MPS"><a href="#多GPU系统MPS" class="headerlink" title="多GPU系统MPS"></a>多GPU系统MPS</h4><p>MPS支持使用多个GPU，在具有多GPU的系统上，可以通过设置CUDA_VISIBLE_DEVICES来枚举希望使用的GPU。</p><p>当系统混合了Volta和Volta前架构的GPU，如果MPS服务段设置为枚举所有的Volta GPU，那么会丢弃所有Volta前的GPU。简单来说，MPS服务端仅能工作只在Volta型GPU上运行，或者仅在Volta前型号的GPU上运行，不能混合使用</p><h5 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h5><h5 id="客户端-服务端连接限制"><a href="#客户端-服务端连接限制" class="headerlink" title="客户端-服务端连接限制"></a>客户端-服务端连接限制</h5><p>Volta前的MPS服务端同支持每个设备16个客户端的CUDA上下文。Volta后的MPS服务端支持每个设备最多48个客户端的上下文。这些上下文可以分布在多个进程中。如果连接超出限制，CUDA应用将会无法创建CUDA上下文，调用<code>cuCtxCreate()</code>或者调用创建的第一个CUDA运行时API会报错，MPS服务端会记录失败的连接尝试</p><h5 id="Volta-MPS执行资源分配"><a href="#Volta-MPS执行资源分配" class="headerlink" title="Volta MPS执行资源分配"></a>Volta MPS执行资源分配</h5><p>Volta MPS有限的支持执行资源的分配，客户端上下文仅可以设置为可用线程，分配功能通常用于实现两个目标：</p><ul><li>减少客户端的内存占用：于每个MPS客户端进程具有完全隔离的地址空间，每个客户端上下文都会分配独立的上下文存储和调度资源。这些资源随着客户端可用线程的数量而缩放。默认情况下，每个MPS客户端都可以使用所有可用线程。由于MPS通常与同时运行的多个进程一起使用，使每个线程对每个客户端都可访问通常是不必要的，因此分配完整的上下文存储通常是浪费的。减少可用线程数将有效减少上下文存储分配大小</li><li>提高QoS: 分配机制可以用作经典的QoS机制来限制可用的计算带宽。减少可用线程的部分还将使客户端提交的工作集中到一组SM（Streaming Multiprocessor）中，减少对其他客户端提交的作业任务的干扰</li></ul><p>设置限制不会为任何MPS客户端上下文保留任何的专用资源，它只会限制客户端上下文的可使用资源是多少。从不同MPS客户端上下文启动的内核可能在同一个SM（Streaming Multiprocessor），具体取决于负载均衡的情况</p><p>下图为V100-GPU架构和SM（Streaming Multiprocessor）,其中包含了84个SM单元</p><p><img src="/image/GPUShare/02-sm.png" alt="header"><img src="/image/GPUShare/v100.png" alt="header"></p><p>默认情况下，每个客户端都被设置为可以访问所有可用线程。这将允许最大程度的调度自由度，但由于浪费的执行资源分配而产生更高的内存占用。可以通过nvidia-smi查询每个客户端进程的内存使用情况。</p><p>限制可以通过几种不同的机制进行设置，以达到不同的效果。分为两种机制：活动线程百分比和编程接口。而通过活动线程百分比进行分区被分类为两种策略：均匀分区和非均匀分区。</p><ul><li><p>MPS控制实用程序提供了两组命令来设置&#x2F;查询所有未来MPS客户端的限制,例如 ：  </p><ul><li>get_device_client_list [<PID>] - this lists the devices and PIDs of client applications that enumerated this device. It optionally takes the server instance PID.</li><li>set_default_active_thread_percentage <percentage> - this overrides the default active thread percentage for MPS servers. If there is already a server spawned, this command will only affect the next server. The set value is lost if a quit command is executed. The default is 100.</li><li>get_default_active_thread_percentage - queries the current default available thread percentage.</li><li>set_active_thread_percentage <PID> <percentage> - this overrides the active thread percentage for the MPS server instance of the given PID. All clients created with that server afterwards will observe the new limit. Existing clients are not affected.</li><li>get_active_thread_percentage <PID> - queries the current available thread percentage of the MPS server instance of the given PID.</li><li>set_default_device_pinned_mem_limit <dev> <value> - this sets the default device pinned memory limit for each MPS client. If there is already a server spawned, this command will only affect the next server. The set value is lost if a quit command is executed. The value must be in the form of an integer followed by a qualifier, either “G” or “M” that specifies the value in Gigabyte or Megabyte respectively. For example: In order to set limit to 10 gigabytes for device 0, the command used is:</li><li>set_default_device_pinned_mem_limit 0 10G.</li><li>By default memory limiting is disabled.</li><li>get_default_device_pinned_mem_limit <dev> - queries the current default pinned memory limit for the device.</li><li>set_device_pinned_mem_limit <PID> <dev> <value> - this overrides the device pinned memory limit for MPS servers. This sets the device pinned memory limit for each client of MPS server instance of the given PID for the device dev. All clients created with that server afterwards will observe the new limit. Existing clients are not affected. Example usage to set memory limit of 900MB for server with pid 1024 for device 0.set_device_pinned_mem_limit 1024 0 900M</li><li>get_device_pinned_mem_limit <PID> <dev> - queries the current device pinned memory limit of the MPS server instance of the given PID for the device dev.</li></ul></li><li><p>或者，所有未来的MPS客户端的限制也可以通过设置环境变量CUDA_MPS_ACTIVE_THREAD_PERCENTAGE来进行MPS控制进程。限制可以通过仅为客户端进程设置环境变量CUDA_MPS_ACTIVE_THREAD_PERCENTAGE来进一步约束新客户端</p></li></ul><p>非均匀活动线程百分比限制是针对每个客户端CUDA上下文配置的，并且可以在整个客户端进程中更改。执行的限制通过设备属性<code>cudaDevAttrMultiProcessorCoun</code>t反映，返回值的表示了由调用线程的当前客户端CUDA上下文使用的可用线程的部分</p><ul><li>统一分区机制可以通过设置环境变量<code>CUDA_MPS_ACTIVE_THREAD_PERCENTAGE</code>以及环境变量<code>CUDA_MPS_ENABLE_PER_CTX_DEVICE_MULTIPROCESSOR_PARTITIONING</code>来进一步约束的客户端CUDA上下文，进而限制MPS的客户端</li></ul><p>程序化分区限制是通过<code>cuCtxCreate_v3()</code>创建的客户端CUDA上下文配置的，其执行关联性<code>CUexecAffinityParam</code>指定上下文限制使用的SM数。可以通过<code>cuCtxGetExecAffinity()</code>查询上下文的执行限制</p><p>一种常见的分配策略是将可用线程等均匀地分配给每个MPS客户端进程（即，将活动线程百分比设置为100% &#x2F; n，对于预期的n个MPS客户端进程）。此策略将分配接近最小量的执行资源，但这种分配策略可能会限制偶尔可以利用空闲资源的客户端的性能</p><p>更优化的策略是将部分按照预期客户端数量的一半等均匀分配（即，将活动线程百分比设置为100% &#x2F; 0.5n），以便在有空闲资源时给负载平衡器更多的重叠执行自由度</p><p>非均匀活动线程百分比限制是针对每个客户端CUDA上下文配置的，并且可以在整个客户端进程中更改。执行的限制通过设备属性cudaDevAttrMultiProcessorCount反映，其值返回可以由调用线程的当前客户端CUDA上下文使用的可用线程的部分。</p><p>统一分区机制约束的限制可以通过设置环境变量<code>CUDA_MPS_ACTIVE_THREAD_PERCENTAGE</code>以及环境变量<code>CUDA_MPS_ENABLE_PER_CTX_DEVICE_MULTIPROCESSOR_PARTITIONING</code>来进一步约束新的客户端CUDA上下文。</p><p> 由程序化分区约束的限制是通过<code>cuCtxCreate_v3()</code>创建的客户端CUDA上下文配置的，其执行关联性<code>CUexecAffinityParam</code>指定上下文限制使用的SM数。可以通过<code>cuCtxGetExecAffinity()</code>查询上下文的执行限制,分配策略包含以下几种：</p><p>一种常见的分配策略是将可用线程等均匀地分配给每个MPS客户端进程（即，将活动线程百分比设置为100% &#x2F; n，对于预期的n个MPS客户端进程）。此策略将分配接近最小量的执行资源，但它可能会限制偶尔可以利用空闲资源的客户端的性能。</p><p>更优化的策略是将部分按照预期客户端数量的一半等均匀分配（即，将活动线程百分比设置为100% &#x2F; 0.5n），以便在有空闲资源时给负载平衡器更多的重叠执行自由度。</p><p>近乎最佳的策略是根据每个MPS客户端的工作负载非均匀地分配可用线程（即如果客户端1的工作负载和客户端2的工作负载的比率为30%: 70%，则将活动线程百分比设置为30%为客户端1，将活动线程百分比设置为70%为客户端2）。此策略将不同客户端提交的工作集中到不相交的SM集合中，并有效地最小化了不同客户端提交的作业之间的干扰</p><p>最优的策略是准确限制每个MPS客户端要使用的SM数，了解每个客户端的执行资源要求（例如，在具有84个SM的设备上，客户端1的SM数为24，客户端2的SM数为60）。此策略提供了比活动线程百分比更精细和更灵活的对工作将在其中运行的SM集的控制</p><p>如果使用活动线程百分比进行分区，则限制将在内部四舍五入到最接近的硬件支持的线程计数限制。如果使用编程接口进行分区，则限制将在内部四舍五入到最接近的硬件支持的SM计数</p><h5 id="线程和Linux调度"><a href="#线程和Linux调度" class="headerlink" title="线程和Linux调度"></a>线程和Linux调度</h5><p>在Volta前的版本的GPU上，如果启动的MPS客户端数量超过计算机上可用的逻辑核心数量，将会导致启动延迟增加，并且通常会由于Linux CFS（完全公平调度程序）对线程的调度方式而减慢客户端-服务器通信。对于使用多个GPU并为每个GPU启动MPS控制守护程序和服务器的设置，我们建议将每个MPS服务端固定到一个不同的核心。这可以通过使用实用程序<code>taskset</code>来实现，该实用程序允许将运行中的程序绑定到多个核心或在它们上启动新程序。要在MPS中实现这一点，请将控制守护程序绑定到特定核心上启动，例如，<code>taskset –c 0 nvidia-cuda-mps-control –d</code>。当MPS服务器启动时，进程亲和力将被继承</p><h5 id="Volta-MPS的内存限制"><a href="#Volta-MPS的内存限制" class="headerlink" title="Volta MPS的内存限制"></a>Volta MPS的内存限制</h5><p>在Volta MPS上，用户可以强制客户端遵循内存分配限制。这个机制提供了跨特定GPU上运行的MPS客户端的GPU内存细分化的能力，这使得调度和部署系统能够根据客户端的内存使用情况做出对应决策。如果客户端尝试分配超过预设限制的内存，则cuda内存分配调用将返回内存不足错误。内存限制还将考虑CUDA内部设备分配，这将帮助用户做出关于最佳GPU利用率的调度决策。用户可以通过一系列控制机制来限制MPS客户端的固定设备内存。<code>default</code>限制设置将强制将设备内存限制应用于所有未来生成的MPS服务器的所有MPS客户端。<code>per server</code>限制设置允许对内存资源限制进行更精细的控制，用户可以使用服务器PID选择性地设置内存限制，从而影响服务器的所有客户端。此外，MPS客户端还可以通过使用<code>CUDA_MPS_PINNED_DEVICE_MEM_LIMIT</code>环境变量进一步约束来自服务器的内存限制设置</p><h3 id="MIG（multi-instance-GPU）"><a href="#MIG（multi-instance-GPU）" class="headerlink" title="MIG（multi-instance GPU）"></a>MIG（multi-instance GPU）</h3><h4 id="背景-3"><a href="#背景-3" class="headerlink" title="背景"></a>背景</h4><p><img src="/image/GPUShare/mig.png" alt="header"></p><p>实例GPU（MIG）功能允许GPU（从NVIDIA Ampere架构开始）安全地分区为最多七个单独的GPU实例，用于CUDA应用程序，为多个用户提供独立的GPU资源，以实现最佳的GPU利用率。该功能特别适用于不完全饱和GPU计算能力的工作负载，因此用户可能希望并行运行不同的工作负载以最大化利用率。</p><p>对于具有多租户用例的云服务提供商（CSP），MIG机制确保一个客户端不会影响其他客户端的工作或调度，为客户提供了强隔离性。</p><p>通过MIG，每个实例的处理器都具有通过整个内存系统的单独和隔离的路径 - 芯片上的交叉点端口、L2缓存块、内存控制器和DRAM地址总线都被唯一地分配给一个单独的实例。这确保了单个用户的工作负载可以以可预测的吞吐量和延迟运行，具有相同的L2缓存分配和DRAM带宽，即使其他任务正在破坏它们自己的缓存或饱和它们的DRAM接口。MIG可以分区可用的GPU计算资源（包括流式多处理器或SM和GPU引擎，例如复制引擎或解码器），为不同的客户（如VM、容器或进程）提供定义良好的服务质量（QoS）和故障隔离。MIG使多个GPU实例可以在单个物理NVIDIA Ampere GPU上并行运行。</p><p>使用MIG，用户将能够像处理物理GPU一样查看和调度其新的虚拟GPU实例上的作业。MIG与Linux操作系统配合使用，支持使用Docker 容器，支持Kubernetes和使用Red Hat Virtualization和VMware vSphere等虚拟机。</p><p>MIG支持以下部署方式：</p><ul><li><p>裸机，包含容器以及Kubernetes</p></li><li><p>GPU直通虚拟化到Linux客户机，由上层hypervisor进行管理</p></li><li><p>vGPU，由上层hypervisor支持（MIG允许多个vGPU（从而是VM）在单个GPU上并行运行，同时保留了vGPU提供的隔离保证）</p></li></ul><h4 id="GPU-Instance"><a href="#GPU-Instance" class="headerlink" title="GPU Instance"></a>GPU Instance</h4><p>下图示例为A100-40GB（同理A800-80GB的型号，显存80g）</p><p><img src="/image/GPUShare/A100.png" alt="header"></p><p>mig机制可以将其分为最多7个设备，所以A800-80G可以包含以下7几种配置7个<strong>1g.10gb</strong>,4个<strong>1g.20gb</strong>,1个<strong>1g.10gb+me</strong>,3个<strong>2g.20gb</strong>,2个<strong>3g.40gb</strong>,1个<strong>4g.40gb</strong>,1个<strong>7g.80gb</strong></p><p>建一个GPU实例（GI）需要将一定数量的内存切片与一定数量的计算切片组合起来。在下面的图表中，一个5GB的内存切片与一个计算切片结合起来创建了一个<strong>1g.5gb</strong>的GI配置(对应的A800-80GB的情况就是<strong>1g.10gb</strong>的配置),还有一个是4个计算切片和4个5GB内存切片组合的<strong>4g.20gb</strong>的GI配置（对应的A800-80GB的情况就是<strong>4g.40gb</strong>的配置）</p><p><img src="/image/GPUShare/mig1g.5g.png" alt="header"></p><p><img src="/image/GPUShare/mig.4g.20g.png" alt="header"></p><p>同理，使用上面的<strong>4g.20gb</strong>示例，可以创建一个CI，仅使用第一个计算切片，如下所示：</p><p><img src="/image/GPUShare/mig.1c.4g.20gb.png" alt="header"></p><p>在这种情况下，可以通过选择任何计算切片来创建4个不同的CI。也可以将两个计算切片结合在一起，创建一个2c.4g.20gb配置，除此之外，还可以组合 3 个计算切片以创建计算配置，或者可以组合所有 4 个计算切片以创建 <strong>3c.4g.20gb</strong> 、 <strong>4c.4g.20gb</strong> 计算配置。 合并所有 4 个计算切片时，配置简称为 <strong>4g.20gb</strong> </p><p><img src="/image/GPUShare/mig.2c.4g.20gb.png" alt="header"></p><p>A100(A800)的mig配置如下图所示：</p><p><img src="/image/GPUShare/a100-mig-profile.png" alt="header"></p><h3 id="Kubernetes部署相关组件配置"><a href="#Kubernetes部署相关组件配置" class="headerlink" title="Kubernetes部署相关组件配置"></a>Kubernetes部署相关组件配置</h3><p>从 CUDA 11.1 （ R455 +驱动程序）开始， CUDA 应用程序的时间片持续时间可通过**<code>nvidia-smi</code>**实用程序：</p><p>![header](image&#x2F;GPUShare&#x2F;nvidia-smi compute-policy.png)</p><p>在Kubernetes中，NVIDIA GPU是以device-pluging的形式，作为node的资源提供。然而，在device-pluging的框架下仅允许将设备（包括 GPU （作为<code>nvidia.com/gpu</code>）作为整数资源进行上报，不允过度订阅，而下文则讨论的是使用时间切片在Kubernetes中超分gpu的方案，首先需要需要部署以下的组件来进行gpu的配置</p><h4 id="node-feature-discovery-部署"><a href="#node-feature-discovery-部署" class="headerlink" title="node-feature-discovery 部署"></a>node-feature-discovery 部署</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.14.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodefeaturerules.nfd.k8s-sigs.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">NodeFeatureRule</span></span><br><span class="line">    <span class="attr">listKind:</span> <span class="string">NodeFeatureRuleList</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">nodefeaturerules</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfr</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">nodefeaturerule</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1alpha1</span></span><br><span class="line">    <span class="attr">schema:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">          NodeFeatureRule resource specifies a configuration for feature-based</span></span><br><span class="line"><span class="string">          customization of node objects, such as node labeling.</span></span><br><span class="line"><span class="string"></span>        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">apiVersion:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              APIVersion defines the versioned schema of this representation of an object.</span></span><br><span class="line"><span class="string">              Servers should convert recognized schemas to the latest internal value, and</span></span><br><span class="line"><span class="string">              may reject unrecognized values.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">kind:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              Kind is a string value representing the REST resource this object represents.</span></span><br><span class="line"><span class="string">              Servers may infer this from the endpoint the client submits requests to.</span></span><br><span class="line"><span class="string">              Cannot be updated.</span></span><br><span class="line"><span class="string">              In CamelCase.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">NodeFeatureRuleSpec</span> <span class="string">describes</span> <span class="string">a</span> <span class="string">NodeFeatureRule.</span></span><br><span class="line">            <span class="attr">properties:</span></span><br><span class="line">              <span class="attr">rules:</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">Rules</span> <span class="string">is</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">node</span> <span class="string">customization</span> <span class="string">rules.</span></span><br><span class="line">                <span class="attr">items:</span></span><br><span class="line">                  <span class="attr">description:</span> <span class="string">Rule</span> <span class="string">defines</span> <span class="string">a</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">node</span> <span class="string">customization</span> <span class="string">such</span> <span class="string">as</span></span><br><span class="line">                    <span class="string">labeling.</span></span><br><span class="line">                  <span class="attr">properties:</span></span><br><span class="line">                    <span class="attr">annotations:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Annotations</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">extendedResources:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">ExtendedResources</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">labels:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Labels</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">labelsTemplate:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                        LabelsTemplate specifies a template to expand for dynamically generating</span></span><br><span class="line"><span class="string">                        multiple labels. Data (after template expansion) must be keys with an</span></span><br><span class="line"><span class="string">                        optional value (&lt;key&gt;[=&lt;value&gt;]) separated by newlines.</span></span><br><span class="line"><span class="string"></span>                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                    <span class="attr">matchAny:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">MatchAny</span> <span class="string">specifies</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">matchers</span> <span class="string">one</span> <span class="string">of</span> <span class="string">which</span></span><br><span class="line">                        <span class="string">must</span> <span class="string">match.</span></span><br><span class="line">                      <span class="attr">items:</span></span><br><span class="line">                        <span class="attr">description:</span> <span class="string">MatchAnyElem</span> <span class="string">specifies</span> <span class="string">one</span> <span class="string">sub-matcher</span> <span class="string">of</span> <span class="string">MatchAny.</span></span><br><span class="line">                        <span class="attr">properties:</span></span><br><span class="line">                          <span class="attr">matchFeatures:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">MatchFeatures</span> <span class="string">specifies</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">matcher</span></span><br><span class="line">                              <span class="string">terms</span> <span class="string">all</span> <span class="string">of</span> <span class="string">which</span> <span class="string">must</span> <span class="string">match.</span></span><br><span class="line">                            <span class="attr">items:</span></span><br><span class="line">                              <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                FeatureMatcherTerm defines requirements against one feature set. All</span></span><br><span class="line"><span class="string">                                requirements (specified as MatchExpressions) are evaluated against each</span></span><br><span class="line"><span class="string">                                element in the feature set.</span></span><br><span class="line"><span class="string"></span>                              <span class="attr">properties:</span></span><br><span class="line">                                <span class="attr">feature:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">Feature</span> <span class="string">is</span> <span class="string">the</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">feature</span></span><br><span class="line">                                    <span class="string">set</span> <span class="string">to</span> <span class="string">match</span> <span class="string">against.</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">matchExpressions:</span></span><br><span class="line">                                  <span class="attr">additionalProperties:</span></span><br><span class="line">                                    <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                      MatchExpression specifies an expression to evaluate against a set of input</span></span><br><span class="line"><span class="string">                                      values. It contains an operator that is applied when matching the input and</span></span><br><span class="line"><span class="string">                                      an array of values that the operator evaluates the input against.</span></span><br><span class="line"><span class="string"></span>                                    <span class="attr">properties:</span></span><br><span class="line">                                      <span class="attr">op:</span></span><br><span class="line">                                        <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                        <span class="attr">enum:</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                        <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                      <span class="attr">value:</span></span><br><span class="line">                                        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                          Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                          against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                          IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                          operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                          In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                        <span class="attr">items:</span></span><br><span class="line">                                          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                        <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                                    <span class="attr">required:</span></span><br><span class="line">                                    <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                    MatchExpressions is the set of per-element expressions evaluated. These</span></span><br><span class="line"><span class="string">                                    match against the value of the specified elements.</span></span><br><span class="line"><span class="string"></span>                                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                                <span class="attr">matchName:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                    MatchName in an expression that is matched against the name of each</span></span><br><span class="line"><span class="string">                                    element in the feature set.</span></span><br><span class="line"><span class="string"></span>                                  <span class="attr">properties:</span></span><br><span class="line">                                    <span class="attr">op:</span></span><br><span class="line">                                      <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                      <span class="attr">enum:</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                      <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                    <span class="attr">value:</span></span><br><span class="line">                                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                        Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                        against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                        IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                        operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                        In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                      <span class="attr">items:</span></span><br><span class="line">                                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                                  <span class="attr">required:</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                              <span class="attr">required:</span></span><br><span class="line">                              <span class="bullet">-</span> <span class="string">feature</span></span><br><span class="line">                              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                        <span class="attr">required:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">matchFeatures</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                    <span class="attr">matchFeatures:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">MatchFeatures</span> <span class="string">specifies</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">matcher</span> <span class="string">terms</span></span><br><span class="line">                        <span class="string">all</span> <span class="string">of</span> <span class="string">which</span> <span class="string">must</span> <span class="string">match.</span></span><br><span class="line">                      <span class="attr">items:</span></span><br><span class="line">                        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                          FeatureMatcherTerm defines requirements against one feature set. All</span></span><br><span class="line"><span class="string">                          requirements (specified as MatchExpressions) are evaluated against each</span></span><br><span class="line"><span class="string">                          element in the feature set.</span></span><br><span class="line"><span class="string"></span>                        <span class="attr">properties:</span></span><br><span class="line">                          <span class="attr">feature:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">Feature</span> <span class="string">is</span> <span class="string">the</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">feature</span> <span class="string">set</span> <span class="string">to</span></span><br><span class="line">                              <span class="string">match</span> <span class="string">against.</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">matchExpressions:</span></span><br><span class="line">                            <span class="attr">additionalProperties:</span></span><br><span class="line">                              <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                MatchExpression specifies an expression to evaluate against a set of input</span></span><br><span class="line"><span class="string">                                values. It contains an operator that is applied when matching the input and</span></span><br><span class="line"><span class="string">                                an array of values that the operator evaluates the input against.</span></span><br><span class="line"><span class="string"></span>                              <span class="attr">properties:</span></span><br><span class="line">                                <span class="attr">op:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                  <span class="attr">enum:</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                  <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">value:</span></span><br><span class="line">                                  <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                    Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                    against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                    IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                    operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                    In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                  <span class="attr">items:</span></span><br><span class="line">                                    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                              <span class="attr">required:</span></span><br><span class="line">                              <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              MatchExpressions is the set of per-element expressions evaluated. These</span></span><br><span class="line"><span class="string">                              match against the value of the specified elements.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                          <span class="attr">matchName:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              MatchName in an expression that is matched against the name of each</span></span><br><span class="line"><span class="string">                              element in the feature set.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">properties:</span></span><br><span class="line">                              <span class="attr">op:</span></span><br><span class="line">                                <span class="attr">description:</span> <span class="string">Op</span> <span class="string">is</span> <span class="string">the</span> <span class="string">operator</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied.</span></span><br><span class="line">                                <span class="attr">enum:</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">In</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">NotIn</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">InRegexp</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">Exists</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">DoesNotExist</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">Gt</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">Lt</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">GtLt</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">IsTrue</span></span><br><span class="line">                                <span class="bullet">-</span> <span class="string">IsFalse</span></span><br><span class="line">                                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                              <span class="attr">value:</span></span><br><span class="line">                                <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                                  Value is the list of values that the operand evaluates the input</span></span><br><span class="line"><span class="string">                                  against. Value should be empty if the operator is Exists, DoesNotExist,</span></span><br><span class="line"><span class="string">                                  IsTrue or IsFalse. Value should contain exactly one element if the</span></span><br><span class="line"><span class="string">                                  operator is Gt or Lt and exactly two elements if the operator is GtLt.</span></span><br><span class="line"><span class="string">                                  In other cases Value should contain at least one element.</span></span><br><span class="line"><span class="string"></span>                                <span class="attr">items:</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                            <span class="attr">required:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">op</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                        <span class="attr">required:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">feature</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                    <span class="attr">name:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">rule.</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                    <span class="attr">taints:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">Taints</span> <span class="string">to</span> <span class="string">create</span> <span class="string">if</span> <span class="string">the</span> <span class="string">rule</span> <span class="string">matches.</span></span><br><span class="line">                      <span class="attr">items:</span></span><br><span class="line">                        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                          The node this Taint is attached to has the &quot;effect&quot; on</span></span><br><span class="line"><span class="string">                          any pod that does not tolerate the Taint.</span></span><br><span class="line"><span class="string"></span>                        <span class="attr">properties:</span></span><br><span class="line">                          <span class="attr">effect:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              Required. The effect of the taint on pods</span></span><br><span class="line"><span class="string">                              that do not tolerate the taint.</span></span><br><span class="line"><span class="string">                              Valid effects are NoSchedule, PreferNoSchedule and NoExecute.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">key:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">Required.</span> <span class="string">The</span> <span class="string">taint</span> <span class="string">key</span> <span class="string">to</span> <span class="string">be</span> <span class="string">applied</span> <span class="string">to</span></span><br><span class="line">                              <span class="string">a</span> <span class="string">node.</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">timeAdded:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                              TimeAdded represents the time at which the taint was added.</span></span><br><span class="line"><span class="string">                              It is only written for NoExecute taints.</span></span><br><span class="line"><span class="string"></span>                            <span class="attr">format:</span> <span class="string">date-time</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">value:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">The</span> <span class="string">taint</span> <span class="string">value</span> <span class="string">corresponding</span> <span class="string">to</span> <span class="string">the</span> <span class="string">taint</span></span><br><span class="line">                              <span class="string">key.</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                        <span class="attr">required:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">effect</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">key</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                    <span class="attr">vars:</span></span><br><span class="line">                      <span class="attr">additionalProperties:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                        Vars is the variables to store if the rule matches. Variables do not</span></span><br><span class="line"><span class="string">                        directly inflict any changes in the node object. However, they can be</span></span><br><span class="line"><span class="string">                        referenced from other rules enabling more complex rule hierarchies,</span></span><br><span class="line"><span class="string">                        without exposing intermediary output values as labels.</span></span><br><span class="line"><span class="string"></span>                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">varsTemplate:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">                        VarsTemplate specifies a template to expand for dynamically generating</span></span><br><span class="line"><span class="string">                        multiple variables. Data (after template expansion) must be keys with an</span></span><br><span class="line"><span class="string">                        optional value (&lt;key&gt;[=&lt;value&gt;]) separated by newlines.</span></span><br><span class="line"><span class="string"></span>                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">required:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">name</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">            <span class="attr">required:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">rules</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">required:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">spec</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">    <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.14.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodefeatures.nfd.k8s-sigs.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">NodeFeature</span></span><br><span class="line">    <span class="attr">listKind:</span> <span class="string">NodeFeatureList</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">nodefeatures</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">nodefeature</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1alpha1</span></span><br><span class="line">    <span class="attr">schema:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">          NodeFeature resource holds the features discovered for one node in the</span></span><br><span class="line"><span class="string">          cluster.</span></span><br><span class="line"><span class="string"></span>        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">apiVersion:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              APIVersion defines the versioned schema of this representation of an object.</span></span><br><span class="line"><span class="string">              Servers should convert recognized schemas to the latest internal value, and</span></span><br><span class="line"><span class="string">              may reject unrecognized values.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">kind:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              Kind is a string value representing the REST resource this object represents.</span></span><br><span class="line"><span class="string">              Servers may infer this from the endpoint the client submits requests to.</span></span><br><span class="line"><span class="string">              Cannot be updated.</span></span><br><span class="line"><span class="string">              In CamelCase.</span></span><br><span class="line"><span class="string">              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line"><span class="string"></span>            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">NodeFeatureSpec</span> <span class="string">describes</span> <span class="string">a</span> <span class="string">NodeFeature</span> <span class="string">object.</span></span><br><span class="line">            <span class="attr">properties:</span></span><br><span class="line">              <span class="attr">features:</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">Features</span> <span class="string">is</span> <span class="string">the</span> <span class="string">full</span> <span class="string">&quot;raw&quot;</span> <span class="string">features</span> <span class="string">data</span> <span class="string">that</span> <span class="string">has</span> <span class="string">been</span></span><br><span class="line">                  <span class="string">discovered.</span></span><br><span class="line">                <span class="attr">properties:</span></span><br><span class="line">                  <span class="attr">attributes:</span></span><br><span class="line">                    <span class="attr">additionalProperties:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">AttributeFeatureSet</span> <span class="string">is</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">features</span> <span class="string">having</span></span><br><span class="line">                        <span class="string">string</span> <span class="string">value.</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">elements:</span></span><br><span class="line">                          <span class="attr">additionalProperties:</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">required:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">elements</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">description:</span> <span class="string">Attributes</span> <span class="string">contains</span> <span class="string">all</span> <span class="string">the</span> <span class="string">attribute-type</span> <span class="string">features</span></span><br><span class="line">                      <span class="string">of</span> <span class="string">the</span> <span class="string">node.</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                  <span class="attr">flags:</span></span><br><span class="line">                    <span class="attr">additionalProperties:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">FlagFeatureSet</span> <span class="string">is</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">simple</span> <span class="string">features</span> <span class="string">only</span></span><br><span class="line">                        <span class="string">containing</span> <span class="string">names</span> <span class="string">without</span> <span class="string">values.</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">elements:</span></span><br><span class="line">                          <span class="attr">additionalProperties:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">Nil</span> <span class="string">is</span> <span class="string">a</span> <span class="string">dummy</span> <span class="string">empty</span> <span class="string">struct</span> <span class="string">for</span> <span class="string">protobuf</span></span><br><span class="line">                              <span class="string">compatibility</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                      <span class="attr">required:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">elements</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">description:</span> <span class="string">Flags</span> <span class="string">contains</span> <span class="string">all</span> <span class="string">the</span> <span class="string">flag-type</span> <span class="string">features</span> <span class="string">of</span> <span class="string">the</span></span><br><span class="line">                      <span class="string">node.</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                  <span class="attr">instances:</span></span><br><span class="line">                    <span class="attr">additionalProperties:</span></span><br><span class="line">                      <span class="attr">description:</span> <span class="string">InstanceFeatureSet</span> <span class="string">is</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">features</span> <span class="string">each</span> <span class="string">of</span></span><br><span class="line">                        <span class="string">which</span> <span class="string">is</span> <span class="string">an</span> <span class="string">instance</span> <span class="string">having</span> <span class="string">multiple</span> <span class="string">attributes.</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">elements:</span></span><br><span class="line">                          <span class="attr">items:</span></span><br><span class="line">                            <span class="attr">description:</span> <span class="string">InstanceFeature</span> <span class="string">represents</span> <span class="string">one</span> <span class="string">instance</span> <span class="string">of</span></span><br><span class="line">                              <span class="string">a</span> <span class="string">complex</span> <span class="string">features,</span> <span class="string">e.g.</span> <span class="string">a</span> <span class="string">device.</span></span><br><span class="line">                            <span class="attr">properties:</span></span><br><span class="line">                              <span class="attr">attributes:</span></span><br><span class="line">                                <span class="attr">additionalProperties:</span></span><br><span class="line">                                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                            <span class="attr">required:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">attributes</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                      <span class="attr">required:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">elements</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">description:</span> <span class="string">Instances</span> <span class="string">contains</span> <span class="string">all</span> <span class="string">the</span> <span class="string">instance-type</span> <span class="string">features</span></span><br><span class="line">                      <span class="string">of</span> <span class="string">the</span> <span class="string">node.</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">labels:</span></span><br><span class="line">                <span class="attr">additionalProperties:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">Labels</span> <span class="string">is</span> <span class="string">the</span> <span class="string">set</span> <span class="string">of</span> <span class="string">node</span> <span class="string">labels</span> <span class="string">that</span> <span class="string">are</span> <span class="string">requested</span> <span class="string">to</span></span><br><span class="line">                  <span class="string">be</span> <span class="string">created.</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">required:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">spec</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">    <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">topology.node.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">noderesourcetopologies</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeaturerules</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">  <span class="attr">resourceNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd-master.nfd.kubernetes.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nfd-master.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # noPublish: false</span></span><br><span class="line"><span class="string">    # autoDefaultNs: true</span></span><br><span class="line"><span class="string">    # extraLabelNs: [&quot;added.ns.io&quot;,&quot;added.kubernets.io&quot;]</span></span><br><span class="line"><span class="string">    # denyLabelNs: [&quot;denied.ns.io&quot;,&quot;denied.kubernetes.io&quot;]</span></span><br><span class="line"><span class="string">    # resourceLabels: [&quot;vendor-1.com/feature-1&quot;,&quot;vendor-2.io/feature-2&quot;]</span></span><br><span class="line"><span class="string">    # enableTaints: false</span></span><br><span class="line"><span class="string">    # labelWhiteList: &quot;foo&quot;</span></span><br><span class="line"><span class="string">    # resyncPeriod: &quot;2h&quot;</span></span><br><span class="line"><span class="string">    # klog:</span></span><br><span class="line"><span class="string">    #    addDirHeader: false</span></span><br><span class="line"><span class="string">    #    alsologtostderr: false</span></span><br><span class="line"><span class="string">    #    logBacktraceAt:</span></span><br><span class="line"><span class="string">    #    logtostderr: true</span></span><br><span class="line"><span class="string">    #    skipHeaders: false</span></span><br><span class="line"><span class="string">    #    stderrthreshold: 2</span></span><br><span class="line"><span class="string">    #    v: 0</span></span><br><span class="line"><span class="string">    #    vmodule:</span></span><br><span class="line"><span class="string">    ##   NOTE: the following options are not dynamically run-time configurable</span></span><br><span class="line"><span class="string">    ##         and require a nfd-master restart to take effect after being changed</span></span><br><span class="line"><span class="string">    #    logDir:</span></span><br><span class="line"><span class="string">    #    logFile:</span></span><br><span class="line"><span class="string">    #    logFileMaxSize: 1800</span></span><br><span class="line"><span class="string">    #    skipLogHeaders: false</span></span><br><span class="line"><span class="string">    # leaderElection:</span></span><br><span class="line"><span class="string">    #   leaseDuration: 15s</span></span><br><span class="line"><span class="string">    #   # this value has to be lower than leaseDuration and greater than retryPeriod*1.2</span></span><br><span class="line"><span class="string">    #   renewDeadline: 10s</span></span><br><span class="line"><span class="string">    #   # this value has to be greater than 0</span></span><br><span class="line"><span class="string">    #   retryPeriod: 2s</span></span><br><span class="line"><span class="string">    # nfdApiParallelism: 10</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nfd-worker.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    #core:</span></span><br><span class="line"><span class="string">    #  labelWhiteList:</span></span><br><span class="line"><span class="string">    #  noPublish: false</span></span><br><span class="line"><span class="string">    #  sleepInterval: 60s</span></span><br><span class="line"><span class="string">    #  featureSources: [all]</span></span><br><span class="line"><span class="string">    #  labelSources: [all]</span></span><br><span class="line"><span class="string">    #  klog:</span></span><br><span class="line"><span class="string">    #    addDirHeader: false</span></span><br><span class="line"><span class="string">    #    alsologtostderr: false</span></span><br><span class="line"><span class="string">    #    logBacktraceAt:</span></span><br><span class="line"><span class="string">    #    logtostderr: true</span></span><br><span class="line"><span class="string">    #    skipHeaders: false</span></span><br><span class="line"><span class="string">    #    stderrthreshold: 2</span></span><br><span class="line"><span class="string">    #    v: 0</span></span><br><span class="line"><span class="string">    #    vmodule:</span></span><br><span class="line"><span class="string">    ##   NOTE: the following options are not dynamically run-time configurable</span></span><br><span class="line"><span class="string">    ##         and require a nfd-worker restart to take effect after being changed</span></span><br><span class="line"><span class="string">    #    logDir:</span></span><br><span class="line"><span class="string">    #    logFile:</span></span><br><span class="line"><span class="string">    #    logFileMaxSize: 1800</span></span><br><span class="line"><span class="string">    #    skipLogHeaders: false</span></span><br><span class="line"><span class="string">    #sources:</span></span><br><span class="line"><span class="string">    #  cpu:</span></span><br><span class="line"><span class="string">    #    cpuid:</span></span><br><span class="line"><span class="string">    ##     NOTE: whitelist has priority over blacklist</span></span><br><span class="line"><span class="string">    #      attributeBlacklist:</span></span><br><span class="line"><span class="string">    #        - &quot;BMI1&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;BMI2&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;CLMUL&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;CMOV&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;CX16&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;ERMS&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;F16C&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;HTT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;LZCNT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;MMX&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;MMXEXT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;NX&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;POPCNT&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;RDRAND&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;RDSEED&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;RDTSCP&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SGX&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE2&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE3&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE4&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSE42&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;SSSE3&quot;</span></span><br><span class="line"><span class="string">    #        - &quot;TDX_GUEST&quot;</span></span><br><span class="line"><span class="string">    #      attributeWhitelist:</span></span><br><span class="line"><span class="string">    #  kernel:</span></span><br><span class="line"><span class="string">    #    kconfigFile: &quot;/path/to/kconfig&quot;</span></span><br><span class="line"><span class="string">    #    configOpts:</span></span><br><span class="line"><span class="string">    #      - &quot;NO_HZ&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;X86&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;DMI&quot;</span></span><br><span class="line"><span class="string">    #  pci:</span></span><br><span class="line"><span class="string">    #    deviceClassWhitelist:</span></span><br><span class="line"><span class="string">    #      - &quot;0200&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;03&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;12&quot;</span></span><br><span class="line"><span class="string">    #    deviceLabelFields:</span></span><br><span class="line"><span class="string">    #      - &quot;class&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;vendor&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;device&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;subsystem_vendor&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;subsystem_device&quot;</span></span><br><span class="line"><span class="string">    #  usb:</span></span><br><span class="line"><span class="string">    #    deviceClassWhitelist:</span></span><br><span class="line"><span class="string">    #      - &quot;0e&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;ef&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;fe&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;ff&quot;</span></span><br><span class="line"><span class="string">    #    deviceLabelFields:</span></span><br><span class="line"><span class="string">    #      - &quot;class&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;vendor&quot;</span></span><br><span class="line"><span class="string">    #      - &quot;device&quot;</span></span><br><span class="line"><span class="string">    #  local:</span></span><br><span class="line"><span class="string">    #    hooksEnabled: false</span></span><br><span class="line"><span class="string">    #  custom:</span></span><br><span class="line"><span class="string">    #    # The following feature demonstrates the capabilities of the matchFeatures</span></span><br><span class="line"><span class="string">    #    - name: &quot;my custom rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my-ng-feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      # matchFeatures implements a logical AND over all matcher terms in the</span></span><br><span class="line"><span class="string">    #      # list (i.e. all of the terms, or per-feature matchers, must match)</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            AVX512F: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cstate</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            enabled: &#123;op: IsTrue&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.pstate</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            no_turbo: &#123;op: IsFalse&#125;</span></span><br><span class="line"><span class="string">    #            scaling_governor: &#123;op: In, value: [&quot;performance&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.rdt</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            RDTL3CA: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.sst</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            bf.enabled: &#123;op: IsTrue&#125;</span></span><br><span class="line"><span class="string">    #        - feature: cpu.topology</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            hardware_multithreading: &#123;op: IsFalse&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: kernel.config</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            X86: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #            LSM: &#123;op: InRegexp, value: [&quot;apparmor&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: kernel.loadedmodule</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            e1000e: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #        - feature: kernel.selinux</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            enabled: &#123;op: IsFalse&#125;</span></span><br><span class="line"><span class="string">    #        - feature: kernel.version</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            major: &#123;op: In, value: [&quot;5&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            minor: &#123;op: Gt, value: [&quot;10&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: storage.block</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            rotational: &#123;op: In, value: [&quot;0&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            dax: &#123;op: In, value: [&quot;0&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: network.device</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            operstate: &#123;op: In, value: [&quot;up&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            speed: &#123;op: Gt, value: [&quot;100&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: memory.numa</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            node_count: &#123;op: Gt, value: [&quot;2&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: memory.nv</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            devtype: &#123;op: In, value: [&quot;nd_dax&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            mode: &#123;op: In, value: [&quot;memory&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: system.osrelease</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            ID: &#123;op: In, value: [&quot;fedora&quot;, &quot;centos&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - feature: system.name</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            nodename: &#123;op: InRegexp, value: [&quot;^worker-X&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #        - feature: local.label</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            custom-feature-knob: &#123;op: Gt, value: [&quot;100&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    # The following feature demonstrates the capabilities of the matchAny</span></span><br><span class="line"><span class="string">    #    - name: &quot;my matchAny rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my-ng-feature-2&quot;: &quot;my-value&quot;</span></span><br><span class="line"><span class="string">    #      # matchAny implements a logical IF over all elements (sub-matchers) in</span></span><br><span class="line"><span class="string">    #      # the list (i.e. at least one feature matcher must match)</span></span><br><span class="line"><span class="string">    #      matchAny:</span></span><br><span class="line"><span class="string">    #        - matchFeatures:</span></span><br><span class="line"><span class="string">    #            - feature: kernel.loadedmodule</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                driver-module-X: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #            - feature: pci.device</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                vendor: &#123;op: In, value: [&quot;8086&quot;]&#125;</span></span><br><span class="line"><span class="string">    #                class: &#123;op: In, value: [&quot;0200&quot;]&#125;</span></span><br><span class="line"><span class="string">    #        - matchFeatures:</span></span><br><span class="line"><span class="string">    #            - feature: kernel.loadedmodule</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                driver-module-Y: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #            - feature: usb.device</span></span><br><span class="line"><span class="string">    #              matchExpressions:</span></span><br><span class="line"><span class="string">    #                vendor: &#123;op: In, value: [&quot;8086&quot;]&#125;</span></span><br><span class="line"><span class="string">    #                class: &#123;op: In, value: [&quot;02&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;avx wildcard rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;my-avx-feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchName: &#123;op: InRegexp, value: [&quot;^AVX512&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    # The following features demonstreate label templating capabilities</span></span><br><span class="line"><span class="string">    #    - name: &quot;my template rule&quot;</span></span><br><span class="line"><span class="string">    #      labelsTemplate: |</span></span><br><span class="line"><span class="string">    #        &#123;&#123; range .system.osrelease &#125;&#125;vendor.io/my-system-feature.&#123;&#123; .Name &#125;&#125;=&#123;&#123; .Value &#125;&#125;</span></span><br><span class="line"><span class="string">    #        &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: system.osrelease</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            ID: &#123;op: InRegexp, value: [&quot;^open.*&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            VERSION_ID.major: &#123;op: In, value: [&quot;13&quot;, &quot;15&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;my template rule 2&quot;</span></span><br><span class="line"><span class="string">    #      labelsTemplate: |</span></span><br><span class="line"><span class="string">    #        &#123;&#123; range .pci.device &#125;&#125;vendor.io/my-pci-device.&#123;&#123; .class &#125;&#125;-&#123;&#123; .device &#125;&#125;=with-cpuid</span></span><br><span class="line"><span class="string">    #        &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: pci.device</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            class: &#123;op: InRegexp, value: [&quot;^06&quot;]&#125;</span></span><br><span class="line"><span class="string">    #            vendor: [&quot;8086&quot;]</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            AVX: &#123;op: Exists&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    # The following examples demonstrate vars field and back-referencing</span></span><br><span class="line"><span class="string">    #    # previous labels and vars</span></span><br><span class="line"><span class="string">    #    - name: &quot;my dummy kernel rule&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my.kernel.feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: kernel.version</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            major: &#123;op: Gt, value: [&quot;2&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;my dummy rule with no labels&quot;</span></span><br><span class="line"><span class="string">    #      vars:</span></span><br><span class="line"><span class="string">    #        &quot;my.dummy.var&quot;: &quot;1&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: cpu.cpuid</span></span><br><span class="line"><span class="string">    #          matchExpressions: &#123;&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;my rule using backrefs&quot;</span></span><br><span class="line"><span class="string">    #      labels:</span></span><br><span class="line"><span class="string">    #        &quot;vendor.io/my.backref.feature&quot;: &quot;true&quot;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: rule.matched</span></span><br><span class="line"><span class="string">    #          matchExpressions:</span></span><br><span class="line"><span class="string">    #            vendor.io/my.kernel.feature: &#123;op: IsTrue&#125;</span></span><br><span class="line"><span class="string">    #            my.dummy.var: &#123;op: Gt, value: [&quot;0&quot;]&#125;</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    - name: &quot;kconfig template rule&quot;</span></span><br><span class="line"><span class="string">    #      labelsTemplate: |</span></span><br><span class="line"><span class="string">    #        &#123;&#123; range .kernel.config &#125;&#125;kconfig-&#123;&#123; .Name &#125;&#125;=&#123;&#123; .Value &#125;&#125;</span></span><br><span class="line"><span class="string">    #        &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string">    #      matchFeatures:</span></span><br><span class="line"><span class="string">    #        - feature: kernel.config</span></span><br><span class="line"><span class="string">    #          matchName: &#123;op: In, value: [&quot;SWAP&quot;, &quot;X86&quot;, &quot;ARM&quot;]&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfd-gc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfd-gc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nfd-gc</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_UID</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.uid</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/node-feature-discovery:v0.16.0-devel-179-gcc9cb875</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-gc</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">20m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfd-gc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfd-master</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/control-plane</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nfd-master</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_UID</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.uid</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/node-feature-discovery:v0.16.0-devel-179-gcc9cb875</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enableServiceLinks:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfd-master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/control-plane</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-master-conf</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfd-worker</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfd-worker</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-server=nfd-master:8080</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nfd-worker</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_UID</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.uid</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/node-feature-discovery:v0.16.0-devel-179-gcc9cb875</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">5m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">64Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-boot</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-boot</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-etc/os-release</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-os-release</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-sys</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-proc/swaps</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-proc-swaps</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-usr/lib</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-usr-lib</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host-lib</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-lib</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery/source.d/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">source-d</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">features-d</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfd-worker</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/boot</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-boot</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/proc/swaps</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-proc-swaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/os-release</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-os-release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/usr/lib</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-usr-lib</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/lib</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-lib</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/kubernetes/node-feature-discovery/source.d/</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">source-d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d/</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">features-d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfd-worker-conf</span></span><br></pre></td></tr></table></figure><h4 id="gpu-feature-discovery部署"><a href="#gpu-feature-discovery部署" class="headerlink" title="gpu-feature-discovery部署"></a>gpu-feature-discovery部署</h4><p>Kubernetes device-pluging提供了许多可配置项，这些配置项可以设置为命令行选项或者环境变量，例如设置MIG策略，设备枚举等等，使用gpu-feature-discovery可以使用以label的形式来附加在Kubernetes的node资源对象上，随着配置的复杂，也可以抽象配置为configmap便于管理，部署gpu-feature前需要部署nfd（node-feature-discovery）,以下为配置相关的主要参数</p><p><code>migStrategy</code> : 是否开启mig策略（A100及以后版本的GPU支持），支持的参数为<code>none</code>,<code>single</code>,<code>mixed</code></p><p><code>sharing</code>:是否开启GPU共享，其中包含了两个参数<code>timeSlicing</code>和<code>mps</code>（都可以设置为空）</p><p><code>timeSlicing</code>: 开启共享模式的时间切片模式，配置对应的gpu资源的字段包含以下资源</p><ul><li><code>renameByDefault</code>: 是否默认重命名共享的GPU资源，设置为true后，kubelet上报的资源会变成<code>nvidia.com/gpu.shared</code>,当前测试v0.15.0版本默认禁用了重命名</li><li><code>failRequestsGreaterThanOne</code>:该字段的目的申请多个GPU副本并不会获取更多比例的GPU访问权，当设置为true时，对于超过一个GPU的资源请求会导致UnexpectedAdmissionError（建议默认设置为false）</li><li><code>resourcess</code>：该字段包含了以下四个字段<code>name</code>, 代表对应的GPU资源名，默认为<code>nvidia.com/gpu</code>，<code>reanme</code>字段表示要讲资源重命名为一个名称，当前测试v0.15.0版本默认禁用了重命名，<code>replicas</code>字段表示要将gpu共享的份数，当配置了比如说10时，可用的GPU资源会变成实际*Replicas，<code>device</code>表示需要配置的GPU，当前测试v0.15.0版本默认禁用了自定义设备</li></ul><p><img src="/image/GPUShare/label.png" alt="header"></p><p>nvidia-plugin-configs可以配置多个配置，根据节点来区分不同配置，以下dp-example-config0.yaml，dp-example-config1.yaml两个配置，分别是开启mig和不开启mig的配置，命名为T4-config和A800-conifg,可以创建多个节点的配置，然后根据label由nvidia-gpu-operator去下发不同节点的配置,例如以下命令和配置，并且可以通过node的label去选择该节点使用哪个device-plugin配置，具体的label是<strong>nvidia.com&#x2F;device-plugin.config <strong>，比如说在T4节点不能使用mig的情况下，就应该是</strong>nvidia.com&#x2F;device-plugin.config&#x3D;T4-config</strong>，然后gpu-feature-discovery就会读取T4-conifg的配置，将对应标签配置比如说<strong>nvidia.com&#x2F;mig.strategy&#x3D;none</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">kubectl create cm -n nvidia-device-plugin nvidia-plugin-configs \</span><br><span class="line">    --from-file=T4-config=/tmp/dp-example-config0.yaml \</span><br><span class="line">    --from-file=A800-config=/tmp/dp-example-config1.yaml</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; dp-example-config0.yaml</span></span><br><span class="line"><span class="string">version: v1</span></span><br><span class="line"><span class="string">flags:</span></span><br><span class="line"><span class="string">  migStrategy: &quot;none&quot; </span></span><br><span class="line"><span class="string">  failOnInitError: true</span></span><br><span class="line"><span class="string">  nvidiaDriverRoot: &quot;/&quot;</span></span><br><span class="line"><span class="string">  plugin:</span></span><br><span class="line"><span class="string">    passDeviceSpecs: false</span></span><br><span class="line"><span class="string">    deviceListStrategy: envvar</span></span><br><span class="line"><span class="string">    deviceIDStrategy: uuid</span></span><br><span class="line"><span class="string">sharing: #timeSlicing和MPS不能同时开启</span></span><br><span class="line"><span class="string">  timeSlicing:</span></span><br><span class="line"><span class="string">    renameByDefault: true</span></span><br><span class="line"><span class="string">    failRequestsGreaterThanOne: true</span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">    - name: nvidia.com/gpu</span></span><br><span class="line"><span class="string">      replicas: 10</span></span><br><span class="line"><span class="string">  mps:   </span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">        name: nvidia.com/gpu</span></span><br><span class="line"><span class="string">        rename: nvidia.com/gpu-1gb</span></span><br><span class="line"><span class="string">        replicas: 16</span></span><br><span class="line"><span class="string">        devices: [&quot;0&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; dp-example-config1.yaml</span></span><br><span class="line"><span class="string"> version: v1</span></span><br><span class="line"><span class="string">    flags:</span></span><br><span class="line"><span class="string">      migStrategy: &quot;mixed&quot; # Only change from config1.yaml</span></span><br><span class="line"><span class="string">      failOnInitError: true</span></span><br><span class="line"><span class="string">      nvidiaDriverRoot: &quot;/&quot;</span></span><br><span class="line"><span class="string">      plugin:</span></span><br><span class="line"><span class="string">        passDeviceSpecs: false</span></span><br><span class="line"><span class="string">        deviceListStrategy: envvar</span></span><br><span class="line"><span class="string">        deviceIDStrategy: uuid</span></span><br><span class="line"><span class="string">EOF</span>        </span><br></pre></td></tr></table></figure><p>部署yaml文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfd.k8s-sigs.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodefeatures</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-gpu-feature-discovery</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/pci-0302_10de.present</span> <span class="comment">#根据node-feature-discovery修改pci对应标签</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/cpu-model.vendor_id</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NVIDIA</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-feature-discovery-sidecar</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GFD_USE_NODE_FEATURE_API</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_MIG_MONITOR_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-feature-discovery-ctr</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">output-dir</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-feature-discovery-init</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/kubernetes/node-feature-discovery/features.d</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">output-dir</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nvidia-plugin-configs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure><h4 id="nvidia-device-pluging部署"><a href="#nvidia-device-pluging部署" class="headerlink" title="nvidia-device-pluging部署"></a>nvidia-device-pluging部署</h4><p>部署yaml文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-role-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;nfd.k8s-sigs.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodefeatures&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/pci-0302_10de.present</span> <span class="comment">#根据node-feature-discovery修改pci对应标签</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/cpu-model.vendor_id</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NVIDIA</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-sidecar</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_MIG_MONITOR_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_VISIBLE_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_DRIVER_CAPABILITIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">compute,utility</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-ctr</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">SYS_ADMIN</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/kubelet/device-plugins</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/cdi</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cdi-root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-init</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/kubelet/device-plugins</span> <span class="comment">#注意宿主机的kubelet目录是否修改过</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/run/cdi</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cdi-root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nvidia-plugin-configs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure><p> 部署MPS相关组件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvdp-nvidia-device-plugin-mps-control-daemon</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">nvdp</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/pci-0302_10de.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">feature.node.kubernetes.io/cpu-model.vendor_id</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NVIDIA</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu.present</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/usr/bin/mps-control-daemon</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-sidecar</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mps-control-daemon</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_MIG_MONITOR_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_VISIBLE_DEVICES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_DRIVER_CAPABILITIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">compute,utility</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-ctr</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/dev/shm</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mps-shm</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mps</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mps-root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mps-control-daemon</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mount-shm</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-mounts</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mps</span></span><br><span class="line">          <span class="attr">mountPropagation:</span> <span class="string">Bidirectional</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mps-root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">config-manager</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ONESHOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBECONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_LABEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nvidia.com/device-plugin.config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_SRCDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE_DST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/config/config.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_CONFIG</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FALLBACK_STRATEGIES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">named,single</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEND_SIGNAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIGNAL</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROCESS_TO_SIGNAL</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cis-hub-huabei-3.cmecloud.cn/ecloud/k8s-device-plugin:v0.15.0-rc.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-control-daemon-init</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/available-configs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">nvidia.com/mps.capable:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvdp-nvidia-device-plugin-service-account</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/nvidia/mps</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/nvidia/mps/shm</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mps-shm</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nvidia-plugin-configs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">available-configs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure><p>部署MGI管理组件：</p><p>mig配置一般来说需要手动配置，以下该组件可以根据node-label自动切分进行mig配置，其中mig-parted-config的配置，需要你对不同的型号进行不同的配置，标准对应了<strong>A100-40G</strong>,<strong>A800-40G</strong>,<strong>A100-80G</strong>,<strong>A800-80G</strong>,<strong>A30-24GB</strong>,<strong>PG506-96GB</strong> 等多种规格的GPU显卡服务器，同时你也可以自定义你的分配方式，其中<code>devices</code>字段对应服务器中显卡的index，<code>devicesfilter</code>对应需要过滤的的型号。mig服务在enable分配时，需要关闭所有连接该节点GPU的服务（其中包含gpu-clients配置的服务，但是这仅仅会关闭systemd起的服务，容器起的服务需要手动关闭，比如说dcgm-exporter等），然后可以使用label来控制具体的label是<strong>nvidia.com&#x2F;mig.config</strong>，你可以选择的配置就是mig-parted-config中的配置，比如说<strong>all-1g.10gb</strong>，mig-manager就会把所有gpu切分为7个<strong>1g.10gb</strong>规格</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">nvidia.com/gpu.deploy.mig-manager:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nvidia-mig-manager</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">testdf2-6fabd46f.ecis.huhehaote-1.cmecloud.cn/test/k8s-mig-manager:v0.7.0-ubi8</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/mig-parted-config/config.yaml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GPU_CLIENTS_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/gpu-clients/clients.yaml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_ROOT_MOUNT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/host&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_NVIDIA_DIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/usr/local/nvidia&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_KUBELET_SYSTEMD_SERVICE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubelet.service&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_MIG_MANAGER_STATE_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/etc/systemd/system/nvidia-mig-manager.service.d/override.conf&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_GPU_CLIENTS_NAMESPACE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;default&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WITH_SHUTDOWN_HOST_GPU_CLIENTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WITH_REBOOT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/gpu-clients</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mig-parted-config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-root</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-role-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nvidia-mig-manager-service-account</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-mig-manager-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-clients</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">clients.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    version: v1</span></span><br><span class="line"><span class="string">    systemd-services:</span></span><br><span class="line"><span class="string">      - nvsm.service</span></span><br><span class="line"><span class="string">      - nvsm-mqtt.service</span></span><br><span class="line"><span class="string">      - nvsm-core.service</span></span><br><span class="line"><span class="string">      - nvsm-api-gateway.service</span></span><br><span class="line"><span class="string">      - nvsm-notifier.service</span></span><br><span class="line"><span class="string">      - nv_peer_mem.service</span></span><br><span class="line"><span class="string">      - nvidia-dcgm.service</span></span><br><span class="line"><span class="string">      - dcgm.service</span></span><br><span class="line"><span class="string">      - dcgm-exporter.service</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mig-parted-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nvidia-device-plugin</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    version: v1</span></span><br><span class="line"><span class="string">    mig-configs:</span></span><br><span class="line"><span class="string">      all-disabled:</span></span><br><span class="line"><span class="string">        - devices: all</span></span><br><span class="line"><span class="string">          mig-enabled: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">      <span class="attr">all-1g.5gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.5gb&quot;:</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">      <span class="attr">all-1g.5gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;1g.5gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.10gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.10gb&quot;:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-3g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;3g.20gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-4g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;4g.20gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-7g.40gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;7g.40gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-80GB, A800-80GB, A100-40GB, A800-40GB</span></span><br><span class="line">      <span class="attr">all-1g.10gb:</span></span><br><span class="line">        <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B210DE&quot;</span>, <span class="string">&quot;0x20B510DE&quot;</span>, <span class="string">&quot;0x20F310DE&quot;</span>, <span class="string">&quot;0x20F510DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.10gb&quot;:</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B010DE&quot;</span>, <span class="string">&quot;0x20B110DE&quot;</span>, <span class="string">&quot;0x20F110DE&quot;</span>, <span class="string">&quot;0x20F610DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.10gb&quot;:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">      <span class="attr">all-1g.10gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;1g.10gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">      <span class="attr">all-1g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.20gb&quot;:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.20gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.20gb&quot;:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-3g.40gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;3g.40gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-4g.40gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;4g.40gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-7g.80gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;7g.80gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A30-24GB</span></span><br><span class="line">      <span class="attr">all-1g.6gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.6gb&quot;:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-1g.6gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;1g.6gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.12gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.12gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.12gb.me:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="string">&quot;2g.12gb+me&quot;</span><span class="string">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-4g.24gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;4g.24gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># PG506-96GB</span></span><br><span class="line">      <span class="attr">all-1g.12gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.12gb&quot;:</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-2g.24gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;2g.24gb&quot;:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-3g.48gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;3g.48gb&quot;:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">all-7g.96gb:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;7g.96gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># A100-40GB, A100-80GB, A800-40GB, A800-80GB, A30-24GB, PG506-96GB</span></span><br><span class="line">      <span class="attr">all-balanced:</span></span><br><span class="line">        <span class="comment"># A100-40GB, A800-40GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B010DE&quot;</span>, <span class="string">&quot;0x20B110DE&quot;</span>, <span class="string">&quot;0x20F110DE&quot;</span>, <span class="string">&quot;0x20F610DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.5gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.10gb&quot;:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">&quot;3g.20gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># A100-80GB, A800-80GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> [<span class="string">&quot;0x20B210DE&quot;</span>, <span class="string">&quot;0x20B510DE&quot;</span>, <span class="string">&quot;0x20F310DE&quot;</span>, <span class="string">&quot;0x20F510DE&quot;</span>]</span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.10gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.20gb&quot;:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">&quot;3g.40gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># A30-24GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> <span class="string">&quot;0x20B710DE&quot;</span></span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.6gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.12gb&quot;:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># PG506-96GB</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">device-filter:</span> <span class="string">&quot;0x20B610DE&quot;</span></span><br><span class="line">          <span class="attr">devices:</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">mig-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">mig-devices:</span></span><br><span class="line">            <span class="attr">&quot;1g.12gb&quot;:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">&quot;2g.24gb&quot;:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">&quot;3g.48gb&quot;:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="对比结论"><a href="#对比结论" class="headerlink" title="对比结论"></a>对比结论</h3><h4 id="多种并发机制对比"><a href="#多种并发机制对比" class="headerlink" title="多种并发机制对比"></a>多种并发机制对比</h4><table><thead><tr><th align="center"></th><th>Streams</th><th>MPS</th><th>Time-Slicing</th><th>MIG</th><th>VGPU</th></tr></thead><tbody><tr><td align="center">分区方式(Partition Types)</td><td>单进程（Single Process）</td><td>逻辑分割(Logical)</td><td>临时（单进程）(Temporal (Single process))</td><td>物理分割（Physical）</td><td>临时+物理VMS虚拟化（Temporal &amp; Physical – VMs）</td></tr><tr><td align="center">最大分割数（Max Partitions）</td><td>无限制</td><td>48</td><td>无限制</td><td>7</td><td>变量可配置</td></tr><tr><td align="center">SM隔离 (SM Performance Isolation)</td><td>不支持</td><td>支持（但是仅支持百分比，不支持分区）</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">内存保护（Memory Protection）</td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">内存带宽Qos（Memory Bandwidth QoS）</td><td>不支持</td><td>不支持</td><td>不支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">故障隔离（Error Isolation）</td><td>不支持</td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td align="center">跨分区互操作性（Cross-Partition Interop</td><td>永远</td><td>进程间通信（IPC）</td><td>有限的进程间通信（Limited IPC）</td><td>有限的进程间通信（Limited IPC）</td><td>不支持</td></tr><tr><td align="center">重新配置（Reconfigure）</td><td>动态</td><td>进程启动时</td><td>N&#x2F;A</td><td>空闲时（When idle）</td><td>N&#x2F;A</td></tr><tr><td align="center">GPU监控(GPU Management (telemetry))</td><td>N&#x2F;A</td><td>有限的GPU metrics(Limited GPU metrics)</td><td>N&#x2F;A</td><td>支持（适用GPU metrics，支持容器化）</td><td>支持（适配上层虚拟化工具相关监控）</td></tr><tr><td align="center">用例和使用场景</td><td>优化单个应用程序的并发性</td><td>在并行运行多个应用程序但可以处理优先恢复性处理</td><td>多应用程序同时运行并且对延迟不敏感或能够容忍抖动</td><td>并行运行多个应用程序但需要恢复性处理和QoS</td><td>通过虚拟化支持 GPU 上的多租户</td></tr></tbody></table><p>以下是Volta-MPS和Pre-Volta MPS的对比</p><ol><li><strong>资源管理方式：</strong><ul><li><strong>Pre-Volta MPS：</strong> 在 Pre-Volta MPS 中，服务器管理与单个 CUDA 上下文相关的硬件资源。MPS 客户端的 CUDA 上下文通过 MPS 服务器进行工作处理，使客户端 CUDA 上下文能够绕过与时间片调度相关的硬件限制，允许其 CUDA 内核同时执行。</li><li><strong>Volta MPS：</strong> 在 Volta MPS 中，Volta 提供了新的硬件功能，减少了 MPS 服务器必须管理的硬件资源类型。在 Volta 中，客户端 CUDA 上下文管理大部分硬件资源，并直接向硬件提交工作。Volta MPS 服务器调节剩余的共享资源，以确保通过单个客户端提交的工作可以同时调度，且不涉及关键执行路径。</li></ul></li><li><strong>通信方式：</strong><ul><li><strong>Pre-Volta MPS：</strong> MPS 客户端与 MPS 服务器之间的通信完全封装在 CUDA 驱动程序的 CUDA API 后面。因此，对于 MPI 程序而言，MPS 是透明的。</li><li><strong>Volta MPS：</strong> 通信方式与 Pre-Volta MPS 类似，但是 Volta MPS 允许客户端 CUDA 上下文保留其上行调用处理线程和任何异步执行器线程。MPS 服务器为每个客户端创建一个额外的上行调用处理线程，并为每个客户端创建一个工作线程。</li></ul></li><li><strong>硬件资源分配：</strong><ul><li><strong>Pre-Volta MPS：</strong> 在 Pre-Volta MPS 中，硬件资源的分配由 MPS 服务器管理，客户端通过服务器获取资源。</li><li><strong>Volta MPS：</strong> 在 Volta MPS 中，客户端直接管理大部分硬件资源，而 MPS 服务器调节共享资源，以确保同时调度来自各个客户端的工作。</li></ul></li></ol><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>- [1] <a href="https://developer.nvidia.com/zh-cn/blog/improving-gpu-utilization-in-kubernetes/">Nvidia</a><br>- [2] <a href="https://docs.nvidia.com/datacenter/tesla/mig-user-guide/">Nvidia MIG</a><br>- [3] <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-sharing.html">Nvidia time-slice</a><br>- [4] <a href="https://docs.nvidia.com/deploy/mps/index.html#topic_5_1_1">Nvidia MPS</a></p>]]></content>
      
      
      <categories>
          
          <category> GPU </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GPU </tag>
            
            <tag> Kubernetes </tag>
            
            <tag> NVIDIA </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
