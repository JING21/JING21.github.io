<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kubelet CPU管理 | Jing's Blog</title><meta name="author" content="Jing"><meta name="copyright" content="Jing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kubelet cpu绑核功能背景openstack容器化组件容器化过程中，需要在部署组件的节点预留cpu给系统组件使用，保证容器不使用预留cpu。相关场景的问题是：reserved-cpu保留后，仅对Guaranteed类型的pod有效，同时cpu相关qos必须为整型参数。 具体的需求如下：  所有服务 yaml 文件无需修改（既不需要增加 resources：limits(memory+cpu">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubelet CPU管理">
<meta property="og:url" content="https://jing21.github.io/posts/2592.html">
<meta property="og:site_name" content="Jing's Blog">
<meta property="og:description" content="Kubelet cpu绑核功能背景openstack容器化组件容器化过程中，需要在部署组件的节点预留cpu给系统组件使用，保证容器不使用预留cpu。相关场景的问题是：reserved-cpu保留后，仅对Guaranteed类型的pod有效，同时cpu相关qos必须为整型参数。 具体的需求如下：  所有服务 yaml 文件无需修改（既不需要增加 resources：limits(memory+cpu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jing21.github.io/image/volcano%20park.JPG">
<meta property="article:published_time" content="2024-06-14T02:32:09.000Z">
<meta property="article:modified_time" content="2024-06-14T02:45:34.769Z">
<meta property="article:author" content="Jing">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jing21.github.io/image/volcano%20park.JPG"><link rel="shortcut icon" href="/image/images.png"><link rel="canonical" href="https://jing21.github.io/posts/2592.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubelet CPU管理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-14 10:45:34'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/image/volcano%20park.JPG" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="Jing's Blog"><span class="site-name">Jing's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubelet CPU管理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-06-14T02:32:09.000Z" title="Created 2024-06-14 10:32:09">2024-06-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-06-14T02:45:34.769Z" title="Updated 2024-06-14 10:45:34">2024-06-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Kubelet CPU管理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Kubelet-cpu绑核功能"><a href="#Kubelet-cpu绑核功能" class="headerlink" title="Kubelet cpu绑核功能"></a>Kubelet cpu绑核功能</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>openstack容器化组件容器化过程中，需要在部署组件的节点预留cpu给系统组件使用，保证容器不使用预留cpu。相关场景的问题是：reserved-cpu保留后，仅对Guaranteed类型的pod有效，同时cpu相关qos必须为整型参数。</p>
<p>具体的需求如下：</p>
<ol>
<li>所有服务 yaml 文件无需修改（既不需要增加 resources：limits(memory+cpu) + requests(memory+cpu) 配置）</li>
<li>同节点上所有 Pod 共用配置的 reserved-cpus 之外的核池。</li>
</ol>
<h2 id="Kubernetes相关参数功能"><a href="#Kubernetes相关参数功能" class="headerlink" title="Kubernetes相关参数功能"></a>Kubernetes相关参数功能</h2><h3 id="pod类型"><a href="#pod类型" class="headerlink" title="pod类型"></a>pod类型</h3><p>Kubernetes中的pod拥有三种QoS类型，分别是：Guaranteed，Burstable，BestEffort</p>
<ul>
<li>Guaranteed类型：</li>
</ul>
<p>​	要求pod中声明了Resources的limit和requests类型，同时还要求两者的值必须相等</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"3600"</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"3"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"3"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">"500Mi"</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Burstable类型：</li>
</ul>
<p>​	要求pod中声明了Resources的limit和requests类型，但是request可以小于limit，或者cpu和内存资源仅声明其中之一，就会是   	Burstable类型的Qos</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"3600"</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"3"</span>    </span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"2"</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>BestEffort类型</li>
</ul>
<p>​	 pod的声明中未申请Resources对应的具体的limit和requests类型，就会定义Qos类型为BestEffort</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"3600"</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>Best-Effort 类型的pods：系统用完了全部内存时，该类型pods会最先被kill掉。</p>
</li>
<li><p>Burstable类型pods：系统用完了全部内存，且没有Best-Effort container可以被kill时，该类型pods会被kill掉。</p>
</li>
<li><p>Guaranteed pods：系统用完了全部内存、且没有Burstable与Best-Effort container可以被kill，该类型的pods会被kill掉。</p>
<p>如果pod进程因使用超过预先设定的<em>limites</em>而非Node资源紧张情况，系统倾向于在其原所在的机器上重启该container或本机或其他重新创建一个pod。</p>
</li>
</ul>
<h3 id="kubelet相关参数"><a href="#kubelet相关参数" class="headerlink" title="kubelet相关参数"></a>kubelet相关参数</h3><p>Kubernetes中kubelet负责容器的生命周期管理。同时提供了具体参数，–reserved-cpus，–system-reserved，–kube-reserved,(其中reserved-cpus优先级高于system-reserved和kube-reserved，会进行覆盖)对节点资源进行预留。</p>
<p>cpu-manager作为kubelet的containerManager的一种，负责容器的cpu资源的管理，其中kubelet可以指定参数–cpuManagerPolicy,当前支持2种cpu策略。分别是1.none和2.static</p>
<ul>
<li>none类型</li>
</ul>
<p>​	Kubernetes使用默认的cpu亲和性方案，通过Linux的CFS调度器来管理Guaranteed pods的 CPU 使用以及限制。所谓的CFS（Completely Fair Scheduler），就如字面意思所述，完全公平调度。实际意义即为在一个特定的调度周期内，保证所有的调度的进程都可以被执行，每个进程的vruntime（并不是进程的实际占用cpu时间，是剔除了权重影响的cpu使用时间，而实际的cpu使用时间是会根据进程的优先级权重进行扩缩的）的计算公式如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进程运行时间 = 调度周期 * 进程权重 / 所有进程权重之和</span><br><span class="line"></span><br><span class="line">vruntime = 进程运行时间 * NICE_0_LOAD / 进程权重 = (调度周期 * 进程权重 / 所有进程总权重) * NICE_0_LOAD / 进程权重 = 调度周期 * NICE_0_LOAD / 所有进程总权重 </span><br></pre></td></tr></tbody></table></figure>

<p>其中以下的内核参数是CFS调度有关的</p>
<ul>
<li>/proc/sys/kernel/sched_min_granularity_ns，表示进程最少运行时间，防止进程随意的切换</li>
<li>/proc/sys/kernel/sched_nr_migrate，表示多CPU情况下进行负载均衡时，一次最多移动多少个进程到另一个CPU上</li>
<li>/proc/sys/kernel/sched_wakeup_granularity_ns，表示进程被唤醒后至少应该运行的时间，这个数值越小，那么发生抢占的概率也就越高</li>
<li>/proc/sys/kernel/sched_latency_ns，表示一个运行队列所有进程运行一次的时间长度(正常情况下的队列调度周期，P)</li>
<li>sched_nr_latency，这个参数是内核内部参数，无法直接设置，是通过sched_latency_ns/sched_min_granularity_ns这个公式计算出来的；在实际运行中，如果队列排队进程数 nr_running &gt; sched_nr_latency，则调度周期就不是sched_latency_ns，而是P = sched_min_granularity_ns * nr_running，如果 nr_running &lt;= sched_nr_latency，则 P = sched_latency_ns</li>
</ul>
<p>目前环境的参数如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_min_granularity_ns</span></span><br><span class="line">10000000</span><br><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_nr_migrate</span></span><br><span class="line">32</span><br><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_wakeup_granularity_ns</span></span><br><span class="line">15000000</span><br><span class="line">[root@node2 kernel]<span class="comment"># cat /proc/sys/kernel/sched_latency_ns</span></span><br><span class="line">24000000</span><br></pre></td></tr></tbody></table></figure>

<p>其中可以算出sched_nr_latency = sched_latency_ns/sched_min_granularity_ns = 24000000/10000000 = 2.4，表示当进程队列中有2.4个在等待时，开始保证每个进程至少运行10000000ns（即10ms）</p>
<p>观察对应的进程cpu使用情况，其中se.sum_exec_runtime是实际占用cpu的时间:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /proc/6/sched</span></span><br><span class="line">sh (6, <span class="comment">#threads: 1)</span></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">se.exec_start                                :     257239294.640742</span><br><span class="line">se.vruntime                                  :            17.932870</span><br><span class="line">se.sum_exec_runtime                          :            25.294106</span><br><span class="line">se.nr_migrations                             :                   16</span><br><span class="line">nr_switches                                  :                  107</span><br><span class="line">nr_voluntary_switches                        :                  107</span><br><span class="line">nr_involuntary_switches                      :                    0</span><br><span class="line">se.load.weight                               :              1048576</span><br><span class="line">se.runnable_weight                           :              1048576</span><br><span class="line">se.avg.load_sum                              :                  214</span><br><span class="line">se.avg.runnable_load_sum                     :                  214</span><br><span class="line">se.avg.util_sum                              :               219136</span><br><span class="line">se.avg.load_avg                              :                    0</span><br><span class="line">se.avg.runnable_load_avg                     :                    0</span><br><span class="line">se.avg.util_avg                              :                    0</span><br><span class="line">se.avg.last_update_time                      :      257239294640128</span><br><span class="line">se.avg.util_est.ewma                         :                    8</span><br><span class="line">se.avg.util_est.enqueued                     :                    0</span><br><span class="line">policy                                       :                    0</span><br><span class="line">prio                                         :                  120</span><br><span class="line">clock-delta                                  :                   47</span><br><span class="line">mm-&gt;numa_scan_seq                            :                    0</span><br><span class="line">numa_pages_migrated                          :                    0</span><br><span class="line">numa_preferred_nid                           :                   -1</span><br><span class="line">total_numa_faults                            :                    0</span><br><span class="line">current_node=0, numa_group_id=0</span><br><span class="line">numa_faults node=0 task_private=0 task_shared=0 group_private=0 group_shared=0</span><br><span class="line">/ <span class="comment"># cat /proc/6/sched</span></span><br><span class="line">sh (6, <span class="comment">#threads: 1)</span></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">se.exec_start                                :     257514956.566420</span><br><span class="line">se.vruntime                                  :             4.333984</span><br><span class="line">se.sum_exec_runtime                          :            25.608097</span><br><span class="line">se.nr_migrations                             :                   17</span><br><span class="line">nr_switches                                  :                  110</span><br><span class="line">nr_voluntary_switches                        :                  110</span><br><span class="line">nr_involuntary_switches                      :                    0</span><br><span class="line">se.load.weight                               :              1048576</span><br><span class="line">se.runnable_weight                           :              1048576</span><br><span class="line">se.avg.load_sum                              :                  183</span><br><span class="line">se.avg.runnable_load_sum                     :                  183</span><br><span class="line">se.avg.util_sum                              :               187416</span><br><span class="line">se.avg.load_avg                              :                    3</span><br><span class="line">se.avg.runnable_load_avg                     :                    3</span><br><span class="line">se.avg.util_avg                              :                    3</span><br><span class="line">se.avg.last_update_time                      :      257514956565504</span><br><span class="line">se.avg.util_est.ewma                         :                    8</span><br><span class="line">se.avg.util_est.enqueued                     :                    0</span><br><span class="line">policy                                       :                    0</span><br><span class="line">prio                                         :                  120</span><br><span class="line">clock-delta                                  :                   50</span><br><span class="line">mm-&gt;numa_scan_seq                            :                    0</span><br><span class="line">numa_pages_migrated                          :                    0</span><br><span class="line">numa_preferred_nid                           :                   -1</span><br><span class="line">total_numa_faults                            :                    0</span><br><span class="line">current_node=0, numa_group_id=0</span><br><span class="line">numa_faults node=0 task_private=0 task_shared=0 group_private=0 group_shared=0</span><br></pre></td></tr></tbody></table></figure>

<p>当设置了pod的Resources的limit和requests的属性如下：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"3600"</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"3.5"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"3.5"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">"500Mi"</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></tbody></table></figure>

<p>可以观察到对应的Resources的参数被设置成了对应的cgroup参数：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /sys/fs/cgroup/cpu/cpu.shares </span></span><br><span class="line">3584</span><br><span class="line">/ <span class="comment"># cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us</span></span><br><span class="line">350000</span><br><span class="line">/ <span class="comment"># cat /sys/fs/cgroup/cpu/cpu.cfs_period_us</span></span><br><span class="line">100000</span><br><span class="line">/ <span class="comment"># cat /proc/sys/kernel/sched_latency_ns</span></span><br><span class="line">24000000</span><br></pre></td></tr></tbody></table></figure>

<p>cpu.shares即为request值:3.5*1024=3584，cpu.cfs_quota_us即为limits值:350000，因此正常情况下，cfs调度器的调度时周期是24ms，而重分配周期是100ms，并且该pod在一个重分配周期中最多可占用35ms，并且有压力的情况下，pod可以占据cpu的share比例是3584</p>
<p><img src="https://github.com/JING21/K8S/raw/main/kubelet/cpumanager/cfs%E8%B0%83%E5%BA%A6.jpg" alt="image-20220729102044974"></p>
<p>在上图的例子中，</p>
<ul>
<li>CFS调度周期为24ms，正常负载的情况下，进程队列中的进程每隔24ms就会被保证执行一次</li>
<li>CFS重分配周期为100ms，用于保证一个进程的limits设置表示每个重分配周期（100ms该例子中）可以占用cpu的时间，多核系统中，max(limit)=CFS重分配周期(100ms)*CPU核数</li>
<li>因为进程A和B的share值一样，所以在cpu中可以占用同样的资源</li>
<li>因为cpu-quota分别为35ms和20ms，所以两个进程在一个重分配周期中，最多占有cpu35ms和20ms</li>
<li>在前面的2个CFS调度周期内，进程A和B由于share值是一样的，所以每个CFS调度内(24ms)，进程A和B都会占用10ms</li>
<li>在第3个CFS调度周期结束的时候，在本CFS重分配周期内，进程B已经占用了20ms，在剩下的2个CFS调度周期即52ms内，进程B都会被限流，一直到下一个CFS重分配周期内，进程B才可以继续占用CPU</li>
<li>在3-5个CFS调度周期内，进程B会被限流，所以进程A在第三个调度周期内可以拥有完整的cpu资源，但是进程A也只能占用cpu资源35ms，所以在4-5周期内也会被限流。</li>
</ul>
<p>所以pod的limit和进程在cfs调度周期内是密切相关的，比如说200m的limit配置，导致进程在cpu的分配周期内100ms只能占用20ms，会出现问题。</p>
<p>如果不指定该参数则默认使用none类型，否则可以指定参数为static，指定了static的调度策略以及reserved-cpus保留策略，生成Guaranteed类型的pod，则可以达到独占cpu的效果。</p>
<ul>
<li>static策略会管理一个CPU共享资源池（Shared CPU Pool），该共享资源池包含节点上所有的CPU资源，可用且可以独占的CPU数量等于节点的CPU总量减去reserved-cpus或者–system-reserved或者–kube-reserved的资源。</li>
<li>通过参数预留的CPU是整数的形式，仅支持完整的单核，不能支持0.5c，0.2c这样的参数。共享池的cpu是Qos类型BestEffort 和 Burstable pod 运行的CPU 集合。同时如果Guaranteed类型的pod声明了非整数型的CPU也会运行在共享池的cpu上，只有指定了正整数类型的CPU的Guaranteed类型的pod才会独占完整CPU。</li>
<li>参照以下的yaml文件配置：</li>
</ul>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"3600"</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.paas/cmss/busybox:1.24</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox-pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"3"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"3"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">"500Mi"</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b]<span class="comment"># for i in `ls cpuset.cpus tasks` ; do echo -n "$i "; cat $i ; done</span></span><br><span class="line">cpuset.cpus 4-6</span><br><span class="line">tasks 5560</span><br><span class="line">[root@node2 9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b]<span class="comment"># cd ..</span></span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># ls</span></span><br><span class="line">10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7  cpuset.memory_migrate</span><br><span class="line">9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b  cpuset.memory_pressure</span><br><span class="line">cgroup.clone_children                                             cpuset.memory_spread_page</span><br><span class="line">cgroup.procs                                                      cpuset.memory_spread_slab</span><br><span class="line">cpuset.cpu_exclusive                                              cpuset.mems</span><br><span class="line">cpuset.cpus                                                       cpuset.sched_load_balance</span><br><span class="line">cpuset.effective_cpus                                             cpuset.sched_relax_domain_level</span><br><span class="line">cpuset.effective_mems                                             notify_on_release</span><br><span class="line">cpuset.mem_exclusive                                              tasks</span><br><span class="line">cpuset.mem_hardwall</span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># cd10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7</span></span><br><span class="line">-bash: cd10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7: 未找到命令</span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># ls</span></span><br><span class="line">10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7  cpuset.memory_migrate</span><br><span class="line">9681336d6f6238ceab6a4dd5998cf1013dd04015f57bab99b0112af556b5ed7b  cpuset.memory_pressure</span><br><span class="line">cgroup.clone_children                                             cpuset.memory_spread_page</span><br><span class="line">cgroup.procs                                                      cpuset.memory_spread_slab</span><br><span class="line">cpuset.cpu_exclusive                                              cpuset.mems</span><br><span class="line">cpuset.cpus                                                       cpuset.sched_load_balance</span><br><span class="line">cpuset.effective_cpus                                             cpuset.sched_relax_domain_level</span><br><span class="line">cpuset.effective_mems                                             notify_on_release</span><br><span class="line">cpuset.mem_exclusive                                              tasks</span><br><span class="line">cpuset.mem_hardwall</span><br><span class="line">[root@node2 pod07550085-3206-4885-bb46-ebb97b8e2200]<span class="comment"># cd 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7</span></span><br><span class="line">[root@node2 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7]<span class="comment"># for i in `ls cpuset.cpus tasks` ; do echo -n "$i "; cat $i ; done</span></span><br><span class="line">cpuset.cpus 0-7</span><br><span class="line">tasks 5396</span><br><span class="line">(reverse-i-search)`grep <span class="string">': history |^Cep cpu</span></span><br><span class="line"><span class="string">[root@node2 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7]# grep '</span>processor<span class="string">' /proc/cpuinfo | wc -l</span></span><br><span class="line"><span class="string">8</span></span><br><span class="line"><span class="string">[root@master cpu]# kubectl describe po cpu-test</span></span><br><span class="line"><span class="string">Name:         cpu-test</span></span><br><span class="line"><span class="string">Namespace:    default</span></span><br><span class="line"><span class="string">Priority:     0</span></span><br><span class="line"><span class="string">Node:         node2/100.73.61.22</span></span><br><span class="line"><span class="string">Start Time:   Fri, 29 Jul 2022 14:19:26 +0800</span></span><br><span class="line"><span class="string">Labels:       &lt;none&gt;</span></span><br><span class="line"><span class="string">Annotations:  cni.projectcalico.org/containerID: 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7</span></span><br><span class="line"><span class="string">              cni.projectcalico.org/podIP: 10.244.104.61/32</span></span><br><span class="line"><span class="string">              cni.projectcalico.org/podIPs: 10.244.104.61/32</span></span><br><span class="line"><span class="string">              k8s.v1.cni.cncf.io/network-status:</span></span><br><span class="line"><span class="string">                [{</span></span><br><span class="line"><span class="string">                    "name": "k8s-pod-network",</span></span><br><span class="line"><span class="string">                    "ips": [</span></span><br><span class="line"><span class="string">                        "10.244.104.61"</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    "default": true,</span></span><br><span class="line"><span class="string">                    "dns": {}</span></span><br><span class="line"><span class="string">                }]</span></span><br><span class="line"><span class="string">              k8s.v1.cni.cncf.io/networks-status:</span></span><br><span class="line"><span class="string">                [{</span></span><br><span class="line"><span class="string">                    "name": "k8s-pod-network",</span></span><br><span class="line"><span class="string">                    "ips": [</span></span><br><span class="line"><span class="string">                        "10.244.104.61"</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    "default": true,</span></span><br><span class="line"><span class="string">                    "dns": {}</span></span><br><span class="line"><span class="string">                }]</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/allocated: true</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/cidr: 10.16.0.0/16,fd00:10:16::/64</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/gateway: 10.16.0.1,fd00:10:16::1</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/ip_address: 10.16.0.10,fd00:10:16::a</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/logical_router: ovn-cluster</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/logical_switch: ovn-default</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/mac_address: 00:00:00:4D:3C:02</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/pod_nic_type: veth-pair</span></span><br><span class="line"><span class="string">              ovn.kubernetes.io/routed: true</span></span><br><span class="line"><span class="string">Status:       Running</span></span><br><span class="line"><span class="string">IP:           10.244.104.61</span></span><br><span class="line"><span class="string">IPs:</span></span><br><span class="line"><span class="string">  IP:  10.244.104.61</span></span><br><span class="line"><span class="string">Containers:</span></span><br><span class="line"><span class="string">  busybox-pod1:</span></span><br><span class="line"><span class="string">    Container ID:  docker://3d476202aeb46d4431e9073e521103cda36d0262f2def11b41d56d89e78d5c8c</span></span><br><span class="line"><span class="string">    Image:         registry.paas/cmss/busybox:1.24</span></span><br><span class="line"><span class="string">    Image ID:      docker-pullable://registry.paas/cmss/busybox@sha256:f73ae051fae52945d92ee20d62c315306c593c59a429ccbbdcba4a488ee12269</span></span><br><span class="line"><span class="string">    Port:          &lt;none&gt;</span></span><br><span class="line"><span class="string">    Host Port:     &lt;none&gt;</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      sleep</span></span><br><span class="line"><span class="string">      3600</span></span><br><span class="line"><span class="string">    State:          Running</span></span><br><span class="line"><span class="string">      Started:      Fri, 29 Jul 2022 15:19:27 +0800</span></span><br><span class="line"><span class="string">    Last State:     Terminated</span></span><br><span class="line"><span class="string">      Reason:       Completed</span></span><br><span class="line"><span class="string">      Exit Code:    0</span></span><br><span class="line"><span class="string">      Started:      Fri, 29 Jul 2022 14:19:27 +0800</span></span><br><span class="line"><span class="string">      Finished:     Fri, 29 Jul 2022 15:19:27 +0800</span></span><br><span class="line"><span class="string">    Ready:          True</span></span><br><span class="line"><span class="string">    Restart Count:  1</span></span><br><span class="line"><span class="string">    Limits:</span></span><br><span class="line"><span class="string">      cpu:     3</span></span><br><span class="line"><span class="string">      memory:  500Mi</span></span><br><span class="line"><span class="string">    Requests:</span></span><br><span class="line"><span class="string">      cpu:        3</span></span><br><span class="line"><span class="string">      memory:     500Mi</span></span><br><span class="line"><span class="string">    Environment:  &lt;none&gt;</span></span><br><span class="line"><span class="string">    Mounts:</span></span><br><span class="line"><span class="string">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-6z7rt (ro)</span></span><br><span class="line"><span class="string">Conditions:</span></span><br><span class="line"><span class="string">  Type              Status</span></span><br><span class="line"><span class="string">  Initialized       True</span></span><br><span class="line"><span class="string">  Ready             True</span></span><br><span class="line"><span class="string">  ContainersReady   True</span></span><br><span class="line"><span class="string">  PodScheduled      True</span></span><br><span class="line"><span class="string">Volumes:</span></span><br><span class="line"><span class="string">  kube-api-access-6z7rt:</span></span><br><span class="line"><span class="string">    Type:                    Projected (a volume that contains injected data from multiple sources)</span></span><br><span class="line"><span class="string">    TokenExpirationSeconds:  3607</span></span><br><span class="line"><span class="string">    ConfigMapName:           kube-root-ca.crt</span></span><br><span class="line"><span class="string">    ConfigMapOptional:       &lt;nil&gt;</span></span><br><span class="line"><span class="string">    DownwardAPI:             true</span></span><br><span class="line"><span class="string">QoS Class:                   Guaranteed</span></span><br><span class="line"><span class="string">Node-Selectors:              &lt;none&gt;</span></span><br><span class="line"><span class="string">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span></span><br><span class="line"><span class="string">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span></span><br><span class="line"><span class="string">Events:</span></span><br><span class="line"><span class="string">  Type    Reason   Age                From     Message</span></span><br><span class="line"><span class="string">  ----    ------   ----               ----     -------</span></span><br><span class="line"><span class="string">  Normal  Pulled   39m (x2 over 99m)  kubelet  Container image "registry.paas/cmss/busybox:1.24" already present on machine</span></span><br><span class="line"><span class="string">  Normal  Created  39m (x2 over 99m)  kubelet  Created container busybox-pod1</span></span><br><span class="line"><span class="string">  Normal  Started  39m (x2 over 99m)  kubelet  Started container busybox-pod1</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">[root@node2 10513fe58e11396ba00ee4feeb61073c96eb23f06f912c26c02bddfe4361cae7]# cat /var/lib/kubelet/config.yaml</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">authentication:</span></span><br><span class="line"><span class="string">  anonymous:</span></span><br><span class="line"><span class="string">    enabled: false</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheTTL: 0s</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">  x509:</span></span><br><span class="line"><span class="string">    clientCAFile: /etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">authorization:</span></span><br><span class="line"><span class="string">  mode: Webhook</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheAuthorizedTTL: 0s</span></span><br><span class="line"><span class="string">    cacheUnauthorizedTTL: 0s</span></span><br><span class="line"><span class="string">cgroupDriver: cgroupfs</span></span><br><span class="line"><span class="string">clusterDNS:</span></span><br><span class="line"><span class="string">- 10.96.0.10</span></span><br><span class="line"><span class="string">clusterDomain: cluster.local</span></span><br><span class="line"><span class="string">cpuManagerReconcilePeriod: 0s</span></span><br><span class="line"><span class="string">evictionPressureTransitionPeriod: 0s</span></span><br><span class="line"><span class="string">fileCheckFrequency: 0s</span></span><br><span class="line"><span class="string">healthzBindAddress: 127.0.0.1</span></span><br><span class="line"><span class="string">healthzPort: 10248</span></span><br><span class="line"><span class="string">httpCheckFrequency: 0s</span></span><br><span class="line"><span class="string">imageMinimumGCAge: 0s</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration</span></span><br><span class="line"><span class="string">logging: {}</span></span><br><span class="line"><span class="string">nodeStatusReportFrequency: 0s</span></span><br><span class="line"><span class="string">nodeStatusUpdateFrequency: 0s</span></span><br><span class="line"><span class="string">rotateCertificates: true</span></span><br><span class="line"><span class="string">runtimeRequestTimeout: 0s</span></span><br><span class="line"><span class="string">shutdownGracePeriod: 0s</span></span><br><span class="line"><span class="string">shutdownGracePeriodCriticalPods: 0s</span></span><br><span class="line"><span class="string">staticPodPath: /etc/kubernetes/manifests</span></span><br><span class="line"><span class="string">streamingConnectionIdleTimeout: 0s</span></span><br><span class="line"><span class="string">syncFrequency: 0s</span></span><br><span class="line"><span class="string">volumeStatsAggPeriod: 0s</span></span><br><span class="line"><span class="string">reservedSystemCPUs: "0-3"</span></span><br><span class="line"><span class="string">cpuManagerPolicy: static</span></span><br></pre></td></tr></tbody></table></figure>

<p>从结果可以看出，该pod的类型是Guaranteed类型，同时因为kubelet配置了reserved-cpus，保留了4个核，(reservedSystemCPUs: “0-3”)，所以该pod的业务容器只会使用cpuset.cpus 4-6,不会使用0-3这三个核，但是每个pod的根容器（pause容器）则会使用到预留资源的核0-3，会默认随机使用0-7所有的cpu。</p>
<p>所以目前的能满足的情况是，在pod配置为Guaranteed类型的Qos的pod后，并且cpu使用必须声明为整数类型，才能独占cpu，不使用保留的cpus。</p>
<h3 id="Kubelet相关代码分析"><a href="#Kubelet相关代码分析" class="headerlink" title="Kubelet相关代码分析"></a>Kubelet相关代码分析</h3><p>kubelet的代码结构使用传统的golang结构cmd/pkg结构，启动代码中与cpu-manager相关的如下所示(未包含全部)：</p>
<p>cmd/kubelet/app/server.go</p>
<figure class="highlight golang"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(ctx context.Context, s *options.KubeletServer, kubeDeps *kubelet.Dependencies, featureGate featuregate.FeatureGate)</span></span> (err <span class="type">error</span>) {</span><br><span class="line">    ···</span><br><span class="line">		<span class="keyword">var</span> reservedSystemCPUs cpuset.CPUSet</span><br><span class="line">		<span class="keyword">if</span> s.ReservedSystemCPUs != <span class="string">""</span> {</span><br><span class="line">			<span class="comment">// is it safe do use CAdvisor here ??</span></span><br><span class="line">			machineInfo, err := kubeDeps.CAdvisorInterface.MachineInfo()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">				<span class="comment">// if can't use CAdvisor here, fall back to non-explicit cpu list behavor</span></span><br><span class="line">				klog.InfoS(<span class="string">"Failed to get MachineInfo, set reservedSystemCPUs to empty"</span>)</span><br><span class="line">				reservedSystemCPUs = cpuset.NewCPUSet()</span><br><span class="line">			} <span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">var</span> errParse <span class="type">error</span></span><br><span class="line">				reservedSystemCPUs, errParse = cpuset.Parse(s.ReservedSystemCPUs)</span><br><span class="line">				<span class="keyword">if</span> errParse != <span class="literal">nil</span> {</span><br><span class="line">					<span class="comment">// invalid cpu list is provided, set reservedSystemCPUs to empty, so it won't overwrite kubeReserved/systemReserved</span></span><br><span class="line">					klog.InfoS(<span class="string">"Invalid ReservedSystemCPUs"</span>, <span class="string">"systemReservedCPUs"</span>, s.ReservedSystemCPUs)</span><br><span class="line">					<span class="keyword">return</span> errParse</span><br><span class="line">				}</span><br><span class="line">				reservedList := reservedSystemCPUs.ToSlice()</span><br><span class="line">				first := reservedList[<span class="number">0</span>]</span><br><span class="line">				last := reservedList[<span class="built_in">len</span>(reservedList)<span class="number">-1</span>]</span><br><span class="line">				<span class="keyword">if</span> first &lt; <span class="number">0</span> || last &gt;= machineInfo.NumCores {</span><br><span class="line">					<span class="comment">// the specified cpuset is outside of the range of what the machine has</span></span><br><span class="line">					klog.InfoS(<span class="string">"Invalid cpuset specified by --reserved-cpus"</span>)</span><br><span class="line">					<span class="keyword">return</span> fmt.Errorf(<span class="string">"Invalid cpuset %q specified by --reserved-cpus"</span>, s.ReservedSystemCPUs)</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			reservedSystemCPUs = cpuset.NewCPUSet()</span><br><span class="line">		}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> reservedSystemCPUs.Size() &gt; <span class="number">0</span> {</span><br><span class="line">			<span class="comment">// at cmd option valication phase it is tested either --system-reserved-cgroup or --kube-reserved-cgroup is specified, so overwrite should be ok</span></span><br><span class="line">			klog.InfoS(<span class="string">"Option --reserved-cpus is specified, it will overwrite the cpu setting in KubeReserved and SystemReserved"</span>, <span class="string">"kubeReservedCPUs"</span>, s.KubeReserved, <span class="string">"systemReservedCPUs"</span>, s.SystemReserved)</span><br><span class="line">			<span class="keyword">if</span> s.KubeReserved != <span class="literal">nil</span> {</span><br><span class="line">				<span class="built_in">delete</span>(s.KubeReserved, <span class="string">"cpu"</span>)</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">if</span> s.SystemReserved == <span class="literal">nil</span> {</span><br><span class="line">				s.SystemReserved = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">			}</span><br><span class="line">			s.SystemReserved[<span class="string">"cpu"</span>] = strconv.Itoa(reservedSystemCPUs.Size())</span><br><span class="line">			klog.InfoS(<span class="string">"After cpu setting is overwritten"</span>, <span class="string">"kubeReservedCPUs"</span>, s.KubeReserved, <span class="string">"systemReservedCPUs"</span>, s.SystemReserved)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		kubeReserved, err := parseResourceList(s.KubeReserved)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		}</span><br><span class="line">		systemReserved, err := parseResourceList(s.SystemReserved)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">    ···</span><br><span class="line">  </span><br><span class="line">		kubeDeps.ContainerManager, err = cm.NewContainerManager(</span><br><span class="line">			kubeDeps.Mounter,</span><br><span class="line">			kubeDeps.CAdvisorInterface,</span><br><span class="line">			cm.NodeConfig{</span><br><span class="line">				RuntimeCgroupsName:    s.RuntimeCgroups,</span><br><span class="line">				SystemCgroupsName:     s.SystemCgroups,</span><br><span class="line">				KubeletCgroupsName:    s.KubeletCgroups,</span><br><span class="line">				ContainerRuntime:      s.ContainerRuntime,</span><br><span class="line">				CgroupsPerQOS:         s.CgroupsPerQOS,</span><br><span class="line">				CgroupRoot:            s.CgroupRoot,</span><br><span class="line">				CgroupDriver:          s.CgroupDriver,</span><br><span class="line">				KubeletRootDir:        s.RootDirectory,</span><br><span class="line">				ProtectKernelDefaults: s.ProtectKernelDefaults,</span><br><span class="line">				NodeAllocatableConfig: cm.NodeAllocatableConfig{</span><br><span class="line">					KubeReservedCgroupName:   s.KubeReservedCgroup,</span><br><span class="line">					SystemReservedCgroupName: s.SystemReservedCgroup,</span><br><span class="line">					EnforceNodeAllocatable:   sets.NewString(s.EnforceNodeAllocatable...),</span><br><span class="line">					KubeReserved:             kubeReserved,</span><br><span class="line">					SystemReserved:           systemReserved,</span><br><span class="line">					ReservedSystemCPUs:       reservedSystemCPUs,</span><br><span class="line">					HardEvictionThresholds:   hardEvictionThresholds,</span><br><span class="line">				},</span><br><span class="line">				QOSReserved:                             *experimentalQOSReserved,</span><br><span class="line">				ExperimentalCPUManagerPolicy:            s.CPUManagerPolicy,</span><br><span class="line">				ExperimentalCPUManagerReconcilePeriod:   s.CPUManagerReconcilePeriod.Duration,</span><br><span class="line">				ExperimentalMemoryManagerPolicy:         s.MemoryManagerPolicy,</span><br><span class="line">				ExperimentalMemoryManagerReservedMemory: s.ReservedMemory,</span><br><span class="line">				ExperimentalPodPidsLimit:                s.PodPidsLimit,</span><br><span class="line">				EnforceCPULimits:                        s.CPUCFSQuota,</span><br><span class="line">				CPUCFSQuotaPeriod:                       s.CPUCFSQuotaPeriod.Duration,</span><br><span class="line">				ExperimentalTopologyManagerPolicy:       s.TopologyManagerPolicy,</span><br><span class="line">				ExperimentalTopologyManagerScope:        s.TopologyManagerScope,</span><br><span class="line">			},</span><br><span class="line">			s.FailSwapOn,</span><br><span class="line">			devicePluginEnabled,</span><br><span class="line">			kubeDeps.Recorder)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">  ···</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>和容器cpu相关的主要是以上的代码，流程主要是取到flag中定义的启动参数–reserved-cpus参数，并使用cpuset.Parse方法将其转换为cpuset类型，然后将ReservedSystemCPUs构建为一个切片数组，与通过cadvisor取到的machineinfo中的cpu字段进行一个对比，判断是否传入的reserved-cpus参数，有不属于该节点实际的cpu。校验通过后，如果ReservedSystemCPUs的值存在，则会覆盖掉另外的两个系统参数中KubeReserved和SystemReserved中关于cpu的相关数据。最后初始化cm.NewContainerManager</p>
<p>pkg/kubelet/cm/container_manager_linux.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewContainerManager</span><span class="params">(mountUtil mount.Interface, cadvisorInterface cadvisor.Interface, nodeConfig NodeConfig, failSwapOn <span class="type">bool</span>, devicePluginEnabled <span class="type">bool</span>, recorder record.EventRecorder)</span></span> (ContainerManager, <span class="type">error</span>) {</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize CPU manager</span></span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(kubefeatures.CPUManager) {</span><br><span class="line">		cm.cpuManager, err = cpumanager.NewManager(</span><br><span class="line">			nodeConfig.ExperimentalCPUManagerPolicy,</span><br><span class="line">			nodeConfig.ExperimentalCPUManagerReconcilePeriod,</span><br><span class="line">			machineInfo,</span><br><span class="line">			nodeConfig.NodeAllocatableConfig.ReservedSystemCPUs,</span><br><span class="line">			cm.GetNodeAllocatableReservation(),</span><br><span class="line">			nodeConfig.KubeletRootDir,</span><br><span class="line">			cm.topologyManager,</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			klog.ErrorS(err, <span class="string">"Failed to initialize cpu manager"</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		}</span><br><span class="line">		cm.topologyManager.AddHintProvider(cm.cpuManager)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cm, <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>NewContainerManager初始化containerManager，其中包含了多个实现的ContainerManager：cgroupManager，qosContainerManager，topologyManager，cpuManager，memoryManager等。主要看cpuManager相关的，判断cpuManager特性是否开启，如果特性开启的话，会调用**cpumanager.NewManager()**初始化一个cpuManager。具体代码如下：</p>
<p>pkg/kubelet/cm/cpumanager/cpu_manager.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewManager creates new cpu manager based on provided policy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewManager</span><span class="params">(cpuPolicyName <span class="type">string</span>, reconcilePeriod time.Duration, machineInfo *cadvisorapi.MachineInfo, specificCPUs cpuset.CPUSet, nodeAllocatableReservation v1.ResourceList, stateFileDirectory <span class="type">string</span>, affinity topologymanager.Store)</span></span> (Manager, <span class="type">error</span>) {</span><br><span class="line">	<span class="keyword">var</span> topo *topology.CPUTopology</span><br><span class="line">	<span class="keyword">var</span> policy Policy</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> policyName(cpuPolicyName) {</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> PolicyNone:</span><br><span class="line">		policy = NewNonePolicy()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> PolicyStatic:</span><br><span class="line">		<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">		topo, err = topology.Discover(machineInfo)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		}</span><br><span class="line">		klog.InfoS(<span class="string">"Detected CPU topology"</span>, <span class="string">"topology"</span>, topo)</span><br><span class="line"></span><br><span class="line">		reservedCPUs, ok := nodeAllocatableReservation[v1.ResourceCPU]</span><br><span class="line">		<span class="keyword">if</span> !ok {</span><br><span class="line">			<span class="comment">// The static policy cannot initialize without this information.</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"[cpumanager] unable to determine reserved CPU resources for static policy"</span>)</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> reservedCPUs.IsZero() {</span><br><span class="line">			<span class="comment">// The static policy requires this to be nonzero. Zero CPU reservation</span></span><br><span class="line">			<span class="comment">// would allow the shared pool to be completely exhausted. At that point</span></span><br><span class="line">			<span class="comment">// either we would violate our guarantee of exclusivity or need to evict</span></span><br><span class="line">			<span class="comment">// any pod that has at least one container that requires zero CPUs.</span></span><br><span class="line">			<span class="comment">// See the comments in policy_static.go for more details.</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"[cpumanager] the static policy requires systemreserved.cpu + kubereserved.cpu to be greater than zero"</span>)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Take the ceiling of the reservation, since fractional CPUs cannot be</span></span><br><span class="line">		<span class="comment">// exclusively allocated.</span></span><br><span class="line">		reservedCPUsFloat := <span class="type">float64</span>(reservedCPUs.MilliValue()) / <span class="number">1000</span></span><br><span class="line">		numReservedCPUs := <span class="type">int</span>(math.Ceil(reservedCPUsFloat))</span><br><span class="line">		policy, err = NewStaticPolicy(topo, numReservedCPUs, specificCPUs, affinity)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"new static policy error: %v"</span>, err)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unknown policy: \"%s\""</span>, cpuPolicyName)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	manager := &amp;manager{</span><br><span class="line">		policy:                     policy,</span><br><span class="line">		reconcilePeriod:            reconcilePeriod,</span><br><span class="line">		topology:                   topo,</span><br><span class="line">		nodeAllocatableReservation: nodeAllocatableReservation,</span><br><span class="line">		stateFileDirectory:         stateFileDirectory,</span><br><span class="line">	}</span><br><span class="line">	manager.sourcesReady = &amp;sourcesReadyStub{}</span><br><span class="line">	<span class="keyword">return</span> manager, <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>pkg/kubelet/cm/cpumanager/policy.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Policy implements logic for pod container to CPU assignment.</span></span><br><span class="line"><span class="keyword">type</span> Policy <span class="keyword">interface</span> {</span><br><span class="line">	Name() <span class="type">string</span></span><br><span class="line">	Start(s state.State) <span class="type">error</span></span><br><span class="line">	<span class="comment">// Allocate call is idempotent</span></span><br><span class="line">	Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line">	<span class="comment">// RemoveContainer call is idempotent</span></span><br><span class="line">	RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	<span class="comment">// GetTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line">	<span class="comment">// and is consulted to achieve NUMA aware resource alignment among this</span></span><br><span class="line">	<span class="comment">// and other resource controllers.</span></span><br><span class="line">	GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">	<span class="comment">// GetPodTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line">	<span class="comment">// and is consulted to achieve NUMA aware resource alignment per Pod</span></span><br><span class="line">	<span class="comment">// among this and other resource controllers.</span></span><br><span class="line">	GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">	<span class="comment">// GetAllocatableCPUs returns the assignable (not allocated) CPUs</span></span><br><span class="line">	GetAllocatableCPUs(m state.State) cpuset.CPUSet</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>NewManager会创建一个<strong>topology.CPUTopology</strong>，同时会声明一个Policy的接口，根据传入的不同Policy类型，调用具体的Policy实现，Policy需要实现具体的pod容器的cpu 分配方法。现在Kubernetes默认支持的policy有两种，具体参数为kubelet启动时传入的–cpu-manager-policy=static，默认不启用default的情况，Policy就是none。</p>
<p>pkg/kubelet/cm/cpumanager/policy_none.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment">you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">limitations under the License.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cpumanager</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"k8s.io/api/core/v1"</span></span><br><span class="line">	<span class="string">"k8s.io/klog/v2"</span></span><br><span class="line">	<span class="string">"k8s.io/kubernetes/pkg/kubelet/cm/cpumanager/state"</span></span><br><span class="line">	<span class="string">"k8s.io/kubernetes/pkg/kubelet/cm/cpuset"</span></span><br><span class="line">	<span class="string">"k8s.io/kubernetes/pkg/kubelet/cm/topologymanager"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> nonePolicy <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ Policy = &amp;nonePolicy{}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolicyNone name of none policy</span></span><br><span class="line"><span class="keyword">const</span> PolicyNone policyName = <span class="string">"none"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewNonePolicy returns a cpuset manager policy that does nothing</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNonePolicy</span><span class="params">()</span></span> Policy {</span><br><span class="line">	<span class="keyword">return</span> &amp;nonePolicy{}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> Name() <span class="type">string</span> {</span><br><span class="line">	<span class="keyword">return</span> <span class="type">string</span>(PolicyNone)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> Start(s state.State) <span class="type">error</span> {</span><br><span class="line">	klog.InfoS(<span class="string">"None policy: Start"</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span> {</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span> {</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint {</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint {</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assignable CPUs are the ones that can be exclusively allocated to pods that meet the exclusivity requirement</span></span><br><span class="line"><span class="comment">// (ie guaranteed QoS class and integral CPU request).</span></span><br><span class="line"><span class="comment">// Assignability of CPUs as a concept is only applicable in case of static policy i.e. scenarios where workloads</span></span><br><span class="line"><span class="comment">// CAN get exclusive access to core(s).</span></span><br><span class="line"><span class="comment">// Hence, we return empty set here: no cpus are assignable according to above definition with this policy.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *nonePolicy)</span></span> GetAllocatableCPUs(m state.State) cpuset.CPUSet {</span><br><span class="line">	<span class="keyword">return</span> cpuset.NewCPUSet()</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>默认None Policy没有具体实现Policy接口，仅仅返回空值，表示对cpu分配不做管理。</p>
<p>而Static Policy首先在创建CPUManager的时候就会进行校验，首先根据cadvisor取到的machineInfo（节点信息），根据**topology.Dicsovery(machineInfo)**可以生成具体的cpu拓扑信息,包含了节点cpu逻辑核数，物理核数和cpu socket数</p>
<p><img src="https://github.com/JING21/K8S/raw/main/kubelet/cpumanager/topo.png" alt="image-20220809155145496"></p>
<p>pkg/kubelet/cm/cpumanager/topology/topology.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CPUTopology contains details of node cpu, where :</span></span><br><span class="line"><span class="comment">// CPU  - logical CPU, cadvisor - thread</span></span><br><span class="line"><span class="comment">// Core - physical CPU, cadvisor - Core</span></span><br><span class="line"><span class="comment">// Socket - socket, cadvisor - Node</span></span><br><span class="line"><span class="keyword">type</span> CPUTopology <span class="keyword">struct</span> {</span><br><span class="line">	NumCPUs    <span class="type">int</span></span><br><span class="line">	NumCores   <span class="type">int</span></span><br><span class="line">	NumSockets <span class="type">int</span></span><br><span class="line">	CPUDetails CPUDetails</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPUDetails is a map from CPU ID to Core ID, Socket ID, and NUMA ID.</span></span><br><span class="line"><span class="keyword">type</span> CPUDetails <span class="keyword">map</span>[<span class="type">int</span>]CPUInfo</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPUInfo contains the NUMA, socket, and core IDs associated with a CPU.</span></span><br><span class="line"><span class="keyword">type</span> CPUInfo <span class="keyword">struct</span> {</span><br><span class="line">	NUMANodeID <span class="type">int</span></span><br><span class="line">	SocketID   <span class="type">int</span></span><br><span class="line">	CoreID     <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来就会进行校验工作，判断reservedCPUS是否存在，启用Static CPU Policy必须开启reserved-CPUs的特性。在确保reservedCPUs不为0的情况下，向上取整计算出具体保留的numReservedCPUs。同时调用NewStaticPolicy()方法，初始化StaticPolicy。</p>
<p>pkg/kubelet/cm/cpumanager/policy_static.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewStaticPolicy returns a CPU manager policy that does not change CPU</span></span><br><span class="line"><span class="comment">// assignments for exclusively pinned guaranteed containers after the main</span></span><br><span class="line"><span class="comment">// container process starts.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStaticPolicy</span><span class="params">(topology *topology.CPUTopology, numReservedCPUs <span class="type">int</span>, reservedCPUs cpuset.CPUSet, affinity topologymanager.Store)</span></span> (Policy, <span class="type">error</span>) {</span><br><span class="line">	allCPUs := topology.CPUDetails.CPUs()</span><br><span class="line">	<span class="keyword">var</span> reserved cpuset.CPUSet</span><br><span class="line">	<span class="keyword">if</span> reservedCPUs.Size() &gt; <span class="number">0</span> {</span><br><span class="line">		reserved = reservedCPUs</span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		<span class="comment">// takeByTopology allocates CPUs associated with low-numbered cores from</span></span><br><span class="line">		<span class="comment">// allCPUs.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// For example: Given a system with 8 CPUs available and HT enabled,</span></span><br><span class="line">		<span class="comment">// if numReservedCPUs=2, then reserved={0,4}</span></span><br><span class="line">		reserved, _ = takeByTopology(topology, allCPUs, numReservedCPUs)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> reserved.Size() != numReservedCPUs {</span><br><span class="line">		err := fmt.Errorf(<span class="string">"[cpumanager] unable to reserve the required amount of CPUs (size of %s did not equal %d)"</span>, reserved, numReservedCPUs)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	klog.InfoS(<span class="string">"Reserved CPUs not available for exclusive assignment"</span>, <span class="string">"reservedSize"</span>, reserved.Size(), <span class="string">"reserved"</span>, reserved)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;staticPolicy{</span><br><span class="line">		topology:    topology,</span><br><span class="line">		reserved:    reserved,</span><br><span class="line">		affinity:    affinity,</span><br><span class="line">		cpusToReuse: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet),</span><br><span class="line">	}, <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>NewStaticPolicy会校验传入的reservedCPUs，如果其为空，则会根据numReservedCPUs，在allCPUs中通过takeByTopology（）方法，随机保留下对应数量的cpu，比如说numReservedCPUs为2，可能会保留0，4两个核。</p>
<p>pkg/kubelet/cm/cpumanager/policy.go</p>
<figure class="highlight golang"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Policy <span class="keyword">interface</span> {</span><br><span class="line">	Name() <span class="type">string</span></span><br><span class="line">	Start(s state.State) <span class="type">error</span></span><br><span class="line">	<span class="comment">// Allocate call is idempotent</span></span><br><span class="line">	Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line">	<span class="comment">// RemoveContainer call is idempotent</span></span><br><span class="line">	RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	<span class="comment">// GetTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line">	<span class="comment">// and is consulted to achieve NUMA aware resource alignment among this</span></span><br><span class="line">	<span class="comment">// and other resource controllers.</span></span><br><span class="line">	GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">	<span class="comment">// GetPodTopologyHints implements the topologymanager.HintProvider Interface</span></span><br><span class="line">	<span class="comment">// and is consulted to achieve NUMA aware resource alignment per Pod</span></span><br><span class="line">	<span class="comment">// among this and other resource controllers.</span></span><br><span class="line">	GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">	<span class="comment">// GetAllocatableCPUs returns the assignable (not allocated) CPUs</span></span><br><span class="line">	GetAllocatableCPUs(m state.State) cpuset.CPUSet</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>cpu分配的具体policy需要实现以下具体的接口，包括了Name，Allocate(用于分配cpu给具体的pod的容器)，RemoveContainer， GetTopologyHints（根据pod的当前情况，获取cpu的topo关系），GetAllocatableCPUs（获取可用的cpuset），GetPodTopologyHints（实现了topologymanager.HintProvider的接口，生成NUMA亲和性相关性的map关系，用于cpu的分配）</p>
<p>pkg/kubelet/cm/cpumanager/policy_static.go</p>
<figure class="highlight golang"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> validateState(s state.State) <span class="type">error</span> {</span><br><span class="line">	tmpAssignments := s.GetCPUAssignments()</span><br><span class="line">	tmpDefaultCPUset := s.GetDefaultCPUSet()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Default cpuset cannot be empty when assignments exist</span></span><br><span class="line">	<span class="keyword">if</span> tmpDefaultCPUset.IsEmpty() {</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(tmpAssignments) != <span class="number">0</span> {</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"default cpuset cannot be empty"</span>)</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// state is empty initialize</span></span><br><span class="line">		allCPUs := p.topology.CPUDetails.CPUs()</span><br><span class="line">		s.SetDefaultCPUSet(allCPUs)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// State has already been initialized from file (is not empty)</span></span><br><span class="line">	<span class="comment">// 1. Check if the reserved cpuset is not part of default cpuset because:</span></span><br><span class="line">	<span class="comment">// - kube/system reserved have changed (increased) - may lead to some containers not being able to start</span></span><br><span class="line">	<span class="comment">// - user tampered with file</span></span><br><span class="line">	<span class="keyword">if</span> !p.reserved.Intersection(tmpDefaultCPUset).Equals(p.reserved) {</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"not all reserved cpus: \"%s\" are present in defaultCpuSet: \"%s\""</span>,</span><br><span class="line">			p.reserved.String(), tmpDefaultCPUset.String())</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. Check if state for static policy is consistent</span></span><br><span class="line">	<span class="keyword">for</span> pod := <span class="keyword">range</span> tmpAssignments {</span><br><span class="line">		<span class="keyword">for</span> container, cset := <span class="keyword">range</span> tmpAssignments[pod] {</span><br><span class="line">			<span class="comment">// None of the cpu in DEFAULT cset should be in s.assignments</span></span><br><span class="line">			<span class="keyword">if</span> !tmpDefaultCPUset.Intersection(cset).IsEmpty() {</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"pod: %s, container: %s cpuset: \"%s\" overlaps with default cpuset \"%s\""</span>,</span><br><span class="line">					pod, container, cset.String(), tmpDefaultCPUset.String())</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. It's possible that the set of available CPUs has changed since</span></span><br><span class="line">	<span class="comment">// the state was written. This can be due to for example</span></span><br><span class="line">	<span class="comment">// offlining a CPU when kubelet is not running. If this happens,</span></span><br><span class="line">	<span class="comment">// CPU manager will run into trouble when later it tries to</span></span><br><span class="line">	<span class="comment">// assign non-existent CPUs to containers. Validate that the</span></span><br><span class="line">	<span class="comment">// topology that was received during CPU manager startup matches with</span></span><br><span class="line">	<span class="comment">// the set of CPUs stored in the state.</span></span><br><span class="line">	totalKnownCPUs := tmpDefaultCPUset.Clone()</span><br><span class="line">	tmpCPUSets := []cpuset.CPUSet{}</span><br><span class="line">	<span class="keyword">for</span> pod := <span class="keyword">range</span> tmpAssignments {</span><br><span class="line">		<span class="keyword">for</span> _, cset := <span class="keyword">range</span> tmpAssignments[pod] {</span><br><span class="line">			tmpCPUSets = <span class="built_in">append</span>(tmpCPUSets, cset)</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	totalKnownCPUs = totalKnownCPUs.UnionAll(tmpCPUSets)</span><br><span class="line">	<span class="keyword">if</span> !totalKnownCPUs.Equals(p.topology.CPUDetails.CPUs()) {</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"current set of available CPUs \"%s\" doesn't match with CPUs in state \"%s\""</span>,</span><br><span class="line">			p.topology.CPUDetails.CPUs().String(), totalKnownCPUs.String())</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAllocatableCPUs returns the set of unassigned CPUs minus the reserved set.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> GetAllocatableCPUs(s state.State) cpuset.CPUSet {</span><br><span class="line">	<span class="keyword">return</span> s.GetDefaultCPUSet().Difference(p.reserved)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> updateCPUsToReuse(pod *v1.Pod, container *v1.Container, cset cpuset.CPUSet) {</span><br><span class="line">	<span class="comment">// If pod entries to m.cpusToReuse other than the current pod exist, delete them.</span></span><br><span class="line">	<span class="keyword">for</span> podUID := <span class="keyword">range</span> p.cpusToReuse {</span><br><span class="line">		<span class="keyword">if</span> podUID != <span class="type">string</span>(pod.UID) {</span><br><span class="line">			<span class="built_in">delete</span>(p.cpusToReuse, podUID)</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// If no cpuset exists for cpusToReuse by this pod yet, create one.</span></span><br><span class="line">	<span class="keyword">if</span> _, ok := p.cpusToReuse[<span class="type">string</span>(pod.UID)]; !ok {</span><br><span class="line">		p.cpusToReuse[<span class="type">string</span>(pod.UID)] = cpuset.NewCPUSet()</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// Check if the container is an init container.</span></span><br><span class="line">	<span class="comment">// If so, add its cpuset to the cpuset of reusable CPUs for any new allocations.</span></span><br><span class="line">	<span class="keyword">for</span> _, initContainer := <span class="keyword">range</span> pod.Spec.InitContainers {</span><br><span class="line">		<span class="keyword">if</span> container.Name == initContainer.Name {</span><br><span class="line">			p.cpusToReuse[<span class="type">string</span>(pod.UID)] = p.cpusToReuse[<span class="type">string</span>(pod.UID)].Union(cset)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// Otherwise it is an app container.</span></span><br><span class="line">	<span class="comment">// Remove its cpuset from the cpuset of reusable CPUs for any new allocations.</span></span><br><span class="line">	p.cpusToReuse[<span class="type">string</span>(pod.UID)] = p.cpusToReuse[<span class="type">string</span>(pod.UID)].Difference(cset)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span> {</span><br><span class="line">	<span class="keyword">if</span> numCPUs := p.guaranteedCPUs(pod, container); numCPUs != <span class="number">0</span> {</span><br><span class="line">		klog.InfoS(<span class="string">"Static policy: Allocate"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name)</span><br><span class="line">		<span class="comment">// container belongs in an exclusively allocated pool</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> p.options.FullPhysicalCPUsOnly &amp;&amp; ((numCPUs % p.topology.CPUsPerCore()) != <span class="number">0</span>) {</span><br><span class="line">			<span class="comment">// Since CPU Manager has been enabled requesting strict SMT alignment, it means a guaranteed pod can only be admitted</span></span><br><span class="line">			<span class="comment">// if the CPU requested is a multiple of the number of virtual cpus per physical cores.</span></span><br><span class="line">			<span class="comment">// In case CPU request is not a multiple of the number of virtual cpus per physical cores the Pod will be put</span></span><br><span class="line">			<span class="comment">// in Failed state, with SMTAlignmentError as reason. Since the allocation happens in terms of physical cores</span></span><br><span class="line">			<span class="comment">// and the scheduler is responsible for ensuring that the workload goes to a node that has enough CPUs,</span></span><br><span class="line">			<span class="comment">// the pod would be placed on a node where there are enough physical cores available to be allocated.</span></span><br><span class="line">			<span class="comment">// Just like the behaviour in case of static policy, takeByTopology will try to first allocate CPUs from the same socket</span></span><br><span class="line">			<span class="comment">// and only in case the request cannot be sattisfied on a single socket, CPU allocation is done for a workload to occupy all</span></span><br><span class="line">			<span class="comment">// CPUs on a physical core. Allocation of individual threads would never have to occur.</span></span><br><span class="line">			<span class="keyword">return</span> SMTAlignmentError{</span><br><span class="line">				RequestedCPUs: numCPUs,</span><br><span class="line">				CpusPerCore:   p.topology.CPUsPerCore(),</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> cpuset, ok := s.GetCPUSet(<span class="type">string</span>(pod.UID), container.Name); ok {</span><br><span class="line">			p.updateCPUsToReuse(pod, container, cpuset)</span><br><span class="line">			klog.InfoS(<span class="string">"Static policy: container already present in state, skipping"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Call Topology Manager to get the aligned socket affinity across all hint providers.</span></span><br><span class="line">		hint := p.affinity.GetAffinity(<span class="type">string</span>(pod.UID), container.Name)</span><br><span class="line">		klog.InfoS(<span class="string">"Topology Affinity"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name, <span class="string">"affinity"</span>, hint)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Allocate CPUs according to the NUMA affinity contained in the hint.</span></span><br><span class="line">		cpuset, err := p.allocateCPUs(s, numCPUs, hint.NUMANodeAffinity, p.cpusToReuse[<span class="type">string</span>(pod.UID)])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			klog.ErrorS(err, <span class="string">"Unable to allocate CPUs"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name, <span class="string">"numCPUs"</span>, numCPUs)</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		}</span><br><span class="line">		s.SetCPUSet(<span class="type">string</span>(pod.UID), container.Name, cpuset)</span><br><span class="line">		p.updateCPUsToReuse(pod, container, cpuset)</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// container belongs in the shared pool (nothing to do; use default cpuset)</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// getAssignedCPUsOfSiblings returns assigned cpus of given container's siblings(all containers other than the given container) in the given pod `podUID`.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getAssignedCPUsOfSiblings</span><span class="params">(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>)</span></span> cpuset.CPUSet {</span><br><span class="line">	assignments := s.GetCPUAssignments()</span><br><span class="line">	cset := cpuset.NewCPUSet()</span><br><span class="line">	<span class="keyword">for</span> name, cpus := <span class="keyword">range</span> assignments[podUID] {</span><br><span class="line">		<span class="keyword">if</span> containerName == name {</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		}</span><br><span class="line">		cset = cset.Union(cpus)</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> cset</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span> {</span><br><span class="line">	klog.InfoS(<span class="string">"Static policy: RemoveContainer"</span>, <span class="string">"podUID"</span>, podUID, <span class="string">"containerName"</span>, containerName)</span><br><span class="line">	cpusInUse := getAssignedCPUsOfSiblings(s, podUID, containerName)</span><br><span class="line">	<span class="keyword">if</span> toRelease, ok := s.GetCPUSet(podUID, containerName); ok {</span><br><span class="line">		s.Delete(podUID, containerName)</span><br><span class="line">		<span class="comment">// Mutate the shared pool, adding released cpus.</span></span><br><span class="line">		toRelease = toRelease.Difference(cpusInUse)</span><br><span class="line">		s.SetDefaultCPUSet(s.GetDefaultCPUSet().Union(toRelease))</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> allocateCPUs(s state.State, numCPUs <span class="type">int</span>, numaAffinity bitmask.BitMask, reusableCPUs cpuset.CPUSet) (cpuset.CPUSet, <span class="type">error</span>) {</span><br><span class="line">	klog.InfoS(<span class="string">"AllocateCPUs"</span>, <span class="string">"numCPUs"</span>, numCPUs, <span class="string">"socket"</span>, numaAffinity)</span><br><span class="line"></span><br><span class="line">	allocatableCPUs := p.GetAllocatableCPUs(s).Union(reusableCPUs)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If there are aligned CPUs in numaAffinity, attempt to take those first.</span></span><br><span class="line">	result := cpuset.NewCPUSet()</span><br><span class="line">	<span class="keyword">if</span> numaAffinity != <span class="literal">nil</span> {</span><br><span class="line">		alignedCPUs := p.getAlignedCPUs(numaAffinity, allocatableCPUs)</span><br><span class="line"></span><br><span class="line">		numAlignedToAlloc := alignedCPUs.Size()</span><br><span class="line">		<span class="keyword">if</span> numCPUs &lt; numAlignedToAlloc {</span><br><span class="line">			numAlignedToAlloc = numCPUs</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		alignedCPUs, err := p.takeByTopology(alignedCPUs, numAlignedToAlloc)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> cpuset.NewCPUSet(), err</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		result = result.Union(alignedCPUs)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get any remaining CPUs from what's leftover after attempting to grab aligned ones.</span></span><br><span class="line">	remainingCPUs, err := p.takeByTopology(allocatableCPUs.Difference(result), numCPUs-result.Size())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="keyword">return</span> cpuset.NewCPUSet(), err</span><br><span class="line">	}</span><br><span class="line">	result = result.Union(remainingCPUs)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Remove allocated CPUs from the shared CPUSet.</span></span><br><span class="line">	s.SetDefaultCPUSet(s.GetDefaultCPUSet().Difference(result))</span><br><span class="line"></span><br><span class="line">	klog.InfoS(<span class="string">"AllocateCPUs"</span>, <span class="string">"result"</span>, result)</span><br><span class="line">	<span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> guaranteedCPUs(pod *v1.Pod, container *v1.Container) <span class="type">int</span> {</span><br><span class="line">	<span class="keyword">if</span> v1qos.GetPodQOS(pod) != v1.PodQOSGuaranteed {</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	}</span><br><span class="line">	cpuQuantity := container.Resources.Requests[v1.ResourceCPU]</span><br><span class="line">	<span class="keyword">if</span> cpuQuantity.Value()*<span class="number">1000</span> != cpuQuantity.MilliValue() {</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// Safe downcast to do for all systems with &lt; 2.1 billion CPUs.</span></span><br><span class="line">	<span class="comment">// Per the language spec, `int` is guaranteed to be at least 32 bits wide.</span></span><br><span class="line">	<span class="comment">// https://golang.org/ref/spec#Numeric_types</span></span><br><span class="line">	<span class="keyword">return</span> <span class="type">int</span>(cpuQuantity.Value())</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> podGuaranteedCPUs(pod *v1.Pod) <span class="type">int</span> {</span><br><span class="line">	<span class="comment">// The maximum of requested CPUs by init containers.</span></span><br><span class="line">	requestedByInitContainers := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.InitContainers {</span><br><span class="line">		<span class="keyword">if</span> _, ok := container.Resources.Requests[v1.ResourceCPU]; !ok {</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		}</span><br><span class="line">		requestedCPU := p.guaranteedCPUs(pod, &amp;container)</span><br><span class="line">		<span class="keyword">if</span> requestedCPU &gt; requestedByInitContainers {</span><br><span class="line">			requestedByInitContainers = requestedCPU</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// The sum of requested CPUs by app containers.</span></span><br><span class="line">	requestedByAppContainers := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers {</span><br><span class="line">		<span class="keyword">if</span> _, ok := container.Resources.Requests[v1.ResourceCPU]; !ok {</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		}</span><br><span class="line">		requestedByAppContainers += p.guaranteedCPUs(pod, &amp;container)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> requestedByInitContainers &gt; requestedByAppContainers {</span><br><span class="line">		<span class="keyword">return</span> requestedByInitContainers</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> requestedByAppContainers</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> takeByTopology(availableCPUs cpuset.CPUSet, numCPUs <span class="type">int</span>) (cpuset.CPUSet, <span class="type">error</span>) {</span><br><span class="line">	<span class="keyword">if</span> p.options.DistributeCPUsAcrossNUMA {</span><br><span class="line">		cpuGroupSize := <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> p.options.FullPhysicalCPUsOnly {</span><br><span class="line">			cpuGroupSize = p.topology.CPUsPerCore()</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> takeByTopologyNUMADistributed(p.topology, availableCPUs, numCPUs, cpuGroupSize)</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> takeByTopologyNUMAPacked(p.topology, availableCPUs, numCPUs)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint {</span><br><span class="line">	<span class="comment">// Get a count of how many guaranteed CPUs have been requested.</span></span><br><span class="line">	requested := p.guaranteedCPUs(pod, container)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Number of required CPUs is not an integer or a container is not part of the Guaranteed QoS class.</span></span><br><span class="line">	<span class="comment">// It will be treated by the TopologyManager as having no preference and cause it to ignore this</span></span><br><span class="line">	<span class="comment">// resource when considering pod alignment.</span></span><br><span class="line">	<span class="comment">// In terms of hints, this is equal to: TopologyHints[NUMANodeAffinity: nil, Preferred: true].</span></span><br><span class="line">	<span class="keyword">if</span> requested == <span class="number">0</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Short circuit to regenerate the same hints if there are already</span></span><br><span class="line">	<span class="comment">// guaranteed CPUs allocated to the Container. This might happen after a</span></span><br><span class="line">	<span class="comment">// kubelet restart, for example.</span></span><br><span class="line">	<span class="keyword">if</span> allocated, exists := s.GetCPUSet(<span class="type">string</span>(pod.UID), container.Name); exists {</span><br><span class="line">		<span class="keyword">if</span> allocated.Size() != requested {</span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">"CPUs already allocated to container with different number than request"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name, <span class="string">"requestedSize"</span>, requested, <span class="string">"allocatedSize"</span>, allocated.Size())</span><br><span class="line">			<span class="comment">// An empty list of hints will be treated as a preference that cannot be satisfied.</span></span><br><span class="line">			<span class="comment">// In definition of hints this is equal to: TopologyHint[NUMANodeAffinity: nil, Preferred: false].</span></span><br><span class="line">			<span class="comment">// For all but the best-effort policy, the Topology Manager will throw a pod-admission error.</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint{</span><br><span class="line">				<span class="type">string</span>(v1.ResourceCPU): {},</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		klog.InfoS(<span class="string">"Regenerating TopologyHints for CPUs already allocated"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name)</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint{</span><br><span class="line">			<span class="type">string</span>(v1.ResourceCPU): p.generateCPUTopologyHints(allocated, cpuset.CPUSet{}, requested),</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get a list of available CPUs.</span></span><br><span class="line">	available := p.GetAllocatableCPUs(s)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get a list of reusable CPUs (e.g. CPUs reused from initContainers).</span></span><br><span class="line">	<span class="comment">// It should be an empty CPUSet for a newly created pod.</span></span><br><span class="line">	reusable := p.cpusToReuse[<span class="type">string</span>(pod.UID)]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Generate hints.</span></span><br><span class="line">	cpuHints := p.generateCPUTopologyHints(available, reusable, requested)</span><br><span class="line">	klog.InfoS(<span class="string">"TopologyHints generated"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name, <span class="string">"cpuHints"</span>, cpuHints)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint{</span><br><span class="line">		<span class="type">string</span>(v1.ResourceCPU): cpuHints,</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint {</span><br><span class="line">	<span class="comment">// Get a count of how many guaranteed CPUs have been requested by Pod.</span></span><br><span class="line">	requested := p.podGuaranteedCPUs(pod)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Number of required CPUs is not an integer or a pod is not part of the Guaranteed QoS class.</span></span><br><span class="line">	<span class="comment">// It will be treated by the TopologyManager as having no preference and cause it to ignore this</span></span><br><span class="line">	<span class="comment">// resource when considering pod alignment.</span></span><br><span class="line">	<span class="comment">// In terms of hints, this is equal to: TopologyHints[NUMANodeAffinity: nil, Preferred: true].</span></span><br><span class="line">	<span class="keyword">if</span> requested == <span class="number">0</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	assignedCPUs := cpuset.NewCPUSet()</span><br><span class="line">	<span class="keyword">for</span> _, container := <span class="keyword">range</span> <span class="built_in">append</span>(pod.Spec.InitContainers, pod.Spec.Containers...) {</span><br><span class="line">		requestedByContainer := p.guaranteedCPUs(pod, &amp;container)</span><br><span class="line">		<span class="comment">// Short circuit to regenerate the same hints if there are already</span></span><br><span class="line">		<span class="comment">// guaranteed CPUs allocated to the Container. This might happen after a</span></span><br><span class="line">		<span class="comment">// kubelet restart, for example.</span></span><br><span class="line">		<span class="keyword">if</span> allocated, exists := s.GetCPUSet(<span class="type">string</span>(pod.UID), container.Name); exists {</span><br><span class="line">			<span class="keyword">if</span> allocated.Size() != requestedByContainer {</span><br><span class="line">				klog.ErrorS(<span class="literal">nil</span>, <span class="string">"CPUs already allocated to container with different number than request"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"containerName"</span>, container.Name, <span class="string">"allocatedSize"</span>, requested, <span class="string">"requestedByContainer"</span>, requestedByContainer, <span class="string">"allocatedSize"</span>, allocated.Size())</span><br><span class="line">				<span class="comment">// An empty list of hints will be treated as a preference that cannot be satisfied.</span></span><br><span class="line">				<span class="comment">// In definition of hints this is equal to: TopologyHint[NUMANodeAffinity: nil, Preferred: false].</span></span><br><span class="line">				<span class="comment">// For all but the best-effort policy, the Topology Manager will throw a pod-admission error.</span></span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint{</span><br><span class="line">					<span class="type">string</span>(v1.ResourceCPU): {},</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// A set of CPUs already assigned to containers in this pod</span></span><br><span class="line">			assignedCPUs = assignedCPUs.Union(allocated)</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> assignedCPUs.Size() == requested {</span><br><span class="line">		klog.InfoS(<span class="string">"Regenerating TopologyHints for CPUs already allocated"</span>, <span class="string">"pod"</span>, klog.KObj(pod))</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint{</span><br><span class="line">			<span class="type">string</span>(v1.ResourceCPU): p.generateCPUTopologyHints(assignedCPUs, cpuset.CPUSet{}, requested),</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get a list of available CPUs.</span></span><br><span class="line">	available := p.GetAllocatableCPUs(s)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get a list of reusable CPUs (e.g. CPUs reused from initContainers).</span></span><br><span class="line">	<span class="comment">// It should be an empty CPUSet for a newly created pod.</span></span><br><span class="line">	reusable := p.cpusToReuse[<span class="type">string</span>(pod.UID)]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Ensure any CPUs already assigned to containers in this pod are included as part of the hint generation.</span></span><br><span class="line">	reusable = reusable.Union(assignedCPUs)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Generate hints.</span></span><br><span class="line">	cpuHints := p.generateCPUTopologyHints(available, reusable, requested)</span><br><span class="line">	klog.InfoS(<span class="string">"TopologyHints generated"</span>, <span class="string">"pod"</span>, klog.KObj(pod), <span class="string">"cpuHints"</span>, cpuHints)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint{</span><br><span class="line">		<span class="type">string</span>(v1.ResourceCPU): cpuHints,</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// generateCPUtopologyHints generates a set of TopologyHints given the set of</span></span><br><span class="line"><span class="comment">// available CPUs and the number of CPUs being requested.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// It follows the convention of marking all hints that have the same number of</span></span><br><span class="line"><span class="comment">// bits set as the narrowest matching NUMANodeAffinity with 'Preferred: true', and</span></span><br><span class="line"><span class="comment">// marking all others with 'Preferred: false'.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> generateCPUTopologyHints(availableCPUs cpuset.CPUSet, reusableCPUs cpuset.CPUSet, request <span class="type">int</span>) []topologymanager.TopologyHint {</span><br><span class="line">	<span class="comment">// Initialize minAffinitySize to include all NUMA Nodes.</span></span><br><span class="line">	minAffinitySize := p.topology.CPUDetails.NUMANodes().Size()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Iterate through all combinations of numa nodes bitmask and build hints from them.</span></span><br><span class="line">	hints := []topologymanager.TopologyHint{}</span><br><span class="line">	bitmask.IterateBitMasks(p.topology.CPUDetails.NUMANodes().ToSlice(), <span class="function"><span class="keyword">func</span><span class="params">(mask bitmask.BitMask)</span></span> {</span><br><span class="line">		<span class="comment">// First, update minAffinitySize for the current request size.</span></span><br><span class="line">		cpusInMask := p.topology.CPUDetails.CPUsInNUMANodes(mask.GetBits()...).Size()</span><br><span class="line">		<span class="keyword">if</span> cpusInMask &gt;= request &amp;&amp; mask.Count() &lt; minAffinitySize {</span><br><span class="line">			minAffinitySize = mask.Count()</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Then check to see if we have enough CPUs available on the current</span></span><br><span class="line">		<span class="comment">// numa node bitmask to satisfy the CPU request.</span></span><br><span class="line">		numMatching := <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> _, c := <span class="keyword">range</span> reusableCPUs.ToSlice() {</span><br><span class="line">			<span class="comment">// Disregard this mask if its NUMANode isn't part of it.</span></span><br><span class="line">			<span class="keyword">if</span> !mask.IsSet(p.topology.CPUDetails[c].NUMANodeID) {</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			}</span><br><span class="line">			numMatching++</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Finally, check to see if enough available CPUs remain on the current</span></span><br><span class="line">		<span class="comment">// NUMA node combination to satisfy the CPU request.</span></span><br><span class="line">		<span class="keyword">for</span> _, c := <span class="keyword">range</span> availableCPUs.ToSlice() {</span><br><span class="line">			<span class="keyword">if</span> mask.IsSet(p.topology.CPUDetails[c].NUMANodeID) {</span><br><span class="line">				numMatching++</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If they don't, then move onto the next combination.</span></span><br><span class="line">		<span class="keyword">if</span> numMatching &lt; request {</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Otherwise, create a new hint from the numa node bitmask and add it to the</span></span><br><span class="line">		<span class="comment">// list of hints.  We set all hint preferences to 'false' on the first</span></span><br><span class="line">		<span class="comment">// pass through.</span></span><br><span class="line">		hints = <span class="built_in">append</span>(hints, topologymanager.TopologyHint{</span><br><span class="line">			NUMANodeAffinity: mask,</span><br><span class="line">			Preferred:        <span class="literal">false</span>,</span><br><span class="line">		})</span><br><span class="line">	})</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Loop back through all hints and update the 'Preferred' field based on</span></span><br><span class="line">	<span class="comment">// counting the number of bits sets in the affinity mask and comparing it</span></span><br><span class="line">	<span class="comment">// to the minAffinitySize. Only those with an equal number of bits set (and</span></span><br><span class="line">	<span class="comment">// with a minimal set of numa nodes) will be considered preferred.</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> hints {</span><br><span class="line">		<span class="keyword">if</span> p.options.AlignBySocket &amp;&amp; p.isHintSocketAligned(hints[i], minAffinitySize) {</span><br><span class="line">			hints[i].Preferred = <span class="literal">true</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> hints[i].NUMANodeAffinity.Count() == minAffinitySize {</span><br><span class="line">			hints[i].Preferred = <span class="literal">true</span></span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> hints</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// isHintSocketAligned function return true if numa nodes in hint are socket aligned.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> isHintSocketAligned(hint topologymanager.TopologyHint, minAffinitySize <span class="type">int</span>) <span class="type">bool</span> {</span><br><span class="line">	numaNodesBitMask := hint.NUMANodeAffinity.GetBits()</span><br><span class="line">	numaNodesPerSocket := p.topology.NumNUMANodes / p.topology.NumSockets</span><br><span class="line">	<span class="keyword">if</span> numaNodesPerSocket == <span class="number">0</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// minSockets refers to minimum number of socket required to satify allocation.</span></span><br><span class="line">	<span class="comment">// A hint is considered socket aligned if sockets across which numa nodes span is equal to minSockets</span></span><br><span class="line">	minSockets := (minAffinitySize + numaNodesPerSocket - <span class="number">1</span>) / numaNodesPerSocket</span><br><span class="line">	<span class="keyword">return</span> p.topology.CPUDetails.SocketsInNUMANodes(numaNodesBitMask...).Size() == minSockets</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// getAlignedCPUs return set of aligned CPUs based on numa affinity mask and configured policy options.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *staticPolicy)</span></span> getAlignedCPUs(numaAffinity bitmask.BitMask, allocatableCPUs cpuset.CPUSet) cpuset.CPUSet {</span><br><span class="line">	alignedCPUs := cpuset.NewCPUSet()</span><br><span class="line">	numaBits := numaAffinity.GetBits()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If align-by-socket policy option is enabled, NUMA based hint is expanded to</span></span><br><span class="line">	<span class="comment">// socket aligned hint. It will ensure that first socket aligned available CPUs are</span></span><br><span class="line">	<span class="comment">// allocated before we try to find CPUs across socket to satisfy allocation request.</span></span><br><span class="line">	<span class="keyword">if</span> p.options.AlignBySocket {</span><br><span class="line">		socketBits := p.topology.CPUDetails.SocketsInNUMANodes(numaBits...).ToSliceNoSort()</span><br><span class="line">		<span class="keyword">for</span> _, socketID := <span class="keyword">range</span> socketBits {</span><br><span class="line">			alignedCPUs = alignedCPUs.Union(allocatableCPUs.Intersection(p.topology.CPUDetails.CPUsInSockets(socketID)))</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> alignedCPUs</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, numaNodeID := <span class="keyword">range</span> numaBits {</span><br><span class="line">		alignedCPUs = alignedCPUs.Union(allocatableCPUs.Intersection(p.topology.CPUDetails.CPUsInNUMANodes(numaNodeID)))</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> alignedCPUs</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<p>pkg/kubelet/cm/cpumanager/policy_static.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ContainerCPUAssignments type used in cpu manager state</span></span><br><span class="line"><span class="keyword">type</span> ContainerCPUAssignments <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clone returns a copy of ContainerCPUAssignments</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(as ContainerCPUAssignments)</span></span> Clone() ContainerCPUAssignments {</span><br><span class="line">	ret := <span class="built_in">make</span>(ContainerCPUAssignments)</span><br><span class="line">	<span class="keyword">for</span> pod := <span class="keyword">range</span> as {</span><br><span class="line">		ret[pod] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet)</span><br><span class="line">		<span class="keyword">for</span> container, cset := <span class="keyword">range</span> as[pod] {</span><br><span class="line">			ret[pod][container] = cset</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> ret</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reader interface used to read current cpu/pod assignment state</span></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> {</span><br><span class="line">	GetCPUSet(podUID <span class="type">string</span>, containerName <span class="type">string</span>) (cpuset.CPUSet, <span class="type">bool</span>)</span><br><span class="line">	GetDefaultCPUSet() cpuset.CPUSet</span><br><span class="line">	GetCPUSetOrDefault(podUID <span class="type">string</span>, containerName <span class="type">string</span>) cpuset.CPUSet</span><br><span class="line">	GetCPUAssignments() ContainerCPUAssignments</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> writer <span class="keyword">interface</span> {</span><br><span class="line">	SetCPUSet(podUID <span class="type">string</span>, containerName <span class="type">string</span>, cpuset cpuset.CPUSet)</span><br><span class="line">	SetDefaultCPUSet(cpuset cpuset.CPUSet)</span><br><span class="line">	SetCPUAssignments(ContainerCPUAssignments)</span><br><span class="line">	Delete(podUID <span class="type">string</span>, containerName <span class="type">string</span>)</span><br><span class="line">	ClearState()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// State interface provides methods for tracking and setting cpu/pod assignment</span></span><br><span class="line"><span class="keyword">type</span> State <span class="keyword">interface</span> {</span><br><span class="line">	Reader</span><br><span class="line">	writer</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>以上是static-policy的策略的具体实现，分析一下其中主要的具体方法：</p>
<ul>
<li><p>**validateState(s state.State) **方法:  </p>
<p>state数据结构可以理解为cpu-policy的缓存，缓存了具体的cpu绑定的情况和现存的剩余cpu情况，state接口分别包含了<strong>Reader</strong>和<strong>Writer</strong>两个接口，需要实现<strong>GetCPUSet</strong>和<strong>SetCPUSet</strong>等方法。</p>
<p>首先会通过缓存方法<strong>s.GetCPUAssignments</strong>获取当前cpu的分配情况，通过<strong>s.GetDefaultCPUSet</strong>获取当前default的cpuset（pod在去除reserved的情况下，再去除单独绑核的cpu后剩余的cpu集合）</p>
<p>当tmpDefaultCPUset为空时，即首次初始化时，会通过**topology.CPUDetails.CPUs()**方法获取节点所有的CPU，并且存入缓存设置为DefaultCPUSet</p>
<p>当tmpDefaultCPUset缓存不为空时，会校验两种情况，</p>
<p>1.校验reserved的cpuset不在default中</p>
<p>2.校验已分配的cpu不在剩余的defaultcpu池中</p>
<p>3.校验实际可用的CPUs和缓存对比是否发生变化（比如说下线了一个cpu，同时kubelet没有在正常工作），获取到缓存中的DefaultCPUs和计算出已分配的cpu合计，使用<strong>unionall</strong>方法和新使用**topology.CPUDetails.CPUs()**获取的cpu进行对比，是否相同</p>
</li>
<li><p>**GetAllocatableCPUs (s state.State)**方法:</p>
<p>从缓存中获取default-cpus除去reserved-cpus以外的cpus，设置为可分配cpu</p>
</li>
<li><p>**Allocate(s state.State, pod *v1.Pod, container *v1.Container)**方法：</p>
<p>核心方法用于分配CPU,首先会分为两种情况判断pod的类型：</p>
<p>1.首先使用p.guaranteedCPUs判断是否是Guaranteed类型的pod，并且获取所需要的cpu核数，（需要是整数）当pod是Guaranteed类型时，表明pod有独占CPU核的需求。然后从缓存中获取信息，查看该pod是否已经创建，并分配了cpu，如果存在，仅需要<strong>p.updateCPUToReuse()<strong>进行更新。如果是新创建的pod，需要绑核操作，使用</strong>p.affinity.GetAffinity()<strong>方法获取亲和性拓扑关系，然后根据numa亲和性进行分配使用</strong>p.allocateCPUs()<strong>方法，最后使用</strong>setCPUSet</strong>更新缓存，最后调用**p.updateCPUToReuse()**更新实际的cpu</p>
<p>2.如果不是Guaranteed类型的pod，则会不作处理，直接使用default cpuset</p>
</li>
<li><p>**allocateCPUs(s state.State, numCPUs int, numaAffinity bitmask.BitMask, reusableCPUs cpuset.CPUSet)**方法：</p>
<p>首先调用**p.GetAllocatableCPUs(s).Union(reusableCPUs)**获取可供分配的cpu，如果根据numaAffinity有匹配一致的cpu，优先使用这些cpu。分为两种情况：</p>
<p>1.当存在numaAffinity时，根据具体的cpuID和numaNode的对应关系得出具体的cpu</p>
<p>2.当不存在numaAffinity时，直接根据<strong>takeByTopology</strong>方法获取剩余的cpus</p>
<p>之后将亲和性策略计算出的结果，与默认的defaultcpuset区分开，并且返回亲和性结果的cpuset</p>
</li>
<li><p>**GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container)**方法：</p>
<p>首先确定pod属于Guaranteed Pod的类型，获取所需cpu核数<strong>request</strong>，然后从缓存中对比，该pod是否已分配cpu，如果已分配的cpu和计算出所需核数<strong>request</strong>不同，则返回拓扑亲和性结果为空，如果核数和分配数相同，则调用<strong>p.generateCPUTopologyHints</strong>方法计算亲和性。如果该pod是初次分配cpu，不存在缓存的情况，则通过扣除缓存<strong>p.GetAllocatableCPUs(s)<strong>计算出可用的cpu <strong>available</strong>，再通过</strong>p.generateCPUTopologyHints</strong>计算出亲和性</p>
</li>
<li><p>**GetPodTopologyHints(s state.State, pod *v1.Pod)**方法：</p>
<p>同样首先会确认pod是否属于Guaranteed类型，然后遍历pod中所有的容器，包括initContainer,通过方法<strong>assignedCPUs.Union(allocated)<strong>计算出所有已分配的container所需的cpu核数：</strong>assignedCPUs</strong> 。同<strong>GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container)<strong>方法一样，获取所需cpu核数</strong>request**，然后从缓存中对比，该pod是否已分配cpu，如果已分配的cpu和计算出所需核数</strong>request<strong>不同，则返回拓扑亲和性结果为空，如果核数和分配数相同，则调用</strong>p.generateCPUTopologyHints**方法计算亲和性。</p>
</li>
</ul>
<p>pkg/kubelet/kubelet.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> initializeRuntimeDependentModules() {</span><br><span class="line">	<span class="keyword">if</span> err := kl.cadvisor.Start(); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="comment">// Fail kubelet and rely on the babysitter to retry starting kubelet.</span></span><br><span class="line">		klog.ErrorS(err, <span class="string">"Failed to start cAdvisor"</span>)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">  .........</span><br><span class="line">	<span class="comment">// containerManager must start after cAdvisor because it needs filesystem capacity information</span></span><br><span class="line">	<span class="keyword">if</span> err := kl.containerManager.Start(node, kl.GetActivePods, kl.sourcesReady, kl.statusManager, kl.runtimeService); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="comment">// Fail kubelet and rely on the babysitter to retry starting kubelet.</span></span><br><span class="line">		klog.ErrorS(err, <span class="string">"Failed to start ContainerManager"</span>)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	.........</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>pkg/kubelet/cm/container_manager_linux.go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cm *containerManagerImpl)</span></span> Start(node *v1.Node,</span><br><span class="line">	runtimeService internalapi.RuntimeService) <span class="type">error</span> {</span><br><span class="line">······</span><br><span class="line">	<span class="comment">// Initialize CPU manager</span></span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(kubefeatures.CPUManager) {</span><br><span class="line">		containerMap, err := buildContainerMapFromRuntime(runtimeService)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to build map of initial containers from runtime: %v"</span>, err)</span><br><span class="line">		}</span><br><span class="line">		err = cm.cpuManager.Start(cpumanager.ActivePodsFunc(activePods), sourcesReady, podStatusProvider, runtimeService, containerMap)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"start cpu manager error: %v"</span>, err)</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">·········</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>具体调用逻辑：在Kubelet方法<strong>initializeRuntimeDependentModule</strong>s中调用ContainerManager的<strong>Start</strong>方法，具体实现是container_manager_linux.go的<strong>Start</strong>方法:与cpu相关的就是<strong>cm.cpuManager.Start</strong></p>
<h3 id="相关功能改进"><a href="#相关功能改进" class="headerlink" title="相关功能改进"></a>相关功能改进</h3><p>有上述源码分析可以看出，Kubelet原生的cpumanager将节点的cpu资源做了以下的划分，在启用static模式和reservedCpus的情况下，kubelet会将cpu全部放入DefaultCpuSet，以下图为例：该节点的总CPU核数为8个，默认为0-7.其中reserved预留了0-5核，因此Guaranteed类型的Pod的只能绑核在6，7两个核上</p>
<p>defaultCPUSet= reservedCPU+guaranteedCPU</p>
<p><img src="/image/KubeletCPU/defaultCPU.png" alt="header"></p>
<p>在此种情况下，非Guarantee类型的Pod不受约束仍会调度到0-5核上，并没有起到绝对隔离的作用。因此EKI修改了了cpu管理的策略，变成了以下模型</p>
<p><img src="/image/KubeletCPU/defaultNonCPU.png" alt="header"></p>
<p><img src="/image/KubeletCPU/cpustate.png" alt="header"></p>
<p><img src="/image/KubeletCPU/kubeletConfig.png" alt="header"></p>
<p>该功能添加了kubelet的新启动参数—defaultNonGuaranteeSystemCPUs，用于表示非Guaranteed类型的POD进行范围绑核调度，与系统reserved的资源进行强隔离，保证了隔离资源不会被容器进程占用，公式修改为: defaultCPUSet= reservedCPU+guarantendCPU+nonGuaranteedCPU</p>
<h3 id="缺陷和改进"><a href="#缺陷和改进" class="headerlink" title="缺陷和改进"></a>缺陷和改进</h3><h4 id="缺陷部分"><a href="#缺陷部分" class="headerlink" title="缺陷部分"></a>缺陷部分</h4><p>1.该参数仅能适用于范围绑核的情况，并不能对容器的cpu进行指定绑核，例如并不能指定容器绑核绑定在cpu3上。</p>
<ol start="2">
<li>开启该参数后，应合理规划default池的大小，因为所有的非Guaranteed类型的pod都会分配在该cpuset中，要根据集群规模，pod数量进行合理分配，否则pod会抢占cpu，根据cfs调度规则，分配到各个pod（即各个进程的cpu使用时间会发生冲突，导致进程不可用）</li>
</ol>
<p>3.开启该参数后，再关闭该参数，需要手动释放kubelet-cpu相关缓存，否则会造成cpu-overlap，导致kubelet不可用，具体删/var/lib/kubelet/cpu_manager_state。（默认部署Kubernetes的情况）</p>
<p>4.启用该特性后，现有pod需要重启，才能重新分配cpu，才可以生效。（线上生产环境业务会中断，谨慎操作）</p>
<p>5.对Kubernetes源生代码进行了修改，并没有以插件化的形式注入，不利用后续Kubernetes版本的升级和维护</p>
<h4 id="后续可改进部分"><a href="#后续可改进部分" class="headerlink" title="后续可改进部分"></a>后续可改进部分</h4><p>1.可以扩展CPUManger，防止同一个物理核的虚拟分配带来干扰，比如说一个容器申请了5个独占虚拟核，cpu0-4都分配了，那么cpu5应该也要被锁定，不能分配给其他工作负载使用。</p>
<p><img src="/image/KubeletCPU/cpubingding.png" alt="header"></p>
<p>2.避免修改Kubernetes源码，已无侵入，插件化的方式进行cpu的调度，参考kube-scheduler的调度流程，用extender-scheduler实现cpu绑核的功能和cpu池化功能</p>
<p>3.或者可以将cpu绑定的插件下放至runtime，以插件化的形式绑定在CRI中</p>
<p>​		</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://jing21.github.io">Jing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://jing21.github.io/posts/2592.html">https://jing21.github.io/posts/2592.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="/image/volcano%20park.JPG" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/19508.html" title="GOLANG GMP 原理与调度"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">GOLANG GMP 原理与调度</div></div></a></div><div class="next-post pull-right"><a href="/posts/65526.html" title="NVIDIA共享GPU方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">NVIDIA共享GPU方案</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/posts/65526.html" title="NVIDIA共享GPU方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-13</div><div class="title">NVIDIA共享GPU方案</div></div></a></div><div><a href="/posts/38758.html" title="Kuberentes kube-apiserver限流方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-07</div><div class="title">Kuberentes kube-apiserver限流方案</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/image/volcano%20park.JPG" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">Jing</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/JING21"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/JING21" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:jameszjing21@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/image/WechatIMG894.jpg" target="_blank" title="weixin"><i class="fab fa-weixin" style="color: #38761D;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This blog shows some experience on daily work and study</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubelet-cpu%E7%BB%91%E6%A0%B8%E5%8A%9F%E8%83%BD"><span class="toc-number">1.</span> <span class="toc-text">Kubelet cpu绑核功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.</span> <span class="toc-text">Kubernetes相关参数功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">pod类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubelet%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">kubelet相关参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubelet%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.3.</span> <span class="toc-text">Kubelet相关代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%94%B9%E8%BF%9B"><span class="toc-number">1.2.4.</span> <span class="toc-text">相关功能改进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%BA%E9%99%B7%E5%92%8C%E6%94%B9%E8%BF%9B"><span class="toc-number">1.2.5.</span> <span class="toc-text">缺陷和改进</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E9%99%B7%E9%83%A8%E5%88%86"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">缺陷部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD%E5%8F%AF%E6%94%B9%E8%BF%9B%E9%83%A8%E5%88%86"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">后续可改进部分</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/38758.html" title="Kuberentes kube-apiserver限流方案">Kuberentes kube-apiserver限流方案</a><time datetime="2025-11-07T07:57:34.000Z" title="Created 2025-11-07 15:57:34">2025-11-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/19508.html" title="GOLANG GMP 原理与调度">GOLANG GMP 原理与调度</a><time datetime="2025-07-08T08:10:26.000Z" title="Created 2025-07-08 16:10:26">2025-07-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/2592.html" title="Kubelet CPU管理">Kubelet CPU管理</a><time datetime="2024-06-14T02:32:09.000Z" title="Created 2024-06-14 10:32:09">2024-06-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/65526.html" title="NVIDIA共享GPU方案">NVIDIA共享GPU方案</a><time datetime="2024-06-13T08:18:35.000Z" title="Created 2024-06-13 16:18:35">2024-06-13</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2020 - 2025 By Jing</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>